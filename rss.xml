<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>千反田</title>
  
  <subtitle>Kanna</subtitle>
  <link href="http://blog.sukiu.top/rss.xml" rel="self"/>
  
  <link href="http://blog.sukiu.top/"/>
  <updated>2022-10-16T10:18:00.000Z</updated>
  <id>http://blog.sukiu.top/</id>
  
  <author>
    <name>SukiEva</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Lombok</title>
    <link href="http://blog.sukiu.top/Programming-Language/Java/Lombok/"/>
    <id>http://blog.sukiu.top/Programming-Language/Java/Lombok/</id>
    <published>2022-10-16T08:49:00.000Z</published>
    <updated>2022-10-16T10:18:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>lombok 通过注解消除实际开发中的样板式代码：getter、setter 方法，重写 toString、equals 方法等。</p><span id="more"></span><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="NonNull"><a href="#NonNull" class="headerlink" title="@NonNull"></a>@NonNull</h3><p><a href="https://projectlombok.org/features/NonNull">@NonNull</a></p><p>@NonNull 注解可以放在方法，参数或字段上。</p><p>该注解不是断言非空，而是<strong>在赋值该字段时对参数进行判空检查</strong>，如果已经有了 <code>if (xxx == null)</code> 则不会有其他操作。</p><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.NonNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NonNullExample</span> <span class="keyword">extends</span> <span class="title class_">Something</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">NonNullExample</span><span class="params">(<span class="meta">@NonNull</span> Person person)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.name = person.getName();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.NonNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NonNullExample</span> <span class="keyword">extends</span> <span class="title class_">Something</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">NonNullExample</span><span class="params">(<span class="meta">@NonNull</span> Person person)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (person == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;person is marked non-null but is null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.name = person.getName();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Cleanup"><a href="#Cleanup" class="headerlink" title="@Cleanup"></a>@Cleanup</h3><p><a href="https://projectlombok.org/features/Cleanup">@Cleanup</a></p><p>自动调用 <code>close()</code> 方法，如果还需要做异常处理，明显不如 <code>try-with</code> 方便。</p><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Cleanup;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CleanupExample</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="meta">@Cleanup</span> <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(args[<span class="number">0</span>]);</span><br><span class="line">    <span class="meta">@Cleanup</span> <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(args[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10000</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> in.read(b);</span><br><span class="line">      <span class="keyword">if</span> (r == -<span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">      out.write(b, <span class="number">0</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CleanupExample</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(args[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(args[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10000</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">          <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> in.read(b);</span><br><span class="line">          <span class="keyword">if</span> (r == -<span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">          out.write(b, <span class="number">0</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="literal">null</span>) &#123;</span><br><span class="line">          out.close();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">        in.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Getter-x2F-Setter"><a href="#Getter-x2F-Setter" class="headerlink" title="@Getter&#x2F;@Setter"></a>@Getter&#x2F;@Setter</h3><p><a href="https://projectlombok.org/features/GetterSetter">@Getter and @Setter</a></p><p>自动生成属性的 get&#x2F;set 方法，默认都是 public，可通过 AccessLevel 设置可见性。</p><ul><li>作用类上，生成所有非静态成员变量的 getter&#x2F;setter 方法</li><li>作用于成员变量上，生成该成员变量的 getter&#x2F;setter 方法</li><li>Getter(lazy&#x3D;true) 懒加载</li></ul><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.AccessLevel;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetterSetterExample</span> &#123;</span><br><span class="line">  <span class="meta">@Getter</span> <span class="meta">@Setter</span> <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Setter(AccessLevel.PROTECTED)</span> <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> </span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">&quot;%s (age: %d)&quot;</span>, name, age);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetterSetterExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> </span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">&quot;%s (age: %d)&quot;</span>, name, age);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> age;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ToString"><a href="#ToString" class="headerlink" title="@ToString"></a>@ToString</h3><p><a href="https://projectlombok.org/features/ToString">@ToString</a></p><p>作用于类，覆盖默认的 toString() 方法。</p><ul><li>通过 includeFieldNames 属性限定显示某些字段</li><li>通过 exclude 属性排除某些字段</li><li>callSuper 是否输出超类</li></ul><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToStringExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STATIC_VAR</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Shape</span> <span class="variable">shape</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Square</span>(<span class="number">5</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">private</span> String[] tags;</span><br><span class="line">  <span class="meta">@ToString</span>.Exclude <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@ToString(callSuper=true, includeFieldNames=true)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Square</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> width, height;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Square</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.width = width;</span><br><span class="line">      <span class="built_in">this</span>.height = height;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToStringExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STATIC_VAR</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Shape</span> <span class="variable">shape</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Square</span>(<span class="number">5</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">private</span> String[] tags;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Square</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> width, height;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Square</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.width = width;</span><br><span class="line">      <span class="built_in">this</span>.height = height;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Square(super=&quot;</span> + <span class="built_in">super</span>.toString() + <span class="string">&quot;, width=&quot;</span> + <span class="built_in">this</span>.width + <span class="string">&quot;, height=&quot;</span> + <span class="built_in">this</span>.height + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ToStringExample(&quot;</span> + <span class="built_in">this</span>.getName() + <span class="string">&quot;, &quot;</span> + <span class="built_in">this</span>.shape + <span class="string">&quot;, &quot;</span> + Arrays.deepToString(<span class="built_in">this</span>.tags) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EqualsAndHashCode"><a href="#EqualsAndHashCode" class="headerlink" title="@EqualsAndHashCode"></a>@EqualsAndHashCode</h3><p><a href="https://projectlombok.org/features/EqualsAndHashCode">@EqualsAndHashCode</a></p><p>作用于类，覆盖默认的 equals 和 hashCode。</p><ul><li><code>doNotUseGetters</code> &#x3D; [<code>true</code> | <code>false</code>] (default: false)</li><li><code>callSuper</code> &#x3D; [<code>call</code> | <code>skip</code> | <code>warn</code>] (default: warn)</li><li><code>flagUsage</code> &#x3D; [<code>warning</code> | <code>error</code>] (default: not set)</li></ul><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EqualsAndHashCodeExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">int</span> <span class="variable">transientVar</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">double</span> score;</span><br><span class="line">  <span class="meta">@EqualsAndHashCode</span>.Exclude <span class="keyword">private</span> <span class="type">Shape</span> <span class="variable">shape</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Square</span>(<span class="number">5</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">private</span> String[] tags;</span><br><span class="line">  <span class="meta">@EqualsAndHashCode</span>.Exclude <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@EqualsAndHashCode(callSuper=true)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Square</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> width, height;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Square</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.width = width;</span><br><span class="line">      <span class="built_in">this</span>.height = height;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EqualsAndHashCodeExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">int</span> <span class="variable">transientVar</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">double</span> score;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">Shape</span> <span class="variable">shape</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Square</span>(<span class="number">5</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">private</span> String[] tags;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> </span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="built_in">this</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> EqualsAndHashCodeExample)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">EqualsAndHashCodeExample</span> <span class="variable">other</span> <span class="operator">=</span> (EqualsAndHashCodeExample) o;</span><br><span class="line">    <span class="keyword">if</span> (!other.canEqual((Object)<span class="built_in">this</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.getName() == <span class="literal">null</span> ? other.getName() != <span class="literal">null</span> : !<span class="built_in">this</span>.getName().equals(other.getName())) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (Double.compare(<span class="built_in">this</span>.score, other.score) != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!Arrays.deepEquals(<span class="built_in">this</span>.tags, other.tags)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> </span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">59</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">temp1</span> <span class="operator">=</span> Double.doubleToLongBits(<span class="built_in">this</span>.score);</span><br><span class="line">    result = (result*PRIME) + (<span class="built_in">this</span>.name == <span class="literal">null</span> ? <span class="number">43</span> : <span class="built_in">this</span>.name.hashCode());</span><br><span class="line">    result = (result*PRIME) + (<span class="type">int</span>)(temp1 ^ (temp1 &gt;&gt;&gt; <span class="number">32</span>));</span><br><span class="line">    result = (result*PRIME) + Arrays.deepHashCode(<span class="built_in">this</span>.tags);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">canEqual</span><span class="params">(Object other)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> other <span class="keyword">instanceof</span> EqualsAndHashCodeExample;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Square</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> width, height;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Square</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.width = width;</span><br><span class="line">      <span class="built_in">this</span>.height = height;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (o == <span class="built_in">this</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Square)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="type">Square</span> <span class="variable">other</span> <span class="operator">=</span> (Square) o;</span><br><span class="line">      <span class="keyword">if</span> (!other.canEqual((Object)<span class="built_in">this</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">super</span>.equals(o)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.width != other.width) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.height != other.height) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">59</span>;</span><br><span class="line">      <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">      result = (result*PRIME) + <span class="built_in">super</span>.hashCode();</span><br><span class="line">      result = (result*PRIME) + <span class="built_in">this</span>.width;</span><br><span class="line">      result = (result*PRIME) + <span class="built_in">this</span>.height;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">canEqual</span><span class="params">(Object other)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> other <span class="keyword">instanceof</span> Square;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NoArgsConstructor-RequiredArgsConstructor-And-AllArgsConstructor"><a href="#NoArgsConstructor-RequiredArgsConstructor-And-AllArgsConstructor" class="headerlink" title="@NoArgsConstructor, @RequiredArgsConstructor And @AllArgsConstructor"></a>@NoArgsConstructor, @RequiredArgsConstructor And @AllArgsConstructor</h3><p><a href="https://projectlombok.org/features/constructor">@NoArgsConstructor, @RequiredArgsConstructor, @AllArgsConstructor</a></p><p>生成各种构造函数，看名字知用途，其中 <code>@RequiredArgsConstructor </code> 通过 <code>@NonNull</code> 获取需要构造的属性。</p><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.AccessLevel;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.NonNull;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(staticName = &quot;of&quot;)</span></span><br><span class="line"><span class="meta">@AllArgsConstructor(access = AccessLevel.PROTECTED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConstructorExample</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> x, y;</span><br><span class="line">  <span class="meta">@NonNull</span> <span class="keyword">private</span> T description;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NoArgsConstructor</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NoArgsExample</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span> <span class="keyword">private</span> String field;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConstructorExample</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> x, y;</span><br><span class="line">  <span class="meta">@NonNull</span> <span class="keyword">private</span> T description;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">ConstructorExample</span><span class="params">(T description)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (description == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.description = description;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ConstructorExample&lt;T&gt; <span class="title function_">of</span><span class="params">(T description)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConstructorExample</span>&lt;T&gt;(description);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@java</span>.beans.ConstructorProperties(&#123;<span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;description&quot;</span>&#125;)</span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">ConstructorExample</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, T description)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (description == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.x = x;</span><br><span class="line">    <span class="built_in">this</span>.y = y;</span><br><span class="line">    <span class="built_in">this</span>.description = description;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NoArgsExample</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span> <span class="keyword">private</span> String field;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NoArgsExample</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Data"><a href="#Data" class="headerlink" title="@Data"></a>@Data</h3><p><a href="https://projectlombok.org/features/Data">@Data</a></p><p>作用于类上，是以下注解的集合：</p><p><code>@ToString @EqualsAndHashCode @Getter @Setter @RequiredArgsConstructor</code></p><h3 id="Value"><a href="#Value" class="headerlink" title="@Value"></a>@Value</h3><p><a href="https://projectlombok.org/features/Value">@Value</a></p><p>用于一个不可变的对象类，区别于 <code>@Data</code> 在于没有 <code>@Setter</code>，属性默认 <code>final</code>，构造函数是 <code>@AllArgsConstructor</code>。</p><h3 id="Builder"><a href="#Builder" class="headerlink" title="@Builder"></a>@Builder</h3><p><a href="https://projectlombok.org/features/Builder">@Builder</a></p><p>作用于类上，将类转变为建造者模式。</p><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Singular;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuilderExample</span> &#123;</span><br><span class="line">  <span class="meta">@Builder</span>.Default <span class="keyword">private</span> <span class="type">long</span> <span class="variable">created</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">  <span class="meta">@Singular</span> <span class="keyword">private</span> Set&lt;String&gt; occupations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuilderExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">long</span> created;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; occupations;</span><br><span class="line">  </span><br><span class="line">  BuilderExample(String name, <span class="type">int</span> age, Set&lt;String&gt; occupations) &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">    <span class="built_in">this</span>.occupations = occupations;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> $<span class="keyword">default</span>$created() &#123;</span><br><span class="line">    <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> BuilderExampleBuilder <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BuilderExampleBuilder</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BuilderExampleBuilder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> created;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> created$set;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> java.util.ArrayList&lt;String&gt; occupations;</span><br><span class="line">    </span><br><span class="line">    BuilderExampleBuilder() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BuilderExampleBuilder <span class="title function_">created</span><span class="params">(<span class="type">long</span> created)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.created = created;</span><br><span class="line">      <span class="built_in">this</span>.created$set = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BuilderExampleBuilder <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.name = name;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BuilderExampleBuilder <span class="title function_">age</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.age = age;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BuilderExampleBuilder <span class="title function_">occupation</span><span class="params">(String occupation)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.occupations == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.occupations = <span class="keyword">new</span> <span class="title class_">java</span>.util.ArrayList&lt;String&gt;();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="built_in">this</span>.occupations.add(occupation);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BuilderExampleBuilder <span class="title function_">occupations</span><span class="params">(Collection&lt;? extends String&gt; occupations)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.occupations == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.occupations = <span class="keyword">new</span> <span class="title class_">java</span>.util.ArrayList&lt;String&gt;();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.occupations.addAll(occupations);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BuilderExampleBuilder <span class="title function_">clearOccupations</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.occupations != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.occupations.clear();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BuilderExample <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// complicated switch statement to produce a compact properly sized immutable set omitted.</span></span><br><span class="line">      Set&lt;String&gt; occupations = ...;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BuilderExample</span>(created$set ? created : BuilderExample.$<span class="keyword">default</span>$created(), name, age, occupations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@java</span>.lang.Override</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;BuilderExample.BuilderExampleBuilder(created = &quot;</span> + <span class="built_in">this</span>.created + <span class="string">&quot;, name = &quot;</span> + <span class="built_in">this</span>.name + <span class="string">&quot;, age = &quot;</span> + <span class="built_in">this</span>.age + <span class="string">&quot;, occupations = &quot;</span> + <span class="built_in">this</span>.occupations + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SneakyThrows"><a href="#SneakyThrows" class="headerlink" title="@SneakyThrows"></a>@SneakyThrows</h3><p><a href="https://projectlombok.org/features/SneakyThrows">@SneakyThrows</a></p><p>可以对受检异常进行捕捉并抛出，根据官方介绍大概抛出之前没检查的异常。</p><blockquote><p>To boldly throw checked exceptions where no one has thrown them before!</p></blockquote><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SneakyThrowsExample</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="meta">@SneakyThrows(UnsupportedEncodingException.class)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">utf8ToString</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@SneakyThrows</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Lombok;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SneakyThrowsExample</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">utf8ToString</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> Lombok.sneakyThrow(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> Lombok.sneakyThrow(t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Synchronized"><a href="#Synchronized" class="headerlink" title="@Synchronized"></a>@Synchronized</h3><p><a href="https://projectlombok.org/features/Synchronized">@Synchronized</a></p><p>作用于方法级别，可以替换 synchronize 关键字或 lock 锁，用处不大。</p><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.Synchronized;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">readLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Synchronized</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Synchronized</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">answerToLife</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Synchronized(&quot;readLock&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;bar&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">$LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">$lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">readLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>($LOCK) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">answerToLife</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>($lock) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(readLock) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;bar&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="With"><a href="#With" class="headerlink" title="@With"></a>@With</h3><p><a href="https://projectlombok.org/features/With">@With</a></p><p>克隆对象，修改一个值而保留其他值不变。</p><p><strong>With Lombok</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> lombok.AccessLevel;</span><br><span class="line"><span class="keyword">import</span> lombok.NonNull;</span><br><span class="line"><span class="keyword">import</span> lombok.With;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WithExample</span> &#123;</span><br><span class="line">  <span class="meta">@With(AccessLevel.PROTECTED)</span> <span class="meta">@NonNull</span> <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">  <span class="meta">@With</span> <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> age;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WithExample</span><span class="params">(<span class="meta">@NonNull</span> String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Vanilla Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> lombok.NonNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WithExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="keyword">final</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WithExample</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> WithExample <span class="title function_">withName</span><span class="params">(<span class="meta">@NonNull</span> String name)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.lang.NullPointerException(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.name == name ? <span class="built_in">this</span> : <span class="keyword">new</span> <span class="title class_">WithExample</span>(name, age);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> WithExample <span class="title function_">withAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.age == age ? <span class="built_in">this</span> : <span class="keyword">new</span> <span class="title class_">WithExample</span>(name, age);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Log"><a href="#Log" class="headerlink" title="@Log"></a>@Log</h3><p><a href="https://projectlombok.org/features/log">@Log (and friends)</a></p><p>作用于类上，生成日志变量。</p><p>针对不同的日志实现产品，有不同的注解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Log4j</span></span><br><span class="line"><span class="comment">//=</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.log4j.<span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> org.apache.log4j.Logger.getLogger(LogExample.class);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">//=</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.<span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> org.slf4j.LoggerFactory.getLogger(LogExample.class);</span><br></pre></td></tr></table></figure><blockquote><p>SLF4J (Simple logging Facade for Java) 不是一个真正的日志实现，而是一个<strong>抽象层</strong>（ abstraction layer），它<strong>允许你在后台使用任意一个日志类库</strong>。</p></blockquote><h2 id="语法糖"><a href="#语法糖" class="headerlink" title="语法糖"></a>语法糖</h2><h3 id="Val"><a href="#Val" class="headerlink" title="Val"></a>Val</h3><p><a href="https://projectlombok.org/features/val">val</a></p><p>用在局部变量前面，声明为 final 常量。</p><h3 id="Var"><a href="#Var" class="headerlink" title="Var"></a>Var</h3><p><a href="https://projectlombok.org/features/var">var</a></p><p>用在局部变量前面，声明变量。</p><h2 id="实验性"><a href="#实验性" class="headerlink" title="实验性"></a>实验性</h2><p>更多开发中的功能详见：</p><p><a href="https://projectlombok.org/features/experimental/">Experimental</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;lombok 通过注解消除实际开发中的样板式代码：getter、setter 方法，重写 toString、equals 方法等。&lt;/p&gt;</summary>
    
    
    
    <category term="Programming Language" scheme="http://blog.sukiu.top/categories/Programming-Language/"/>
    
    <category term="Java" scheme="http://blog.sukiu.top/categories/Programming-Language/Java/"/>
    
    
    <category term="Annotation" scheme="http://blog.sukiu.top/tags/Annotation/"/>
    
  </entry>
  
  <entry>
    <title>消息队列</title>
    <link href="http://blog.sukiu.top/Framework/Message-Queue/Message-Queue/"/>
    <id>http://blog.sukiu.top/Framework/Message-Queue/Message-Queue/</id>
    <published>2022-10-15T13:27:00.000Z</published>
    <updated>2022-10-15T14:04:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>在操作系统中，<strong>消息队列</strong>（Message queue）是一种进程间通信或同一进程的不同线程间的通信方式。</p><p>消息队列可以看作是一个存放消息的容器，是一种<strong>异步</strong>的通信方式。</p><span id="more"></span><h2 id="为什么使用消息队列"><a href="#为什么使用消息队列" class="headerlink" title="为什么使用消息队列"></a>为什么使用消息队列</h2><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202210152143172.awebp" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202210152143172.awebp" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt=" 消息队列 " style="zoom:67%;" /><p>比较核心的有 3 个：<strong>异步</strong>、<strong>削峰</strong>、<strong>解耦</strong>。</p><h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>通过异步处理，能够提高系统性能（减少响应所需时间）。</p><blockquote><p>一般互联网类的企业，对于用户直接的操作，一般要求是每个请求都必须在 200 ms 以内完成，对用户几乎是无感知的。</p></blockquote><h3 id="削峰-x2F-限流"><a href="#削峰-x2F-限流" class="headerlink" title="削峰&#x2F;限流"></a>削峰&#x2F;限流</h3><p>先将短时间高并发产生的事务消息存储在消息队列中，然后后端服务再慢慢根据自己的能力去消费这些消息，这样就避免直接把后端服务打垮掉。</p><blockquote><p>电子商务一些秒杀、促销活动中，合理使用消息队列可以有效抵御促销活动刚开始大量订单涌入对系统的冲击。</p></blockquote><h3 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h3><p>消息队列使用发布 - 订阅模式工作，消息发送者（生产者）发布消息，一个或多个消息接受者（消费者）订阅消息。</p><p>对新增业务，只要对该类消息感兴趣，即可订阅该消息，对原有系统和业务没有任何影响，从而实现网站业务的可扩展性设计。</p><h2 id="消息队列的缺点"><a href="#消息队列的缺点" class="headerlink" title="消息队列的缺点"></a>消息队列的缺点</h2><ul><li><strong>系统可用性降低：</strong> 需要考虑消息丢失或者 MQ 挂掉等情况。</li><li><strong>系统复杂性提高：</strong> 需要保证消息没有被重复消费、处理消息丢失的情况、保证消息传递的顺序性等问题。</li><li><strong>一致性问题：</strong> 万一消息的真正消费者并没有正确消费消息，就会导致数据不一致的情况。</li></ul><h2 id="常见的消息队列"><a href="#常见的消息队列" class="headerlink" title="常见的消息队列"></a>常见的消息队列</h2><table><thead><tr><th>特性</th><th>ActiveMQ</th><th>RabbitMQ</th><th>RocketMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>单机吞吐量</td><td>万级，比 RocketMQ、Kafka 低一个数量级</td><td>同 ActiveMQ</td><td>10 万级，支撑高吞吐</td><td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td></tr><tr><td>topic 数量对吞吐量的影响</td><td></td><td></td><td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td><td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td></tr><tr><td>时效性</td><td>ms 级</td><td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td><td>ms 级</td><td>延迟在 ms 级以内</td></tr><tr><td>可用性</td><td>高，基于主从架构实现高可用</td><td>同 ActiveMQ</td><td>非常高，分布式架构</td><td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td></tr><tr><td>消息可靠性</td><td>有较低的概率丢失数据</td><td>基本不丢</td><td>经过参数优化配置，可以做到 0 丢失</td><td>同 RocketMQ</td></tr><tr><td>功能支持</td><td>MQ 领域的功能极其完备</td><td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td><td>MQ 功能较为完善，还是分布式的，扩展性好</td><td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td></tr></tbody></table><blockquote><p><strong>中小型公司</strong>，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择；</p><p><strong>大型公司</strong>，基础架构研发实力较强，用 RocketMQ 是很好的选择；</p><p>如果是<strong>大数据领域</strong>的实时计算、日志采集等场景，用 Kafka 是业内标准的。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;在操作系统中，&lt;strong&gt;消息队列&lt;/strong&gt;（Message queue）是一种进程间通信或同一进程的不同线程间的通信方式。&lt;/p&gt;
&lt;p&gt;消息队列可以看作是一个存放消息的容器，是一种&lt;strong&gt;异步&lt;/strong&gt;的通信方式。&lt;/p&gt;</summary>
    
    
    
    <category term="Framework" scheme="http://blog.sukiu.top/categories/Framework/"/>
    
    <category term="Message Queue" scheme="http://blog.sukiu.top/categories/Framework/Message-Queue/"/>
    
    
    <category term="Message Queue" scheme="http://blog.sukiu.top/tags/Message-Queue/"/>
    
  </entry>
  
  <entry>
    <title>Flutter 数据/状态共享</title>
    <link href="http://blog.sukiu.top/Framework/Flutter/Flutter-Share-State/"/>
    <id>http://blog.sukiu.top/Framework/Flutter/Flutter-Share-State/</id>
    <published>2022-07-22T00:28:00.000Z</published>
    <updated>2022-07-22T01:43:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>共享原则：</p><ul><li>如果状态是组件私有的，则应该由组件自己管理；</li><li>如果状态要跨组件共享，则该状态应该由各个组件共同的父元素来管理。</li></ul><span id="more"></span><h2 id="InheritedWidget"><a href="#InheritedWidget" class="headerlink" title="InheritedWidget"></a>InheritedWidget</h2><p><code>InheritedWidget</code> 是 Flutter 中非常重要的一个功能型组件，它提供了一种在 widget 树中从上到下共享数据的方式。</p><blockquote><p><code>InheritedWidget</code> 的在 widget 树中数据传递方向是从上到下的，这和通知 <code>Notification</code>（将在下一章中介绍）的传递方向正好相反。</p></blockquote><p>下面是“计数器”示例应用程序的 <code>InheritedWidget</code> 版本：</p><p class="codepen" data-height="566.1328125" data-theme-id="dark" data-default-tab="js,result" data-slug-hash="vYRZYbM" data-preview="true" data-user="sukievaa" style="height: 566.1328125px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;">  <span>See the Pen <a href="https://codepen.io/sukievaa/pen/vYRZYbM">  InheritedWidget</a> by SukiEva (<a href="https://codepen.io/sukievaa">@sukievaa</a>)  on <a href="https://codepen.io">CodePen</a>.</span></p><script async src="https://cpwebassets.codepen.io/assets/embed/ei.js"></script><p>这样，子组件可以调用父组件里的 data 值进行操作。</p><h3 id="didChangeDependencies"><a href="#didChangeDependencies" class="headerlink" title="didChangeDependencies()"></a>didChangeDependencies()</h3><p>一般来说，子 widget 很少会重写此方法，因为在依赖改变后 Flutter 框架也都会调用 <code>build()</code> 方法重新构建组件树。</p><p>但是，如果需要在依赖改变后执行一些昂贵的操作，比如网络请求，这时最好的方式就是在此方法中执行，这样可以避免每次 <code>build()</code> 都执行这些昂贵操作。</p><p>如果只想在 <code>__TestWidgetState</code> 中引用 <code>ShareDataWidget</code> 数据，但却不希望在 <code>ShareDataWidget</code> 发生变化时调用 <code>__TestWidgetState</code> 的 <code>didChangeDependencies()</code> 方法，将 <code>ShareDataWidget.of()</code> 修改一下：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ShareDataWidget of(BuildContext context) &#123;</span><br><span class="line">  <span class="comment">//return context.dependOnInheritedWidgetOfExactType&lt;ShareDataWidget&gt;();</span></span><br><span class="line">  <span class="keyword">return</span> context.getElementForInheritedWidgetOfExactType&lt;ShareDataWidget&gt;().widget;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>dependOnInheritedWidgetOfExactType()</code> 比 <code>getElementForInheritedWidgetOfExactType()</code> 多调了 <code>dependOnInheritedElement</code> 方法，<code>dependOnInheritedElement</code> 源码如下：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">InheritedWidget dependOnInheritedElement(InheritedElement ancestor, &#123; <span class="built_in">Object</span> aspect &#125;) &#123;</span><br><span class="line">  <span class="keyword">assert</span>(ancestor != <span class="keyword">null</span>);</span><br><span class="line">  _dependencies ??= HashSet&lt;InheritedElement&gt;();</span><br><span class="line">  _dependencies.add(ancestor);</span><br><span class="line">  ancestor.updateDependencies(<span class="keyword">this</span>, aspect);</span><br><span class="line">  <span class="keyword">return</span> ancestor.widget;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>调用 <code>dependOnInheritedWidgetOfExactType()</code> 和 <code>getElementForInheritedWidgetOfExactType()</code> 的区别：</strong><br><strong>前者会注册依赖关系，而后者不会</strong></p><h2 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h2><p>对 <a href="https://api.flutter-io.cn/flutter/widgets/InheritedWidget-class.html">InheritedWidget</a> 组件的上层封装，使其更易用，更易复用。</p><p>使用 <code>provider</code> 而非手动书写 <a href="https://api.flutter-io.cn/flutter/widgets/InheritedWidget-class.html">InheritedWidget</a>，有以下的优势:</p><ul><li>简化的资源分配与处置</li><li>懒加载</li><li>创建新类时减少大量的模板代码</li><li>支持 DevTools</li><li>更通用的调用 <a href="https://api.flutter-io.cn/flutter/widgets/InheritedWidget-class.html">InheritedWidget</a> 的方式（参考 <a href="https://pub.flutter-io.cn/documentation/provider/latest/provider/Provider/of.html">Provider.of</a>&#x2F;<a href="https://pub.flutter-io.cn/documentation/provider/latest/provider/Consumer-class.html">Consumer</a>&#x2F;<a href="https://pub.flutter-io.cn/documentation/provider/latest/provider/Selector-class.html">Selector</a>）</li><li>提升类的可扩展性，整体的监听架构时间复杂度以指数级增长（如 <a href="https://api.flutter-io.cn/flutter/foundation/ChangeNotifier-class.html">ChangeNotifier</a>， 其复杂度为 O(N)）</li></ul><p>更多 <code>provider</code> 相关内容，请参考 <a href="https://pub.flutter-io.cn/documentation/provider/latest/provider/provider-library.html">文档</a>。</p><div class="tag link"><a class="link-card" title="Flutter Provider 使用" href="https://www.jianshu.com/p/db5a42074cdd"><div class="left"><img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/256/safari.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">Flutter Provider 使用</p><p class="url">https://www.jianshu.com/p/db5a42074cdd</p></div></a></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;共享原则：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果状态是组件私有的，则应该由组件自己管理；&lt;/li&gt;
&lt;li&gt;如果状态要跨组件共享，则该状态应该由各个组件共同的父元素来管理。&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Framework" scheme="http://blog.sukiu.top/categories/Framework/"/>
    
    <category term="Flutter" scheme="http://blog.sukiu.top/categories/Framework/Flutter/"/>
    
    
    <category term="Flutter" scheme="http://blog.sukiu.top/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot（Kotlin）使用Redis的踩坑记录</title>
    <link href="http://blog.sukiu.top/Projects/Problems/Redis-Usage-With-Kotlin/"/>
    <id>http://blog.sukiu.top/Projects/Problems/Redis-Usage-With-Kotlin/</id>
    <published>2022-07-17T12:50:00.000Z</published>
    <updated>2022-07-17T14:15:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>虽然理论上 Koltin “NTR” 了 Java 的一切，但是在实际开发中总能碰到许多奇奇怪怪的问题。</p><span id="more"></span><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>首先是 Redis 的依赖：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation(<span class="string">&quot;org.springframework.boot:spring-boot-starter-data-redis&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个包会通过反射来加载一些 class，这就要求 class 必需有一个无参的构造函数，而 Kotlin 的 data class 默认没有无参构造函数，并且 data class 默认为 final 类型，不可以被继承，会出现下列错误：</p><p><code>org.springframework.data.redis.serializer.SerializationException: Could not read JSON: Cannot construct instance of …</code></p><p>Kotlin 官方为我们提供了两个插件：</p><ul><li>无参编译器插件 NoArg 插件的作用是：为指定的类在编译时添加一个无参的构造。</li><li>全开放编译器插件 AllOpen 的作用是：使用指定的注解标注类而其成员无需显式使用 open 关键字打开。</li></ul><p><strong>Spring Boot 只需要 NoArg 插件，因为添加的 kotlin-spring 插件包含 AllOpen 了，会自动给 Spring 注解类 open</strong>，下面的只作为演示：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    <span class="keyword">val</span> kotlinVersion = <span class="string">&quot;1.6.21&quot;</span></span><br><span class="line">    id(<span class="string">&quot;org.jetbrains.kotlin.plugin.noarg&quot;</span>) version kotlinVersion</span><br><span class="line">    id(<span class="string">&quot;org.jetbrains.kotlin.plugin.allopen&quot;</span>) version kotlinVersion</span><br><span class="line">    kotlin(<span class="string">&quot;plugin.jpa&quot;</span>) version kotlinVersion</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allOpen &#123;</span><br><span class="line">    <span class="keyword">annotation</span>(<span class="string">&quot;com.gitfy.gitfyapi.util.AllOpen&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">noArg &#123;</span><br><span class="line">    <span class="keyword">annotation</span>(<span class="string">&quot;com.gitfy.gitfyapi.util.NoArg&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>特别说明一下这俩插件的使用，除了在 <code>plugins</code> 里添加依赖，还需要加上上面的俩注解声明，其中前面的是声明的注解类所在包，比如我在 <code>om.gitfy.gitfyapi.util</code> 包下新建 <code>Annotations.kt</code>：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gitfy.gitfyapi.util</span><br><span class="line"></span><br><span class="line"><span class="keyword">annotation</span> <span class="class"><span class="keyword">class</span> <span class="title">NoArg</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">annotation</span> <span class="class"><span class="keyword">class</span> <span class="title">AllOpen</span></span></span><br></pre></td></tr></table></figure><p>这些弄完就可以在 data class 里使用注解了：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArg</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Repo</span></span>(</span><br><span class="line">    <span class="keyword">var</span> platform: String,</span><br><span class="line">    <span class="keyword">var</span> owner: String,</span><br><span class="line">    <span class="keyword">var</span> repo: String,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>如果项目中已经添加了 <code>kotlin-jpa</code> 插件，那么基本上就不必单独添加无参插件了。</p><p><code>kotlin-jpa</code> 对无参插件做了包装，当使用 <code>@Entity</code>、<code> @Embeddable</code> 与 <code> @MappedSuperclass</code> 这几个注解时，都会默认支持无参注解的。</p><p>当然也可以手动给 data class 赋初始值。</p></blockquote><h2 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h2><p>这里将 <code>key</code> 序列化为 <code>string</code>，<code>value</code> 序列化为 <code>json</code>。</p><p>SpringBoot 的缓存使用 jackson 来做数据的序列化与反序列化，如果默认使用 Any 作为序列化与反序列化的类型，则其只能识别基本类型，遇到复杂类型时，jackson 就会先序列化成 LinkedHashMap ，然后再尝试强转为所需类别，这样大部分情况下会强转失败，出现以下错误：</p><p><code>class java.util.LinkedHashMap cannot be cast to class …</code></p><p>解决方法是修改 RedisTemplate 这个 bean 的 valueSerializer，即设置默认类型。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置Jackson2JsonRedisSerializer序列化策略</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Jackson2JsonRedisSerializer&lt;Any&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">serializer</span><span class="params">()</span></span>: Jackson2JsonRedisSerializer&lt;Any&gt; &#123;</span><br><span class="line">        <span class="comment">// 使用 Jackson2JsonRedisSerializer 来序列化和反序列化 redis 的 value 值</span></span><br><span class="line">        <span class="keyword">val</span> jackson2JsonRedisSerializer = Jackson2JsonRedisSerializer(Any::<span class="keyword">class</span>.java)</span><br><span class="line">        <span class="keyword">val</span> objectMapper = ObjectMapper().apply &#123;</span><br><span class="line">            <span class="comment">// 指定要序列化的域，field,get和set,以及修饰符范围，ANY是都有包括private和public</span></span><br><span class="line">            setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY)</span><br><span class="line">            <span class="comment">// 指定序列化输入的类型，类必须是非final修饰的，final修饰的类，比如String,Integer等会跑出异常</span></span><br><span class="line">           <span class="comment">// 这个必须加！！！不然 class java.util.LinkedHashMap cannot be cast to class XXX</span></span><br><span class="line">            activateDefaultTyping(</span><br><span class="line">                <span class="keyword">this</span>.polymorphicTypeValidator,</span><br><span class="line">                ObjectMapper.DefaultTyping.NON_FINAL,</span><br><span class="line">                JsonTypeInfo.As.PROPERTY</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper)</span><br><span class="line">        <span class="keyword">return</span> jackson2JsonRedisSerializer</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Redis template 配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisConnectionFactory redis连接工厂</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RedisTemplate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">redisTemplate</span><span class="params">(redisConnectionFactory: <span class="type">RedisConnectionFactory</span>)</span></span>: RedisTemplate&lt;String, Any&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> redisTemplate = RedisTemplate&lt;String, Any&gt;()</span><br><span class="line">        <span class="keyword">val</span> stringRedisSerializer = StringRedisSerializer()</span><br><span class="line">        <span class="keyword">val</span> jackson2JsonRedisSerializer = serializer()</span><br><span class="line">        redisTemplate.apply &#123;</span><br><span class="line">            <span class="comment">// 配置连接工厂</span></span><br><span class="line">            setConnectionFactory(redisConnectionFactory)</span><br><span class="line">            <span class="comment">// 配置 key 序列化方式</span></span><br><span class="line">            keySerializer = stringRedisSerializer</span><br><span class="line">            <span class="comment">// 配置 value 序列化方式: 使用 Jackson2JsonRedisSerializer</span></span><br><span class="line">            valueSerializer = jackson2JsonRedisSerializer</span><br><span class="line">            <span class="comment">// 配置 hash key 序列化方式</span></span><br><span class="line">            hashKeySerializer = stringRedisSerializer</span><br><span class="line">            <span class="comment">// 配置 hash value 序列化方式</span></span><br><span class="line">            hashValueSerializer = jackson2JsonRedisSerializer</span><br><span class="line">            afterPropertiesSet()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="封装工具"><a href="#封装工具" class="headerlink" title="封装工具"></a>封装工具</h2><p>为了方便，封装一个简单的工具类：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> redisTemplate: RedisTemplate&lt;String, Any&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Any?</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(key: <span class="type">String</span>)</span></span>: Any? &#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="string">&quot;&quot;</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForValue().<span class="keyword">get</span>(key)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写入数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expireTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">set</span><span class="params">(key: <span class="type">String</span>, value: <span class="type">Any</span>, expireTime: <span class="type">Long</span>? = <span class="literal">null</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="string">&quot;&quot;</span>) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().<span class="keyword">set</span>(key, value)</span><br><span class="line">            expireTime?.let &#123;</span><br><span class="line">                redisTemplate.expire(key, it, TimeUnit.SECONDS)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试使用"><a href="#测试使用" class="headerlink" title="测试使用"></a>测试使用</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner::class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisUtilTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> redisUtil: RedisUtil</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> repo = redisUtil.<span class="keyword">get</span>(<span class="string">&quot;github:SukiEva:GitfyApi&quot;</span>)</span><br><span class="line">        println(repo)</span><br><span class="line">        <span class="keyword">val</span> obj:Repo = repo <span class="keyword">as</span> Repo</span><br><span class="line">        println(obj)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">set</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> repo = Repo(<span class="string">&quot;github&quot;</span>, <span class="string">&quot;SukiEva&quot;</span>, <span class="string">&quot;GitfyApi&quot;</span>)</span><br><span class="line">        redisUtil.<span class="keyword">set</span>(<span class="string">&quot;github:SukiEva:GitfyApi&quot;</span>, repo)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你也是 Kotlin 玩家，这里肯定会碰到报错：</p><p><code>org.springframework.data.redis.serializer.SerializationException: Could not read JSON: Could not resolve subtype of [simple type, class java.lang.Object]: missing type id property &#39;@class&#39;</code></p><p>在 <code>Java</code> 中，实体类没有任何额外配置，<code>Redis</code> 序列化&#x2F;反序列化一样没有问题，是因为值序列化器 <code>GenericJackson2JsonRedisSerializer</code>，该类会自动添加一个 <code>@class</code> 字段，因此不会出现上面的问题。</p><p>但是在 <code>Kotlin</code> 中，类默认不是 <code>open</code> 的，也就是无法添加 <code>@class</code> 字段，因此便会反序列化失败。</p><p>首先当然可以通过不用 data class 来解决，直接给普通 class open，这当然不是我们想要的，所以需要添加一个类注解 <code>@JsonTypeInfo</code>：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArg</span></span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Repo</span></span>(</span><br><span class="line">    <span class="keyword">var</span> platform: String,</span><br><span class="line">    <span class="keyword">var</span> owner: String,</span><br><span class="line">    <span class="keyword">var</span> repo: String,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>该注解的 <code>use</code> 用于指定类型标识码，该值只能为 <code>JsonTypeInfo.Id.CLASS</code>。</p><p>这时 Redis 中的结构是：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.gitfy.gitfyapi.pojo.Repo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;github&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;owner&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SukiEva&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;repo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GitfyApi&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>并且此时 <code>get</code> 方法也能正常获取值，并强制类型转换为对应的对象。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;虽然理论上 Koltin “NTR” 了 Java 的一切，但是在实际开发中总能碰到许多奇奇怪怪的问题。&lt;/p&gt;</summary>
    
    
    
    <category term="Projects" scheme="http://blog.sukiu.top/categories/Projects/"/>
    
    <category term="Problems" scheme="http://blog.sukiu.top/categories/Projects/Problems/"/>
    
    
    <category term="Kotlin" scheme="http://blog.sukiu.top/tags/Kotlin/"/>
    
    <category term="Redis" scheme="http://blog.sukiu.top/tags/Redis/"/>
    
    <category term="Spring Boot" scheme="http://blog.sukiu.top/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>Gradle</title>
    <link href="http://blog.sukiu.top/Build-Tools/Gradle/Gradle/"/>
    <id>http://blog.sukiu.top/Build-Tools/Gradle/Gradle/</id>
    <published>2022-07-15T02:20:00.000Z</published>
    <updated>2022-07-15T03:30:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Gradle 是一种开源构建自动化的工具，旨在灵活地构建几乎任何类型的软件。</p><span id="more"></span><h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>Gradle 是一种开源构建自动化的工具，旨在灵活地构建几乎任何类型的软件。</p><ul><li>高性能：避免重复任务、缓存复用</li><li>基于 JVM：需要 JDK 环境、可用 Java API、跨平台、也适用于其他原生项目</li><li>约定：借鉴 Maven 经验、可用各种插件、可自定义插件和任务</li><li>可拓展性：可自定义任务类型和构建模型（比如 Android）</li><li>IDE 支持：Android Studio, IntelliJ IDEA, Eclipse, and NetBeans.</li><li>检视：构建时提供输出信息供查错</li></ul><p>更多特点参考：</p><div class="tag link"><a class="link-card" title="Gradle 中文文档" href="https://doc.yonyoucloud.com/doc/wiki/project/GradleUserGuide-Wiki/overview/features.html"><div class="left"><img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/256/safari.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">Gradle 中文文档</p><p class="url">https://doc.yonyoucloud.com/doc/wiki/project/GradleUserGuide-Wiki/overview/features.html</p></div></a></div><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>Gradle 基于下面两个基础概念:</p><ul><li>projects (项目)：每一个 project 是由一个或多个 tasks 构成的</li><li>tasks (任务)：更加细化的构建，可能是编译一些 classes、创建一个 JAR、生成 javadoc 等</li></ul><h3 id="任务定义"><a href="#任务定义" class="headerlink" title="任务定义"></a>任务定义</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;Hello world!&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task upper &lt;&lt; &#123;</span><br><span class="line">    String someString = <span class="string">&#x27;mY_nAmE&#x27;</span></span><br><span class="line">    println <span class="string">&quot;Original: &quot;</span> + someString</span><br><span class="line">    println <span class="string">&quot;Upper case: &quot;</span> + someString.toUpperCase()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>gradle -q hello</code> 运行</p><blockquote><p><code>-q</code>：不会生成 Gradle 的日志信息 (log messages), 所以用户只能看到 tasks 的输出</p></blockquote><h3 id="任务依赖"><a href="#任务依赖" class="headerlink" title="任务依赖"></a>任务依赖</h3><p>执行 <code>gradle -q intro</code> 时，会先执行 <code>hello</code> 任务：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;Hello world!&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task intro(<span class="attr">dependsOn:</span> hello) &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&quot;I&#x27;m Gradle&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在加入一个依赖之前，这个依赖的任务不需要提前定义，即顺序无所谓。</p></blockquote><h3 id="动态任务"><a href="#动态任务" class="headerlink" title="动态任务"></a>动态任务</h3><p>动态创建 task1, task2, task3, task4：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4.</span>times &#123; counter -&gt;</span><br><span class="line">    task <span class="string">&quot;task$counter&quot;</span> &lt;&lt; &#123;</span><br><span class="line">        println <span class="string">&quot;I&#x27;m task number $counter&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q task1</span></span><br><span class="line">I&#x27;m task number 1</span><br></pre></td></tr></table></figure><h3 id="使用已有任务"><a href="#使用已有任务" class="headerlink" title="使用已有任务"></a>使用已有任务</h3><h4 id="使用依赖"><a href="#使用依赖" class="headerlink" title="使用依赖"></a>使用依赖</h4><p>使用上面动态任务的例子：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task0.dependsOn task2, task3</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q task0</span></span><br><span class="line">I&#x27;m task number 2</span><br><span class="line">I&#x27;m task number 3</span><br><span class="line">I&#x27;m task number 0</span><br></pre></td></tr></table></figure><h4 id="使用行为"><a href="#使用行为" class="headerlink" title="使用行为"></a>使用行为</h4><p><code>doFirst</code> 和 <code>doLast</code> 可以被执行许多次，<code>&lt;&lt;</code> 是 <code>doLast</code> 简写：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;Hello Earth&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">hello.doFirst &#123;</span><br><span class="line">    println <span class="string">&#x27;Hello Venus&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">hello.doLast &#123;</span><br><span class="line">    println <span class="string">&#x27;Hello Mars&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;Hello Jupiter&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q hello</span></span><br><span class="line">Hello Venus</span><br><span class="line">Hello Earth</span><br><span class="line">Hello Mars</span><br><span class="line">Hello Jupiter</span><br></pre></td></tr></table></figure><h3 id="短标记"><a href="#短标记" class="headerlink" title="短标记"></a>短标记</h3><p>短标记 <code>$</code> 可以访问一个存在的任务：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;Hello world!&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">hello.doLast &#123;</span><br><span class="line">    println <span class="string">&quot;Greetings from the $hello.name task.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q hello</span></span><br><span class="line">Hello world!</span><br><span class="line">Greetings from the hello task.</span><br></pre></td></tr></table></figure><h3 id="自定义属性"><a href="#自定义属性" class="headerlink" title="自定义属性"></a>自定义属性</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">task myTask &#123;</span><br><span class="line">    ext.myProperty = <span class="string">&quot;myValue&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task printTaskProperties &lt;&lt; &#123;</span><br><span class="line">    println myTask.myProperty</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q printTaskProperties</span></span><br><span class="line">myValue</span><br></pre></td></tr></table></figure><h3 id="调用-Ant-任务"><a href="#调用-Ant-任务" class="headerlink" title="调用 Ant 任务"></a>调用 Ant 任务</h3><p>使用 AntBuilder 来执行 ant.loadfile 任务：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">task loadfile &lt;&lt; &#123;</span><br><span class="line">    <span class="keyword">def</span> files = file(<span class="string">&#x27;../antLoadfileResources&#x27;</span>).listFiles().sort()</span><br><span class="line">    files.each &#123; File file -&gt;</span><br><span class="line">        <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            ant.loadfile(<span class="attr">srcFile:</span> file, <span class="attr">property:</span> file.name)</span><br><span class="line">            println <span class="string">&quot; *** $file.name ***&quot;</span></span><br><span class="line">            println <span class="string">&quot;$&#123;ant.properties[file.name]&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q loadfile</span></span><br><span class="line">*** agile.manifesto.txt ***</span><br><span class="line">Individuals and interactions over processes and tools</span><br><span class="line">Working software over comprehensive documentation</span><br><span class="line">Customer collaboration  over contract negotiation</span><br><span class="line">Responding to change over following a plan</span><br><span class="line"> *** gradle.manifesto.txt ***</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">task checksum &lt;&lt; &#123;</span><br><span class="line">    fileList(<span class="string">&#x27;../antLoadfileResources&#x27;</span>).each &#123;File file -&gt;</span><br><span class="line">        ant.checksum(<span class="attr">file:</span> file, <span class="attr">property:</span> <span class="string">&quot;cs_$file.name&quot;</span>)</span><br><span class="line">        println <span class="string">&quot;$file.name Checksum: $&#123;ant.properties[&quot;</span>cs_$file.name<span class="string">&quot;]&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task loadfile &lt;&lt; &#123;</span><br><span class="line">    fileList(<span class="string">&#x27;../antLoadfileResources&#x27;</span>).each &#123;File file -&gt;</span><br><span class="line">        ant.loadfile(<span class="attr">srcFile:</span> file, <span class="attr">property:</span> file.name)</span><br><span class="line">        println <span class="string">&quot;I&#x27;m fond of $file.name&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">File[] fileList(String dir) &#123;</span><br><span class="line">    file(dir).listFiles(&#123;file -&gt; file.isFile() &#125; <span class="keyword">as</span> FileFilter).sort()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q loadfile</span></span><br><span class="line">I&#x27;m fond of agile.manifesto.txt</span><br><span class="line">I&#x27;m fond of gradle.manifesto.txt</span><br></pre></td></tr></table></figure><h3 id="默认任务"><a href="#默认任务" class="headerlink" title="默认任务"></a>默认任务</h3><p>Gradle 允许在脚本中定义一个或多个默认任务，构建时自动执行：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">defaultTasks <span class="string">&#x27;clean&#x27;</span>, <span class="string">&#x27;run&#x27;</span></span><br><span class="line"></span><br><span class="line">task clean &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;Default Cleaning!&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task run &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;Default Running!&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task other &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&quot;I&#x27;m not a default task!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q</span></span><br><span class="line">Default Cleaning!</span><br><span class="line">Default Running!</span><br></pre></td></tr></table></figure><h3 id="DAG-配置"><a href="#DAG-配置" class="headerlink" title="DAG 配置"></a>DAG 配置</h3><p>distribution 任务和 release 任务将根据变量的版本产生不同的值：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">task distribution &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&quot;We build the zip with version=$version&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task release(<span class="attr">dependsOn:</span> <span class="string">&#x27;distribution&#x27;</span>) &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">&#x27;We release now&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.whenReady &#123;taskGraph -&gt;</span><br><span class="line">    <span class="keyword">if</span> (taskGraph.hasTask(release)) &#123;</span><br><span class="line">        version = <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        version = <span class="string">&#x27;1.0-SNAPSHOT&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q distribution</span></span><br><span class="line">We build the zip with version=1.0-SNAPSHOT</span><br><span class="line">Output of gradle -q release</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gradle -q release</span></span><br><span class="line">We build the zip with version=1.0</span><br><span class="line">We release now</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Gradle 是一种开源构建自动化的工具，旨在灵活地构建几乎任何类型的软件。&lt;/p&gt;</summary>
    
    
    
    <category term="Build Tools" scheme="http://blog.sukiu.top/categories/Build-Tools/"/>
    
    <category term="Gradle" scheme="http://blog.sukiu.top/categories/Build-Tools/Gradle/"/>
    
    
    <category term="Gradle" scheme="http://blog.sukiu.top/tags/Gradle/"/>
    
  </entry>
  
  <entry>
    <title>什么是POJO？</title>
    <link href="http://blog.sukiu.top/Programming-Language/Java/What-Is-POJO/"/>
    <id>http://blog.sukiu.top/Programming-Language/Java/What-Is-POJO/</id>
    <published>2022-07-12T13:29:53.000Z</published>
    <updated>2022-07-12T13:56:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>在划分项目结构时，对实体类划分的各种命名。</p><ul><li>POJO：简单的 Java 对象</li><li>VO：值对象、视图对象</li><li>PO：持久对象</li><li>QO：查询对象</li><li>DAO：数据访问对象——同时还有 DAO 模式</li><li>DTO：数据传输对象——同时还有 DTO 模式</li></ul><span id="more"></span><h2 id="POJO"><a href="#POJO" class="headerlink" title="POJO"></a>POJO</h2><p>POJO（Plain Ordinary Java Object）简单的 Java 对象，实际就是普通 JavaBeans，是为了避免和 EJB（Enterprise JavaBean）混淆所创造的简称。</p><p>具有一部分 getter&#x2F;setter 方法的那种类就可以称作 POJO，POJO 不担当任何的特殊的角色，也不实现任何 Java 框架指定的接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DbHello</span> &#123; <span class="comment">//简单的Java类，称之为POJO，不继承，不实现接口</span></span><br><span class="line"></span><br><span class="line">   　　<span class="keyword">private</span> DictionaryDAO dao;</span><br><span class="line">   　　<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDao</span><span class="params">(DictionaryDAO dao)</span> &#123;</span><br><span class="line">          　　<span class="built_in">this</span>.dao = dao;</span><br><span class="line">   　　&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>POJO 可以认为是一个中间对象：</p><p>一个中间对象，可以转化为 PO、DTO、VO。</p><p>1 ．POJO 持久化之后 -&gt; PO（在运行期，由 Hibernate 中的 cglib 动态把 POJO 转换为 PO，PO 相对于 POJO 会增加一些用来管理数据库 entity 状态的属性和方法。PO 对于 programmer 来说完全透明，由于是运行期生成 PO，所以可以支持增量编译，增量调试）</p><p>2 ．POJO 传输过程中 -&gt; DTO</p><p>3 ．POJO 用作表示层 -&gt; VO</p></blockquote><h2 id="PO"><a href="#PO" class="headerlink" title="PO"></a>PO</h2><p>PO 全称是 persistant object （持久对象）。</p><p>最形象的理解就是一个 PO 就是数据库中的一条记录。好处是可以把一条记录作为一个对象处理，可以方便的转为其它对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h2 id="VO"><a href="#VO" class="headerlink" title="VO"></a>VO</h2><p>VO 全称是 value object 值对象 &#x2F; view object 表现层（视图）对象。</p><ul><li>Value Object：通常用于业务层之间的数据传递，和 PO 一样也是仅仅包含数据而已。</li><li>View Object：用一个 VO 对象对应整个界面的值，如对于一个 WEB 页面，或者 SWT、SWING 的一个界面，。</li></ul><h2 id="DTO"><a href="#DTO" class="headerlink" title="DTO"></a>DTO</h2><p>DTO （TO） 全称是 Data Transfer Object （数据传输对象），主要用于远程调用等需要大量传输对象的地方。</p><p>将 PO 中的部分属性抽取出来，就形成了 DTO。</p><blockquote><p>比如我们一张表有 100 个字段，那么对应的 PO 就有 100 个属性。</p><p>但是我们界面上只要显示 10 个字段，客户端用 WEB service 来获取数据，没有必要把整个 PO 对象传递到客户端，这时我们就可以用只有这 10 个属性的 DTO 来传递结果到客户端，这样也不会暴露服务端表结构.到达客户端以后，如果用这个对象来对应界面显示，那此时它的身份就转为 VO。</p></blockquote><h2 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h2><p>DAO 全称是 data access object （数据访问对象），主要用来封装对数据库的访问。</p><p>通常和 PO 结合使用，DAO 中包含了各种数据库的操作方法。它可以把 POJO 持久化为 PO，用 PO 组装出来 VO、DTO</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在划分项目结构时，对实体类划分的各种命名。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;POJO：简单的 Java 对象&lt;/li&gt;
&lt;li&gt;VO：值对象、视图对象&lt;/li&gt;
&lt;li&gt;PO：持久对象&lt;/li&gt;
&lt;li&gt;QO：查询对象&lt;/li&gt;
&lt;li&gt;DAO：数据访问对象——同时还有 DAO 模式&lt;/li&gt;
&lt;li&gt;DTO：数据传输对象——同时还有 DTO 模式&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Programming Language" scheme="http://blog.sukiu.top/categories/Programming-Language/"/>
    
    <category term="Java" scheme="http://blog.sukiu.top/categories/Programming-Language/Java/"/>
    
    
    <category term="Java" scheme="http://blog.sukiu.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java</title>
    <link href="http://blog.sukiu.top/Programming-Language/Java/Language-Java/"/>
    <id>http://blog.sukiu.top/Programming-Language/Java/Language-Java/</id>
    <published>2022-07-09T12:26:00.000Z</published>
    <updated>2022-07-09T12:31:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Write Once, Run Anywhere!</p><p>一些 Java 学习笔记。</p><span id="more"></span><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="JVM-Vs-JDK-Vs-JRE"><a href="#JVM-Vs-JDK-Vs-JRE" class="headerlink" title="JVM Vs JDK Vs JRE"></a>JVM Vs JDK Vs JRE</h3><ul><li>JVM（Java Virtual Machine）：运行 Java 字节码的虚拟机</li><li>JDK（Java Development Kit）： 功能齐全的 Java 开发工具，包含 JRE、编译器（Javac）和工具（如 javadoc 和 jdb）</li><li>JRE（Java Runtime Environment）：Java 运行时环境，包括 JVM、Java 类库、Java 命令和其他的一些基础构件</li></ul><h3 id="字节码文件-class"><a href="#字节码文件-class" class="headerlink" title="字节码文件 .class"></a>字节码文件 .class</h3><p>JVM 可以理解的代码就叫做字节码（即扩展名为 <code>.class</code> 的文件），它不面向任何特定的处理器，只面向虚拟机。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202207072159233.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202207072159233.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Java程序转变为机器代码的过程"></p><blockquote><p><strong>为什么说 Java 语言“编译与解释并存”？</strong></p><p>Java 语言既具有编译型语言的特征，也具有解释型语言的特征。</p><ol><li>由 Java 编写的程序需要先经过编译步骤，生成字节码（<code>.class</code> 文件）</li><li>这种字节码必须由 Java 解释器来解释执行。</li></ol></blockquote><h3 id="三大特征"><a href="#三大特征" class="headerlink" title="三大特征"></a>三大特征</h3><h4 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h4><p>封装是指把一个对象的状态信息（也就是属性）隐藏在对象内部，不允许外部对象直接访问对象的内部信息。</p><h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><p>继承是使用已存在的类的定义作为基础建立新类的基础，新类的定义可以增加新的数据或新的功能，也可以用父类的功能，但不能选择性地继承父类。</p><ol><li>子类拥有父类对象所有的属性和方法（包括私有属性和私有方法），但是父类中的私有属性和方法子类是无法访问，<strong>只是拥有</strong>。</li><li>子类可以拥有自己属性和方法，即子类可以对父类进行扩展。</li><li>子类可以用自己的方式实现父类的方法。</li></ol><h4 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h4><p>多态表示一个对象具有多种的状态，具体表现为父类的引用指向子类的实例。</p><p><strong>多态的特点:</strong></p><ul><li>对象类型和引用类型之间具有继承（类）&#x2F;实现（接口）的关系；</li><li>引用类型变量发出的方法调用的到底是哪个类中的方法，必须在程序运行期间才能确定；</li><li>多态不能调用“只在子类存在但在父类不存在”的方法；</li><li>如果子类重写了父类的方法，真正执行的是子类覆盖的方法，如果子类没有覆盖父类的方法，执行的是父类的方法。</li></ul><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="静态-Static"><a href="#静态-Static" class="headerlink" title="静态 Static"></a>静态 Static</h3><ul><li><strong>静态域</strong>（静态变量）：如果将域定义为 <code>static</code>, 每个类中只有一个这样的域。也就是所有对象共享同一个静态域，不需要拷贝。</li><li><strong>静态常量</strong>：相较于静态域，使用的更加频繁，用 <code>static final</code> 修饰。</li><li><strong>静态方法</strong>：特性同上，与普通方法的区别是不能向对象实施操作，即不能调用 <code>this</code>，但是可以调用类中的静态域。<strong>调用静态方法可以无需创建对象</strong>，一般使用 <code> 类名.方法名</code> 的方式来调用静态方法。</li></ul><h4 id="静态方法为什么不能调用非静态成员"><a href="#静态方法为什么不能调用非静态成员" class="headerlink" title="静态方法为什么不能调用非静态成员"></a>静态方法为什么不能调用非静态成员</h4><ol><li>静态方法是属于类的，在类加载的时候就会分配内存，可以通过类名直接访问。而非静态成员属于实例对象，只有在对象实例化之后才存在，需要通过类的实例对象去访问。</li><li>在类的非静态成员不存在的时候静态成员就已经存在了，此时调用在内存中还不存在的非静态成员，属于非法操作。</li></ol><h3 id="重载-amp-重写"><a href="#重载-amp-重写" class="headerlink" title="重载 &amp; 重写"></a>重载 &amp; 重写</h3><ul><li>重载：多个方法有相同的名字、不同的参数。同样的一个方法能够根据输入数据的不同，做出不同的处理。</li><li>重写：子类继承自父类的相同方法，<code>@Override</code></li></ul><h3 id="可变长参数"><a href="#可变长参数" class="headerlink" title="可变长参数"></a>可变长参数</h3><p>从 Java5 开始，Java 支持定义可变长参数，即允许在调用方法时传入不定长度的参数。</p><p>可变参数只能作为函数的最后一个参数，但其前面可以有也可以没有任何其他参数。</p><p><strong>方法重载会优先匹配固定参数</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(String arg1, String... args)</span> &#123;</span><br><span class="line">   <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="基本类型-amp-包装类"><a href="#基本类型-amp-包装类" class="headerlink" title="基本类型 &amp; 包装类"></a>基本类型 &amp; 包装类</h3><ul><li>基本类型：<ul><li>6 种数字类型：<ul><li>4 种整数型：<code>byte</code>、<code>short</code>、<code>int</code>、<code>long</code>（数值后面加 L）</li><li>2 种浮点型：<code>float</code>、<code>double</code></li></ul></li><li>1 种字符类型：<code>char</code></li><li>1 种布尔型：<code>boolean</code></li></ul></li><li>包装类：<code>Byte</code>、<code>Short</code>、<code>Integer</code>、<code>Long</code>、<code>Float</code>、<code>Double</code>、<code>Character</code>、<code>Boolean</code></li></ul><p><strong>所有整型包装类对象之间值的比较，全部使用 equals 方法比较</strong></p><h4 id="基本类型和包装类型的区别"><a href="#基本类型和包装类型的区别" class="headerlink" title="基本类型和包装类型的区别"></a>基本类型和包装类型的区别</h4><ul><li>成员变量包装类型不赋值就是 null ，而基本类型有默认值且不是 null。</li><li>包装类型可用于泛型，而基本类型不可以。</li><li>基本数据类型的局部变量存放在 Java 虚拟机栈中的局部变量表中，基本数据类型的成员变量（未被 static 修饰 ）存放在 Java 虚拟机的堆中。包装类型属于对象类型，我们知道几乎所有对象实例都存在于堆中。</li><li>相比于对象类型， 基本数据类型占用的空间非常小。</li></ul><h4 id="包装类型的缓存机制"><a href="#包装类型的缓存机制" class="headerlink" title="包装类型的缓存机制"></a>包装类型的缓存机制</h4><p> Java 基本数据类型的包装类型的大部分都用到了缓存机制来提升性能:</p><ul><li>Byte,Short,Integer,Long 这 4 种包装类默认创建了数值 [-128，127] 的相应类型的缓存数据</li><li>Character 创建了数值在 [0,127] 范围的缓存数据</li><li>Boolean 直接返回 True or False</li></ul><h4 id="装箱-amp-拆箱"><a href="#装箱-amp-拆箱" class="headerlink" title="装箱 &amp; 拆箱"></a>装箱 &amp; 拆箱</h4><ul><li><strong>装箱</strong>：将基本类型用它们对应的引用类型包装起来</li><li><strong>拆箱</strong>：将包装类型转换为基本数据类型</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;  <span class="comment">//装箱</span></span><br><span class="line"><span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> i;   <span class="comment">//拆箱</span></span><br></pre></td></tr></table></figure><p><strong>尽量避免不必要的拆装箱操作</strong>，频繁拆装箱会严重影响系统的性能。</p><h2 id="对象和类"><a href="#对象和类" class="headerlink" title="对象和类"></a>对象和类</h2><h3 id="抽象类-amp-接口"><a href="#抽象类-amp-接口" class="headerlink" title="抽象类 &amp; 接口"></a>抽象类 &amp; 接口</h3><p>抽象类除了不能实例化对象之外，类的其它功能和普通类一样。</p><p>由于抽象类不能实例化对象，所以抽象类必须被继承，才能被使用。也是因为这个原因，通常在设计阶段决定要不要设计抽象类。</p><p>父类包含了子类集合的常见的方法，但是由于父类本身是抽象的，所以不能使用这些方法。</p><p>在 Java 中抽象类表示的是一种继承关系，一个类只能继承一个抽象类，而一个类却可以实现多个接口。</p><h4 id="抽象类和接口的区别"><a href="#抽象类和接口的区别" class="headerlink" title="抽象类和接口的区别"></a>抽象类和接口的区别</h4><ul><li><p>共同点：接口和抽象类都是继承树的上层</p><ul><li><p>都是上层的抽象层</p></li><li><p>都不能被实例化</p></li><li><p>都能包含抽象的方法，这些抽象的方法用于描述类具备的功能，但是不比提供具体的实现</p></li><li><p>都可以有默认实现的方法（Java 8 可以用 <code>default</code> 关键字在接口中定义默认方法）</p></li></ul></li><li><p>区别：</p><ul><li>抽象类中可有非抽象的方法，可以代码复用；接口只能有抽象方法</li><li>一个类只能继承一个类，但是可以实现多个接口</li><li>接口中的成员变量只能是 <code>public static final</code> 类型的，不能被修改且必须有初始值，而抽象类的成员变量默认 default，可在子类中被重新定义，也可被重新赋值。</li></ul></li></ul><h4 id="访问修饰符"><a href="#访问修饰符" class="headerlink" title="访问修饰符"></a>访问修饰符</h4><ul><li>仅对本类可见 private</li><li>对所有类可见 public</li><li>对本包和所有子类可见 protected</li><li>对本包可见—默认 不需要修饰符</li></ul><h3 id="深拷贝-amp-浅拷贝"><a href="#深拷贝-amp-浅拷贝" class="headerlink" title="深拷贝 &amp; 浅拷贝"></a>深拷贝 &amp; 浅拷贝</h3><ul><li><strong>引用拷贝</strong>：两个不同的引用指向同一个对象。</li><li><strong>浅拷贝</strong>：浅拷贝会在堆上创建一个新的对象（区别于引用拷贝的一点），不过，如果原对象内部的属性是引用类型的话，浅拷贝会直接复制内部对象的引用地址，也就是说<strong>拷贝对象和原对象共用同一个内部对象</strong>。</li><li><strong>深拷贝</strong> ：深拷贝会<strong>完全复制整个对象</strong>，包括这个对象所包含的内部对象。</li></ul><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202207091112775.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202207091112775.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 浅拷贝</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Address <span class="title function_">clone</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (Address) <span class="built_in">super</span>.clone();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 深拷贝</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Person <span class="title function_">clone</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) <span class="built_in">super</span>.clone(); <span class="comment">// 拷贝对象</span></span><br><span class="line">        person.setAddress(person.getAddress().clone());</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Object-所有类的超类"><a href="#Object-所有类的超类" class="headerlink" title="Object: 所有类的超类"></a>Object: 所有类的超类</h3><p>可以使用 Object 类型的变量引用任何类型的对象：</p><p><code>Object obj = new Employee(&quot;Harry Hacker&quot;, 35000);</code></p><p>要想对其中的内容进行具体的操作， 还需要清楚对象的原始类型， 并进行相应的类型转换：</p><p><code>Employee e = (Employee) obj;</code></p><h4 id="hashcode"><a href="#hashcode" class="headerlink" title="hashcode()"></a>hashcode()</h4><ul><li>如果两个对象的 <code>hashCode</code> 值相等，那这两个对象不一定相等（哈希碰撞）。</li><li>如果两个对象的 <code>hashCode</code> 值相等并且 <code>equals()</code> 方法也返回 <code>true</code>，我们才认为这两个对象相等。</li><li>如果两个对象的 <code>hashCode</code> 值不相等，我们就可以直接认为这两个对象不相等。</li></ul><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><ul><li><code>String</code> 中的对象是不可变的，也就可以理解为常量，线程安全。</li><li><code>StringBuffer</code> 对方法加了同步锁或者对调用的方法加了同步锁，所以是线程安全的。</li><li><code>StringBuilder</code> 并没有对方法进行加同步锁，所以是非线程安全的。</li></ul><p><strong>对于三者使用的总结：</strong></p><ol><li>操作少量的数据: 适用 <code>String</code></li><li>单线程操作字符串缓冲区下操作大量数据: 适用 <code>StringBuilder</code></li><li>多线程操作字符串缓冲区下操作大量数据: 适用 <code>StringBuffer</code></li></ol><h2 id="范型"><a href="#范型" class="headerlink" title="范型"></a>范型</h2><p>编译器可以对泛型参数进行检测，并且通过泛型参数可以指定传入的对象类型。</p><h3 id="范型类"><a href="#范型类" class="headerlink" title="范型类"></a>范型类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//此处T可以随便写为任意标识，常见的如T、E、K、V等形式的参数常用于表示泛型</span></span><br><span class="line"><span class="comment">//在实例化泛型类时，必须指定T的具体类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generic</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Generic</span><span class="params">(T key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Generic&lt;Integer&gt; genericInteger = <span class="keyword">new</span> <span class="title class_">Generic</span>&lt;Integer&gt;(<span class="number">123456</span>);</span><br></pre></td></tr></table></figure><h3 id="范型接口"><a href="#范型接口" class="headerlink" title="范型接口"></a>范型接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Generator</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">method</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不指定类型实现接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeneratorImpl</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Generator</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定类型实现接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeneratorImpl</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Generator</span>&lt;String&gt;&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="范型方法"><a href="#范型方法" class="headerlink" title="范型方法"></a>范型方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> &lt; E &gt; <span class="keyword">void</span> <span class="title function_">printArray</span><span class="params">( E[] inputArray )</span> &#123;</span><br><span class="line">         <span class="keyword">for</span> ( E element : inputArray )&#123;</span><br><span class="line">            System.out.printf( <span class="string">&quot;%s &quot;</span>, element );</span><br><span class="line">         &#125;</span><br><span class="line">         System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建不同类型数组： Integer, Double 和 Character</span></span><br><span class="line">Integer[] intArray = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line">String[] stringArray = &#123; <span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span> &#125;;</span><br><span class="line">printArray( intArray  );</span><br><span class="line">printArray( stringArray  );</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Write Once, Run Anywhere!&lt;/p&gt;
&lt;p&gt;一些 Java 学习笔记。&lt;/p&gt;</summary>
    
    
    
    <category term="Programming Language" scheme="http://blog.sukiu.top/categories/Programming-Language/"/>
    
    <category term="Java" scheme="http://blog.sukiu.top/categories/Programming-Language/Java/"/>
    
    
    <category term="Java" scheme="http://blog.sukiu.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot 注解</title>
    <link href="http://blog.sukiu.top/Framework/SSM/Spring-Boot/"/>
    <id>http://blog.sukiu.top/Framework/SSM/Spring-Boot/</id>
    <published>2022-07-07T03:35:00.000Z</published>
    <updated>2022-07-11T04:59:00.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Spring Boot makes it easy to create stand-alone, production-grade Spring based Applications that you can “just run”…Most Spring Boot applications need very little Spring configuration.</p></blockquote><span id="more"></span>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Spring Boot makes it easy to create stand-alone, production-grade Spring based Applications that you can “just run”…Most Spring Boot applications need very little Spring configuration.&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Framework" scheme="http://blog.sukiu.top/categories/Framework/"/>
    
    <category term="SSM" scheme="http://blog.sukiu.top/categories/Framework/SSM/"/>
    
    
    <category term="SSM" scheme="http://blog.sukiu.top/tags/SSM/"/>
    
  </entry>
  
  <entry>
    <title>Spring MVC</title>
    <link href="http://blog.sukiu.top/Framework/SSM/Spring-MVC/"/>
    <id>http://blog.sukiu.top/Framework/SSM/Spring-MVC/</id>
    <published>2022-07-05T01:16:00.000Z</published>
    <updated>2022-07-05T01:24:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Spring MVC 提供了模型 - 视图 - 控制的体系结构和可以用来开发灵活、松散耦合的 web 应用程序的组件。</p><p>MVC 模式导致了应用程序的不同方面 (输入逻辑、业务逻辑和 UI 逻辑) 的分离，同时提供了在这些元素之间的松散耦合。</p><ul><li><p><strong>模型</strong>（model）：封装了应用程序数据，并且通常它们由 POJO 组成。</p></li><li><p><strong>视图</strong>（view）：主要用于呈现模型数据，并且通常它生成客户端的浏览器可以解释的 HTML 输出。</p></li><li><p><strong>控制器</strong>（controller）：主要用于处理用户请求，并且构建合适的模型并将其传递到视图呈现。</p></li></ul><span id="more"></span>]]></content>
    
    
    <summary type="html">&lt;p&gt;Spring MVC 提供了模型 - 视图 - 控制的体系结构和可以用来开发灵活、松散耦合的 web 应用程序的组件。&lt;/p&gt;
&lt;p&gt;MVC 模式导致了应用程序的不同方面 (输入逻辑、业务逻辑和 UI 逻辑) 的分离，同时提供了在这些元素之间的松散耦合。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;模型&lt;/strong&gt;（model）：封装了应用程序数据，并且通常它们由 POJO 组成。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;视图&lt;/strong&gt;（view）：主要用于呈现模型数据，并且通常它生成客户端的浏览器可以解释的 HTML 输出。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;控制器&lt;/strong&gt;（controller）：主要用于处理用户请求，并且构建合适的模型并将其传递到视图呈现。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Framework" scheme="http://blog.sukiu.top/categories/Framework/"/>
    
    <category term="SSM" scheme="http://blog.sukiu.top/categories/Framework/SSM/"/>
    
    
    <category term="SSM" scheme="http://blog.sukiu.top/tags/SSM/"/>
    
  </entry>
  
  <entry>
    <title>Spring</title>
    <link href="http://blog.sukiu.top/Framework/SSM/Spring/"/>
    <id>http://blog.sukiu.top/Framework/SSM/Spring/</id>
    <published>2022-07-05T01:08:00.000Z</published>
    <updated>2022-07-05T01:16:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Spring 是一个<strong>容器</strong>。</p><p>Spring 框架的目标是使 J2EE 开发变得更容易使用，通过启用基于 POJO 的编程模型来促进良好的编程实践。</p><span id="more"></span><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>轻量级：20 多个模块，每隔 jar 包基本小于 1M，核心包 3M 左右</li><li>面向接口编程：可拓展、可维护</li><li>AOP：面向切面编程，底层原理是动态代理。合并公共代码，单独开发</li><li>整合其他框架</li></ul><h3 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h3><ul><li>控制反转（IoC）：“解耦合”，通过依赖注入 DI（Dependency Injection）实现</li><li>面向切面编程（AOP）：“注入”，下面通过 AspectJ 实现</li></ul><h2 id="三层架构"><a href="#三层架构" class="headerlink" title="三层架构"></a>三层架构</h2><h3 id="非-Spring"><a href="#非-Spring" class="headerlink" title="非 Spring"></a>非 Spring</h3><ul><li><p>实体类</p></li><li><p>数据访问层 dao</p><ul><li><p>Mapper.java（接口） </p></li><li><p>MapperImpl.java（实现类）</p></li></ul></li><li><p>业务逻辑层</p><ul><li><p>Service.java（接口）</p></li><li><p>ServiceImpl.java（实现类）</p></li></ul></li><li><p>界面层 controller</p></li></ul><h3 id="Spring-接管"><a href="#Spring-接管" class="headerlink" title="Spring 接管"></a>Spring 接管</h3><p>不 new 对象，使用 IoC 在 <code>applicationContext.xml</code> 中创建，注意首先需要空构造方法和 <code>setXXX()</code>。</p><h2 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h2><p>IoC 是一种思想，由 Spring 容器进行对象创建和依赖注入，程序员直接使用。</p><ul><li><p>正转：程序员对象创建和依赖注入</p><p><code>Student stu = new Student()</code></p></li><li><p>反转：Spring 容器对象创建和依赖注入</p><p><code>&lt;bean id=&quot;stu&quot; class=&quot;…&quot;&gt;&lt;/bean&gt;</code></p></li></ul><h3 id="基于-XML"><a href="#基于-XML" class="headerlink" title="基于 XML"></a>基于 XML</h3><ul><li>创建对象：<code>&lt;bean id=&quot;stu&quot; class=&quot;…&quot;&gt;&lt;/bean&gt;</code></li><li>对象赋值：<ul><li>setter 注入：必须提供无参构造方法，必须提供 setXXX()<ul><li>简单类型注入：value 属性 <code>&lt;property name=&quot;age&quot; value=&quot;11&quot;/&gt;</code></li><li>引用类型注入：ref 属性 <code>&lt;property name=&quot;school&quot; ref=&quot;sch&quot;/&gt;</code></li></ul></li><li>构造方法注入：<ul><li>使用构造方法的参数名称：<code>&lt;constructor-arg name=&quot;school&quot; value=&quot;Hohai&quot;/&gt;</code></li><li>使用构造方法的参数下标：<code>&lt;constructor-arg index=&quot;0&quot; value=&quot;Hohai&quot;/&gt;</code></li><li>使用默认构造方法的参数顺序：<code>&lt;constructor-arg value=&quot;Hohai&quot;/&gt;</code></li></ul></li></ul></li></ul><h3 id="基于注解的-IoC"><a href="#基于注解的-IoC" class="headerlink" title="基于注解的 IoC"></a>基于注解的 IoC</h3><p>也称 DI，是 IoC 是具体实现的技术。即从 xml 换为注解 annotation。</p><ul><li><p>创建对象的注解</p><ul><li><code>@Component</code>：创建任意对象</li><li><code>@Controller</code>：创建控制器对象，接收用户请求，返回结果给客户端</li><li><code>@Service</code>：创建业务逻辑层对象，负责向下访问数据访问层，处理完毕返回结果给界面层</li><li><code>@Respository</code>：创建数据访问层对象，负责数据库增删改查操作</li></ul></li><li><p>依赖注入的注解</p><ul><li>值类型（8 种基本类型和 String）的注入<ul><li><code>@Value</code>：给简单类型注入值</li></ul></li><li>引用类型的注入<ul><li><code>@Autowired</code>：使用类型注入值，从整个 Bean 工厂搜索同源类型的对象进行注入<ul><li>同源：被注入的类型（Student 中的 School）与注入的类型<strong>完全相同&#x2F;父子&#x2F;接口和实现类</strong>的类型</li><li>父子类用下面的注解区别</li></ul></li><li><code>@Qualifier</code>：使用名称注入值，从整个 Bean 工厂搜索相同名称的对象进行注入<ul><li>需要上面那个注解，否则无法注入</li></ul></li></ul></li></ul><p><strong>要在 Spring 的核心配置文件中添加包扫描：</strong><code>&lt;context:component-scan base-package=&quot;top.sukiu.annotation&quot;/&gt;</code></p><ul><li>单个包扫描（推荐）：一个个包扫</li><li>多个包扫描：以逗号&#x2F;空格&#x2F;分号分隔</li><li>扫描根包（不推荐）</li></ul></li></ul><h2 id="AspectJ"><a href="#AspectJ" class="headerlink" title="AspectJ"></a>AspectJ</h2><p>一个优秀的面向切面的框架，拓展 Java 语言，提供强大的切面实现。</p><p><strong>切入点表达式：</strong><code>execution(访问权限 方法返回值 方法声明（参数）异常类型)</code>，简化后 <code>execution(方法返回值 方法声明（参数）</code></p><ul><li><code>*</code>：任意字符</li><li><code>..</code>：出现在<ul><li>方法声明的参数中：任意参数</li><li>路径中：本路径及其所有子路径</li></ul></li></ul><blockquote><p>例子：</p><p><code>execution(public * *(..))</code>：任意的公共方法</p><p><code>execution(* set*(..))</code>：任意以 set 开头的方法</p><p><code>execution(* com.xyz.service.impl.*.*(..))</code>：任意返回值类型，在此包任意类型的任意方法的任意参数</p></blockquote><p>常用的通知类型：</p><ul><li>前置通知 <code>@Before</code>：在目标方法执行前切入切面功能。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 前置通知规范：</span></span><br><span class="line"><span class="comment">* 1）权限public</span></span><br><span class="line"><span class="comment">* 2）返回值void</span></span><br><span class="line"><span class="comment">* 3）方法名自定义</span></span><br><span class="line"><span class="comment">* 4）方法无参数，有只能是JoinPoint类型（包含目标方法的签名和参数）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Before(value = &quot;execution(public * com.aspect.SomeServiceImpl.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myBefore</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;前置功能切入&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>后置通知 <code>@AfterReturning</code>：在目标方法执行后切入切面功能。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 后置通知规范：</span></span><br><span class="line"><span class="comment">* 1）权限public</span></span><br><span class="line"><span class="comment">* 2）返回值void</span></span><br><span class="line"><span class="comment">* 3）方法名自定义</span></span><br><span class="line"><span class="comment">* 4）方法有/无参数（一般有）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@AfterReturning(value = &quot;execution(public * com.aspect.SomeServiceImpl.*(..))&quot;, returning = &quot;obj&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myAfterReturning</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;后置功能切入&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 基本类型和String的返回值无法改变</span></span><br></pre></td></tr></table></figure></li><li>环绕通知 <code>@Around</code>：通过拦截目标方法，在前后增强功能的通知，功能强大，一般事务使用。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 环绕通知规范：</span></span><br><span class="line"><span class="comment">* 1）权限public</span></span><br><span class="line"><span class="comment">* 2）返回值 = 目标方法返回值</span></span><br><span class="line"><span class="comment">* 3）方法名自定义</span></span><br><span class="line"><span class="comment">* 4）方法有参数 = 目标方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="meta">@Around(value = &quot;execution(public * com.aspect.SomeServiceImpl.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">myAround</span><span class="params">(ProceedingJoinPoint p)</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">    <span class="comment">// 前置</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Before&quot;</span>);</span><br><span class="line">    <span class="comment">// 目标方法</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> p.proceed(p.getArgs());</span><br><span class="line">    <span class="comment">// 后置</span></span><br><span class="line">    System.out.println(<span class="string">&quot;After&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> obj.toString().toUpperCase();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 可以修改返回值</span></span><br></pre></td></tr></table></figure></li><li>最终通知 <code>@After</code>：无论目标方法是否正常执行，最终通知都会执行。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 最终通知规范：</span></span><br><span class="line"><span class="comment">* 1）权限public</span></span><br><span class="line"><span class="comment">* 2）返回值void</span></span><br><span class="line"><span class="comment">* 3）方法名自定义</span></span><br><span class="line"><span class="comment">* 4）方法无参数，有只能是JoinPoint类型（包含目标方法的签名和参数）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@After(value = &quot;execution(public * com.aspect.SomeServiceImpl.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myAfter</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;最终功能切入&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>定义切入点 <code>@Pointcut</code>：多个切面切入同一个切入点，起别名  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(value = &quot;execution(public * com.aspect.SomeServiceImpl.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myCut</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before(value = &quot;myCut()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myBefore</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;前置功能切入&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="JDK-x2F-CGLib-动态代理"><a href="#JDK-x2F-CGLib-动态代理" class="headerlink" title="JDK&#x2F;CGLib 动态代理"></a>JDK&#x2F;CGLib 动态代理</h3><p><code>applicationContext.xml</code> 中：</p><ul><li><code>&lt;aop:aspectj-autoproxy/&gt;</code>：默认 JDK 动态代理，必须使用接口类型</li><li><code>&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;/&gt;</code>：切换 CGLib 子类代理，可以用接口或者实现类</li></ul><blockquote><p><strong>一直用接口即可！！！</strong></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;Spring 是一个&lt;strong&gt;容器&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;Spring 框架的目标是使 J2EE 开发变得更容易使用，通过启用基于 POJO 的编程模型来促进良好的编程实践。&lt;/p&gt;</summary>
    
    
    
    <category term="Framework" scheme="http://blog.sukiu.top/categories/Framework/"/>
    
    <category term="SSM" scheme="http://blog.sukiu.top/categories/Framework/SSM/"/>
    
    
    <category term="SSM" scheme="http://blog.sukiu.top/tags/SSM/"/>
    
  </entry>
  
  <entry>
    <title>MyBatis</title>
    <link href="http://blog.sukiu.top/Framework/SSM/MyBatis/"/>
    <id>http://blog.sukiu.top/Framework/SSM/MyBatis/</id>
    <published>2022-06-30T08:48:10.000Z</published>
    <updated>2022-07-03T13:51:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>MyBatis 是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。</p><ul><li><p>免除了几乎所有的 <a href="https://blog.csdn.net/qq_43640009/article/details/106482059">JDBC</a> 代码以及设置参数和获取结果集的工作。</p></li><li><p>可以通过简单的 XML 或注解来配置和映射原始类型、接口和 Java POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录。</p></li></ul><span id="more"></span><h2 id="XML-配置"><a href="#XML-配置" class="headerlink" title="XML 配置"></a>XML 配置</h2><p>更多配置参考：<a href="https://mybatis.org/mybatis-3/zh/configuration.html">官方文档 XML配置项</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 读取数据库配置文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置日志输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注册实体类别名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 单个注册别名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">&quot;com.proj.Student&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;student&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 批量注册别名：类名的驼峰命名 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;package name=&quot;com.proj&quot;/&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- type：事务管理器</span></span><br><span class="line"><span class="comment">                JDBC：程序员管理</span></span><br><span class="line"><span class="comment">                MANAGED：Spring管理</span></span><br><span class="line"><span class="comment">            --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 数据库连接池 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注册mapper --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;StudentMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>数据库连接池：</p><p>一个中间层，初始化多个连接，建立连接从连接池取出，断开连接放回连接池，开销比直接连接断开小得多。</p></blockquote><h2 id="XML-映射"><a href="#XML-映射" class="headerlink" title="XML 映射"></a>XML 映射</h2><h3 id="占位符的区别"><a href="#占位符的区别" class="headerlink" title="占位符的区别"></a>占位符的区别</h3><ul><li><code>#&#123;&#125;</code>: 对非字符串参数的占位符，可以有效防止 SQL 注入<ul><li>入参是简单数据类型（除 String），<code>#&#123;&#125;</code> 内可以任意写</li><li>入参是对象类型，<code>#&#123;&#125;</code> 内必须是对象成员变量名称</li></ul></li><li><code>$&#123;&#125;</code>: 对字符串的拼接替换，可以替换列名和表名，存在 SQL 注入风险，尽量少用<ul><li>入参是基本数据类型（有 String），<code>$&#123;&#125;</code> 内必须是 <code>value</code></li><li>入参是对象类型，<code>$&#123;&#125;</code> 内必须是对象成员变量名称</li></ul></li></ul><blockquote><p><strong>使用 <code>#&#123;&#125;</code> 防止 SQL 注入：</strong></p><ol><li>遇到模糊查询需要拼接字符串时：<code>where name like &#39;%$&#123;name&#125;%&#39;</code></li><li>使用 <code>concat</code> 函数改为：<code>where name like concat(&#39;%&#39;,#&#123;name&#125;,&#39;%&#39;)</code></li></ol><p> <strong>字符串替换只能使用 <code>$&#123;&#125;</code></strong> ，详见下一节代码</p></blockquote><h3 id="创建映射配置文件"><a href="#创建映射配置文件" class="headerlink" title="创建映射配置文件"></a>创建映射配置文件</h3><p>更多配置参考：<a href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html">官方文档 XML映射器</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- namespace：命名空间（包名），用来区分不同文件中相同的id属性 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.proj.mapper.UsersMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 查询全部数据 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAll&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">        select id, username, birthday, sex, address</span><br><span class="line">        from users</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通过主键id查询 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">        select id, username, birthday, sex, address</span><br><span class="line">        from users</span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通过名称模糊查询 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getByName&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;string&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">        select id, username, birthday, sex, address</span><br><span class="line">        from users</span><br><span class="line">        where username like concat(&#x27;%&#x27;, #&#123;userName&#125;, &#x27;%&#x27;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 插入数据</span></span><br><span class="line"><span class="comment">         - 参数对应实体类属性</span></span><br><span class="line"><span class="comment">         - 获取插入后的主键id</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">order</span>=<span class="string">&quot;AFTER&quot;</span>&gt;</span></span><br><span class="line">            select last_insert_id()</span><br><span class="line">        <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line">        insert into users (username, birthday, sex, address)</span><br><span class="line">        values (#&#123;userName&#125;, #&#123;birthday&#125;, #&#123;sex&#125;, #&#123;address&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 按主键删除数据 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;delete&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">        delete</span><br><span class="line">        from users</span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 更新数据 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">        update users</span><br><span class="line">        set username=#&#123;userName&#125;,</span><br><span class="line">            birthday=#&#123;birthday&#125;,</span><br><span class="line">            sex=#&#123;sex&#125;,</span><br><span class="line">            address=#&#123;address&#125;</span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 参数超过一个参数就不写 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getByNameOrAddress&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">        select id, username, birthday, sex, address</span><br><span class="line">        from users</span><br><span class="line">        where $&#123;col&#125; like concat(&#x27;%&#x27;, #&#123;val&#125;, &#x27;%&#x27;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="测试使用"><a href="#测试使用" class="headerlink" title="测试使用"></a>测试使用</h3><p><strong>增删改需要 commit ！！！</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line">    SqlSession sqlSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openSqlSession</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 文件流读取核心配置文件</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;SqlMapConfig.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建SqlSessionFactory工厂</span></span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(in);</span><br><span class="line">        <span class="comment">// 取出sqlSession对象</span></span><br><span class="line">        sqlSession = factory.openSession();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeSqlSession</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 关闭sqlSession</span></span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 完成查询操作</span></span><br><span class="line">        List&lt;Student&gt; list = sqlSession.selectList(<span class="string">&quot;om.proj.mapper.UsersMapper&quot;</span>);</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">        <span class="comment">// 增删改需要commit</span></span><br><span class="line">        <span class="comment">// sqlSession.commit();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>动态代理后就不需要从 xml 中取出执行方法，通过统一的代理接口直接调用。</p><h3 id="创建代理接口"><a href="#创建代理接口" class="headerlink" title="创建代理接口"></a>创建代理接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.proj.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.proj.pojo.Users;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UsersMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Users&gt; <span class="title function_">getAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Users <span class="title function_">getById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Users&gt; <span class="title function_">getByName</span><span class="params">(String userName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(Users users)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">delete</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(Users users)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 多个参数使用@Param</span></span><br><span class="line">    List&lt;Users&gt; <span class="title function_">getByNameOrAddress</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;col&quot;)</span></span></span><br><span class="line"><span class="params">            String col,</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;val&quot;)</span></span></span><br><span class="line"><span class="params">            String val</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>更改为代理接口的 <code>reference</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- 修改前</span></span><br><span class="line"><span class="comment">    &lt;mapper resource=&quot;StudentMapper.xml&quot;/&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 单个注册 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">&quot;com.proj.mapper.UsersMapper&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 批量注册：推荐 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.proj.mapper&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="测试使用-1"><a href="#测试使用-1" class="headerlink" title="测试使用"></a>测试使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    SqlSession sqlSession;</span><br><span class="line">    UsersMapper usersMapper;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openSqlSession</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 文件流读取核心配置文件</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;SqlMapConfig.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建SqlSessionFactory工厂</span></span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(in);</span><br><span class="line">        <span class="comment">// 取出sqlSession对象</span></span><br><span class="line">        sqlSession = factory.openSession();</span><br><span class="line">        <span class="comment">// 动态代理对象</span></span><br><span class="line">        usersMapper = sqlSession.getMapper(UsersMapper.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeSqlSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭sqlSession</span></span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Users&gt; list = usersMapper.getAll();</span><br><span class="line">        list.forEach(System.out::println);   </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetByNameOrAddress</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//  List&lt;Users&gt; list1 = usersMapper.getByNameOrAddress(&quot;username&quot;,&quot;小&quot;);</span></span><br><span class="line">        <span class="comment">//  list1.forEach(System.out::println);</span></span><br><span class="line">        List&lt;Users&gt; list2= usersMapper.getByNameOrAddress(<span class="string">&quot;address&quot;</span>,<span class="string">&quot;市&quot;</span>);</span><br><span class="line">        list2.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="type">Users</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Users</span>(<span class="string">&quot;新增&quot;</span>, dateFormat.parse(<span class="string">&quot;2000-01-01&quot;</span>), <span class="string">&quot;1&quot;</span>, <span class="string">&quot;北京市&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> usersMapper.insert(u);</span><br><span class="line">        sqlSession.commit();</span><br><span class="line">        <span class="comment">// 获取主键</span></span><br><span class="line">        System.out.println(u.getId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="动态-SQL"><a href="#动态-SQL" class="headerlink" title="动态 SQL"></a>动态 SQL</h2><p>官方文档：<a href="https://mybatis.org/mybatis-3/zh/dynamic-sql.html">动态SQL</a></p><p>动态 SQL 使条件判断更为简单：</p><ul><li>定义代码片段</li><li>逻辑判断</li><li>循环（批量）处理</li></ul><h3 id="lt-sql-gt-和-lt-include-gt"><a href="#lt-sql-gt-和-lt-include-gt" class="headerlink" title="&lt;sql&gt; 和 &lt;include&gt;"></a><code>&lt;sql&gt;</code> 和 <code>&lt;include&gt;</code></h3><ul><li><code>&lt;sql&gt;</code>：定义代码片段</li><li><code>&lt;include&gt;</code>：使用代码片段。</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.proj.mapper.UsersMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义代码片段 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;allCols&quot;</span>&gt;</span></span><br><span class="line">        id, username, birthday, sex, address</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 查询全部数据 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAll&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">        select</span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;allCols&quot;</span>/&gt;</span></span><br><span class="line">        from users</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="lt-if-gt"><a href="#lt-if-gt" class="headerlink" title="&lt;if&gt;"></a><code>&lt;if&gt;</code></h3><ul><li><code>&lt;if&gt;</code>：条件判断</li></ul><h4 id="lt-where-gt"><a href="#lt-where-gt" class="headerlink" title="&lt;where&gt;"></a><code>&lt;where&gt;</code></h4><ul><li><code>&lt;where&gt;</code>：多条件拼接，在查删改使用</li></ul><p>多条件拼接：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getByCondition&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;users&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">       select</span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;allCols&quot;</span>/&gt;</span></span><br><span class="line">       from users</span><br><span class="line">       <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userName!=null and userName!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               and username like concat(&#x27;%&#x27;,##&#123;userName&#125;,&#x27;%&#x27;)</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;birthday!=null&quot;</span>&gt;</span></span><br><span class="line">               and birthday=##&#123;userName&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;sex!=null and sex!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               and sex=##&#123;sex&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;address!=null and address!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               and address like concat(&#x27;%&#x27;,##&#123;address&#125;,&#x27;%&#x27;)</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetByCondition</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Users</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Users</span>();</span><br><span class="line">    u.setSex(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    u.setUserName(<span class="string">&quot;小&quot;</span>);</span><br><span class="line">    List&lt;Users&gt; list = usersMapper.getByCondition(u);</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="lt-set-gt"><a href="#lt-set-gt" class="headerlink" title="&lt;set&gt;"></a><code>&lt;set&gt;</code></h4><ul><li><code>set</code>：有选择地进行更新处理，至少更新一列</li></ul><p>有选择地更新：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateBySet&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">       update users</span><br><span class="line">       <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userName!=null and userName!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               username=##&#123;userName&#125;,</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;birthday!=null&quot;</span>&gt;</span></span><br><span class="line">               birthday=##&#123;userName&#125;,</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;sex!=null and sex!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               sex=##&#123;sex&#125;,</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;address!=null and address!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               address=##&#123;address&#125;,</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">       where id = ##&#123;id&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateBySet</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Users</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Users</span>();</span><br><span class="line">    u.setId(<span class="number">3</span>);</span><br><span class="line">    u.setUserName(<span class="string">&quot;新名字&quot;</span>);</span><br><span class="line">    usersMapper.updateBySet(u);</span><br><span class="line">    sqlSession.commit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="lt-foreach-gt"><a href="#lt-foreach-gt" class="headerlink" title="&lt;foreach&gt;"></a><code>&lt;foreach&gt;</code></h3><ul><li><code>&lt;foreach&gt;</code>：循环遍历，完成循环条件查询，批量增删改</li></ul><p>批量操作：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getByIds&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">      select</span><br><span class="line">      <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;allCols&quot;</span>/&gt;</span></span><br><span class="line">      from users</span><br><span class="line">      where id in</span><br><span class="line">      <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;array&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">          ##&#123;item&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertBatch&quot;</span>&gt;</span></span><br><span class="line">      insert into users (username, birthday, sex, address)</span><br><span class="line">      values</span><br><span class="line">      <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;list&quot;</span> <span class="attr">item</span>=<span class="string">&quot;u&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">          (##&#123;u.userName&#125;, #&#123;u.birthday&#125;, #&#123;u.sex&#125;, #&#123;u.address&#125;)</span><br><span class="line">      <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetByIds</span><span class="params">()</span> &#123;</span><br><span class="line">    Integer[] array = &#123;<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>&#125;;</span><br><span class="line">    List&lt;Users&gt; list = usersMapper.getByIds(array);</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h4><p>允许多行操作：在 <code>jdbc.properties</code> 中的数据库 url 中添加 <code>&amp;allowMultiQueries=true</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateBySet&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;list&quot;</span> <span class="attr">item</span>=<span class="string">&quot;u&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;;&quot;</span>&gt;</span></span><br><span class="line">      update users</span><br><span class="line">      <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;u.userName!=null and u.userName!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">              username=#&#123;u.userName&#125;,</span><br><span class="line">          <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;u.birthday!=null&quot;</span>&gt;</span></span><br><span class="line">              birthday=#&#123;u.userName&#125;,</span><br><span class="line">          <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;u.sex!=null and u.sex!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">              sex=#&#123;u.sex&#125;,</span><br><span class="line">          <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;u.address!=null and u.address!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">              address=#&#123;u.address&#125;,</span><br><span class="line">          <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">      where id = #&#123;u.id&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><h4 id="入参多个"><a href="#入参多个" class="headerlink" title="入参多个"></a>入参多个</h4><p>入参多个，可以指定参数位置传参，是实体类包含不住的条件。</p><p>实体类只能封装成员变量的条件，如果某个成员变量有区间范围的判断，或有两个值处理，则实体类无法包含。</p><p>根据生日范围查询：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    List&lt;Users&gt; getByBirthday(Date begin, Date end);</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getByBirthday&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">       select</span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;allCols&quot;</span>/&gt;</span></span><br><span class="line">       from users</span><br><span class="line">       where birthday between #&#123;arg0&#125; and #&#123;arg1&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>也可以和动态代理里一样，用 <code>@param</code> 区分参数</p></blockquote><h4 id="入参-Map"><a href="#入参-Map" class="headerlink" title="入参 Map"></a>入参 Map</h4><p>入参超过 1 个以上，使用 map 封装查询条件，查询条件更明确。</p><p><strong>map 的 key 和 xml 中的参数名对应</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      List&lt;Users&gt; getByMap(Map map);</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getByMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">       select</span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;allCols&quot;</span>/&gt;</span></span><br><span class="line">       from users</span><br><span class="line">       where birthday between #&#123;birthdayBegin&#125; and #&#123;birthdayEnd&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="返回-Map"><a href="#返回-Map" class="headerlink" title="返回 Map"></a>返回 Map</h4><p>如果返回的数据实体类无法包含，可以使用 map 返回多张表的数据，返回数据没有任何关系，都是 Object 类型。</p><p>返回的 map 的 key 是列名或别名。</p><p><strong>返回一行 map</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   Map getMap(Integer id);</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getMap&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">       select</span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;allCols&quot;</span>/&gt;</span></span><br><span class="line">       from users</span><br><span class="line">       where id=#&#123;id&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetResultMap</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> usersMapper.getMap(<span class="number">1</span>);</span><br><span class="line">    System.out.println(map);</span><br><span class="line">    System.out.println(map.get(<span class="string">&quot;username&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>返回多行 map</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   List&lt;Map&gt; getMulMap();</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getMulMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">       select</span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;allCols&quot;</span>/&gt;</span></span><br><span class="line">       from users</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="resultMap"><a href="#resultMap" class="headerlink" title="resultMap"></a>resultMap</h2><p>使用 <code>resultMap</code> 手动完成映射：</p><ul><li><code>property</code>：实体类成员变量名</li><li><code>column</code>：数据库列名</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;myMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;users&quot;</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 主键绑定 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 非主键绑定 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">column</span>=<span class="string">&quot;username&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   List&lt;Users&gt; getAllMap();</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllMap&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;myMap&quot;</span>&gt;</span></span><br><span class="line">       select id, username</span><br><span class="line">       from users</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetAllMap</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Users&gt; list = usersMapper.getAllMap();</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/* 没绑定的为空值</span></span><br><span class="line"><span class="comment">Users&#123;id=1, userName=&#x27;王五&#x27;, birthday=null, sex=&#x27;null&#x27;, address=&#x27;null&#x27;&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h3 id="一对多关系"><a href="#一对多关系" class="headerlink" title="一对多关系"></a>一对多关系</h3><p>一个老师有多个学生，假定</p><ul><li>老师：<code>id</code>、<code>name</code>、<code>studentList</code></li><li>学生：<code>id</code>、<code>name</code></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">&lt;!-- 绑定老师 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;teacherMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;teachers&quot;</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 主键绑定 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 非主键绑定 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 外键关联 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;studentList&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;students&quot;</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 绑定学生 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="多对一关系"><a href="#多对一关系" class="headerlink" title="多对一关系"></a>多对一关系</h3><p>学生对应绑定的老师，假定</p><ul><li>老师：<code>id</code>、<code>name</code>、<code>studentList</code></li><li>学生：<code>id</code>、<code>name</code>、<code>teacher</code></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">&lt;!-- 绑定学生 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;studentMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;students&quot;</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 主键绑定 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 非主键绑定 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 外键关联 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;teacher&quot;</span>&gt;</span> <span class="comment">&lt;!-- javaType是方法返回值类型 --&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 绑定老师 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><code>studentList</code> 不用绑定，否则循环绑死</p></blockquote><h3 id="一对一关系"><a href="#一对一关系" class="headerlink" title="一对一关系"></a>一对一关系</h3><p>一个班级对应一个班级，一个班级对应一个老师。</p><p><strong>用 <code>association</code></strong></p><h3 id="多对多关系"><a href="#多对多关系" class="headerlink" title="多对多关系"></a>多对多关系</h3><p>一个文章对应多个标签，一个标签对应多个文章，两个表就是多对多关系。</p><p>通过建立中间表处理多对多关联。</p><p><strong>用 <code>collection</code></strong></p><blockquote><p>无论什么关联关系：</p><ul><li>一方持有另一方的集合，使用 <code>&lt;collection&gt;</code></li><li>一方持有另一方的对象，使用 <code>&lt;association&gt;</code></li></ul></blockquote><h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>简而言之，多个 CRUD 操作对应一个事务操作。</p><p>在 MyBatis 框架中设置事务：</p><ul><li><code>&lt;transactionManager type=&quot;JDBC&quot;/&gt;</code>：程序员自己控制提交和回滚</li></ul><p>可设置为自动提交：</p><ul><li><code>sqlSession = factory.openSession(true);</code>：默认是 false，手动提交之后不需要手动 commit</li></ul><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>Mybatis 提供两级缓存：一级缓存和二级缓存，默认开启一级缓存。</p><h3 id="查询流程"><a href="#查询流程" class="headerlink" title="查询流程"></a>查询流程</h3><p>缓存查询流程：</p><ol><li>查询先查缓存，如果没有则查询数据库，存在缓存中，再返回给客户端</li><li>下次访问相同查询时，直接从缓存返回</li><li>如果数据库发生 commit 操作，则清空缓存</li></ol><h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><ul><li>一级缓存：使用 <code>sqlSession</code> 的作用域，同一个 <code>sqlSession</code> 共享一级缓存的数据</li><li>二级缓存：使用 <code>mapper</code> 的作用域，不同 <code>sqlSession</code> 只要访问同一个 <code>mapper.xml</code> 文件，则共享二级缓存的数据。</li></ul><blockquote><p>ORM（Object Relational Mapping）即对象关系映射：</p><p>Java 语言中以对象的方式操作数据，数据库中以表的方式存储，对象中的成员变量与表中的列之间的数据互换。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;MyBatis 是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;免除了几乎所有的 &lt;a href=&quot;https://blog.csdn.net/qq_43640009/article/details/106482059&quot;&gt;JDBC&lt;/a&gt; 代码以及设置参数和获取结果集的工作。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;可以通过简单的 XML 或注解来配置和映射原始类型、接口和 Java POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Framework" scheme="http://blog.sukiu.top/categories/Framework/"/>
    
    <category term="SSM" scheme="http://blog.sukiu.top/categories/Framework/SSM/"/>
    
    
    <category term="MyBatis" scheme="http://blog.sukiu.top/tags/MyBatis/"/>
    
    <category term="SSM" scheme="http://blog.sukiu.top/tags/SSM/"/>
    
  </entry>
  
  <entry>
    <title>代理模式</title>
    <link href="http://blog.sukiu.top/System-Design/Design-Pattern/Proxy-Pattern/"/>
    <id>http://blog.sukiu.top/System-Design/Design-Pattern/Proxy-Pattern/</id>
    <published>2022-06-30T02:23:00.000Z</published>
    <updated>2022-06-30T02:31:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>目标对象不可访问，通过代理对象增强访问。</p><ul><li>控制目标对象的访问</li><li>增强功能</li></ul><span id="more"></span><h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>具备以下特点：</p><ul><li>目标对象和代理对象实现同一个业务接口</li><li>目标对象必须实现接口</li><li>代理对象在程序<strong>运行前</strong>就已经存在</li><li>能过灵活进行目标对象的切换，却无法进行功能的灵活处理</li></ul><p>流程实现：</p><ul><li><code>Service</code>：接口</li><li><code>Some implements Service</code>：目标对象</li><li><code>Agent implements Service</code>：代理对象<ul><li>在其中创建目标对象实现具体功能</li></ul></li></ul><blockquote><p>面向接口编程：</p><ul><li>类中成员变量 设计为接口</li><li>方法的形参 设计为接口</li><li>方法的返回值 设计为接口</li><li>调用时接口指向实现类</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 静态代理拆分</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Agent</span> <span class="keyword">implements</span> <span class="title class_">Servcie</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设计成员变量类型为接口，为了灵活切换目标对象</span></span><br><span class="line">    <span class="keyword">public</span> Servcie target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用构造方法传入目标对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Agent</span><span class="params">(Servcie target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 切面</span></span><br><span class="line">            System.out.println(<span class="string">&quot;事务开启&quot;</span>);</span><br><span class="line">            <span class="comment">// 业务</span></span><br><span class="line">            target.buy();</span><br><span class="line">            <span class="comment">// 切面</span></span><br><span class="line">            System.out.println(<span class="string">&quot;事务提交&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;事务回滚&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>代理对象在程序运行的过程中在内存构建，可以灵活的进行业务功能的切换。</p><h3 id="JDK-动态代理"><a href="#JDK-动态代理" class="headerlink" title="JDK 动态代理"></a>JDK 动态代理</h3><ul><li>目标对象必须实现业务接口</li><li>代理对象不必实现业务接口</li><li>动态代理的对象在程序运行前不存在，在运行时动态地在内存构建</li><li>动态代理能够灵活进行业务功能的切换</li><li>非接口中的方法不能被代理</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyFactory</span> &#123;</span><br><span class="line">    <span class="comment">// 类中的成员变量接口</span></span><br><span class="line">    Service target;</span><br><span class="line">    <span class="comment">// 传入目标对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProxyFactory</span><span class="params">(Service target)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回动态代理对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getAgent</span><span class="params">(AOP aop)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">                <span class="comment">// 类加载器</span></span><br><span class="line">                target.getClass().getClassLoader(),</span><br><span class="line">                <span class="comment">// 目标对象实现的所有接口</span></span><br><span class="line">                target.getClass().getInterfaces(),</span><br><span class="line">                <span class="comment">// 代理功能实现</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(</span></span><br><span class="line"><span class="params">                          Object proxy,      // 代理对象 </span></span><br><span class="line"><span class="params">                          Method method, // 目标方法</span></span><br><span class="line"><span class="params">                          Object[] args  // 目标方法的参数</span></span><br><span class="line"><span class="params">                    )</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// 切面</span></span><br><span class="line">                            aop.before();</span><br><span class="line">                            <span class="comment">// 业务</span></span><br><span class="line">                            obj = method.invoke(target, args);</span><br><span class="line">                            <span class="comment">// 切面</span></span><br><span class="line">                            aop.after();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="comment">// 切面</span></span><br><span class="line">                            aop.exception();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> obj;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CGLib-动态代理"><a href="#CGLib-动态代理" class="headerlink" title="CGLib 动态代理"></a>CGLib 动态代理</h3><p>又称子类代理，通过动态地在内存中构建子类对象，重写父类的方法进行代理功能的增强。</p><blockquote><p>如果目标对象没有实现接口，则只能通过 CSLib 子类代理进行功能增强。</p></blockquote><p>子类代理是对象字节码框架 ASM 实现，一般通过 Spring 这些框架直接使用。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;目标对象不可访问，通过代理对象增强访问。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;控制目标对象的访问&lt;/li&gt;
&lt;li&gt;增强功能&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="System Design" scheme="http://blog.sukiu.top/categories/System-Design/"/>
    
    <category term="Design Pattern" scheme="http://blog.sukiu.top/categories/System-Design/Design-Pattern/"/>
    
    
    <category term="Patterns" scheme="http://blog.sukiu.top/tags/Patterns/"/>
    
  </entry>
  
  <entry>
    <title>Go项目测试</title>
    <link href="http://blog.sukiu.top/Programming-Language/Go/Go-Test/"/>
    <id>http://blog.sukiu.top/Programming-Language/Go/Go-Test/</id>
    <published>2022-06-17T13:59:55.000Z</published>
    <updated>2022-06-25T08:38:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>测试关系着系统的质量，质量则决定线上系统的稳定性。</p><span id="more"></span><p>测试自顶向下分为：</p><ul><li>回归测试：由 QA 手动通过终端回归一些固定的主流程场景</li><li>集成测试：对系统功能维度做测试验证</li><li>单元测试：对单独的函数、模块做功能验证</li></ul><blockquote><p>从顶向下，覆盖率逐层增加，成本逐层降低</p><p>单元测试的覆盖率一定程度上决定了代码的质量</p></blockquote><h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;测试关系着系统的质量，质量则决定线上系统的稳定性。&lt;/p&gt;</summary>
    
    
    
    <category term="Programming Language" scheme="http://blog.sukiu.top/categories/Programming-Language/"/>
    
    <category term="Go" scheme="http://blog.sukiu.top/categories/Programming-Language/Go/"/>
    
    
    <category term="Go" scheme="http://blog.sukiu.top/tags/Go/"/>
    
    <category term="Test" scheme="http://blog.sukiu.top/tags/Test/"/>
    
  </entry>
  
  <entry>
    <title>CloudFlare Worker搭建随机图片API</title>
    <link href="http://blog.sukiu.top/Mixed/Random-Image-Worker/"/>
    <id>http://blog.sukiu.top/Mixed/Random-Image-Worker/</id>
    <published>2022-06-17T04:30:00.000Z</published>
    <updated>2022-06-17T04:30:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前在 CSDN 上发表过 <a href="https://blog.csdn.net/qq_43640009/article/details/107945584">制作自己的随机图API，快速、稳定、简易！</a>，主要通过一个简单的 php 脚本部署在服务器上。</p><p>这次通过 CloudFlare Worker 实现一个完全无成本的随机图片 API！</p><span id="more"></span><h2 id="图片转-Webp"><a href="#图片转-Webp" class="headerlink" title="图片转 Webp"></a>图片转 Webp</h2><p>这步骤可选，转换为 webp 格式后，图片体积压缩而分辨率不变，可以更快地加载。</p><p>为了在引用时方便，先把名称按 1、2、3…顺序标号，再通过 <code>PIL</code> 库，将 <code>jpg</code> 和 <code>png</code> 格式的图片转换成 <code>webp</code>。</p><blockquote><p>因为用了文件名按数字排序，所以原始图片需要全为数字，如为其他自行修改代码</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_webp</span>(<span class="params">src_dir, dist_dir, img</span>):</span><br><span class="line">    img_path = os.path.join(src_dir, img)</span><br><span class="line">    dist_path = os.path.join(dist_dir, img.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;.webp&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(dist_path):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    image = Image.<span class="built_in">open</span>(img_path)</span><br><span class="line">    image.save(dist_path, <span class="built_in">format</span>=<span class="string">&quot;webp&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(img_path + <span class="string">&#x27; convert to &#x27;</span> + dist_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert</span>(<span class="params">src_dir, dist_dir</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Convert: start&quot;</span>)</span><br><span class="line">    images = os.listdir(src_dir)</span><br><span class="line">    images.sort(key=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x[:-<span class="number">4</span>]))</span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> images:</span><br><span class="line">        to_webp(src_dir, dist_dir, img)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Convert: end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rename</span>(<span class="params">dir_path</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Rename: start&quot;</span>)</span><br><span class="line">    num = <span class="number">1</span></span><br><span class="line">    files = os.listdir(dir_path)</span><br><span class="line">    files.sort(key=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x[:-<span class="number">4</span>]))</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        src_path = os.path.join(dir_path, file)</span><br><span class="line">        dist_path = os.path.join(dir_path, <span class="built_in">str</span>(num)) + os.path.splitext(file)[-<span class="number">1</span>]</span><br><span class="line">        num = num + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> src_path == dist_path:</span><br><span class="line">            <span class="comment"># print(&quot;Skip: &quot; + src_path)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        os.rename(src_path, dist_path)</span><br><span class="line">        <span class="built_in">print</span>(src_path + <span class="string">&#x27; rename to &#x27;</span> + dist_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Rename: end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    srcDir = <span class="string">r&quot;E:\Onedrive\图片\次元壁纸&quot;</span></span><br><span class="line">    distDir = <span class="string">&#x27;pc&#x27;</span></span><br><span class="line"></span><br><span class="line">    rename(srcDir)</span><br><span class="line">    convert(srcDir, distDir)</span><br></pre></td></tr></table></figure><h2 id="文件上传-Github"><a href="#文件上传-Github" class="headerlink" title="文件上传 Github"></a>文件上传 Github</h2><p>这步骤不具体说了，图片通过 <code>jsdeliver</code> 引用。</p><h2 id="CloudFlare-Worker"><a href="#CloudFlare-Worker" class="headerlink" title="CloudFlare Worker"></a>CloudFlare Worker</h2><p>新建一个 worker，代码参考如下：</p><ul><li>因为改了文件名，所以下面只需要修改图片总数 <code>total</code>，就能生成一个随机数访问</li><li>个人通过 <code>type</code> 区别宽屏和竖屏图片，自己按需修改</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    event.<span class="title function_">respondWith</span>(</span><br><span class="line">        <span class="title function_">handleRequest</span>(event.<span class="property">request</span>).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&#x27;cfworker error:\n&#x27;</span> + err.<span class="property">stack</span>, &#123;</span><br><span class="line">                <span class="attr">status</span>: <span class="number">502</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleRequest</span>(<span class="params">request</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(request.<span class="property">url</span>);</span><br><span class="line">    <span class="keyword">switch</span> (url.<span class="property">pathname</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;/img&quot;</span>:</span><br><span class="line">            <span class="keyword">var</span> type = url.<span class="property">searchParams</span>.<span class="title function_">has</span>(<span class="string">&quot;type&quot;</span>) ? url.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;type&quot;</span>) : <span class="string">&quot;pc&quot;</span>;</span><br><span class="line">            <span class="keyword">const</span> total = <span class="title function_">getTotal</span>(type);</span><br><span class="line">            <span class="keyword">if</span> (total == <span class="number">0</span>) <span class="keyword">return</span> <span class="title function_">handleImage</span>(<span class="string">&quot;pc&quot;</span>, <span class="title function_">getTotal</span>(<span class="string">&quot;pc&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">handleImage</span>(type, total);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;/favicon.ico&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://cdn.jsdelivr.net/gh/SukiEva/assets/blog/favicon.ico&quot;</span>);</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">handleNotFound</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getTotal</span>(<span class="params">type</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;pc&quot;</span>: <span class="keyword">return</span> <span class="number">175</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;mb&quot;</span>: <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="attr">default</span>: <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleImage</span>(<span class="params">type, total</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> index = <span class="title class_">Math</span>.<span class="title function_">floor</span>((<span class="title class_">Math</span>.<span class="title function_">random</span>() * total)) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> img = <span class="string">&quot;https://cdn.jsdelivr.net/gh/SukiEva/assets/webp/&quot;</span> + type + <span class="string">&quot;/&quot;</span> + index + <span class="string">&quot;.webp&quot;</span>;</span><br><span class="line">    res = <span class="keyword">await</span> <span class="title function_">fetch</span>(img);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(res.<span class="property">body</span>, &#123;</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;image/webp&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleNotFound</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&#x27;Not Found&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="number">404</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义域名"><a href="#自定义域名" class="headerlink" title="自定义域名"></a>自定义域名</h2><p>默认是一个 CF 的域名，但是目前已经被国内 ban 了，需要自行添加域名路由。</p><ul><li>添加 DNS A 解析到 <code>2.2.2.2</code>，我配置的 <code>api</code> 三级域名</li><li>在 Worker 里面配置路由，比如我的就是 <code>api.sukiu.top/img*</code></li></ul><p>可以通过下面的链接查看实现效果，每天的免费次数是 10w 次，请自行搭建，禁止滥用！！！</p><div class="tag link"><a class="link-card" title="SukiEva 的随机图片 API" href="https://api.sukiu.top/img"><div class="left"><img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/256/safari.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">SukiEva 的随机图片 API</p><p class="url">https://api.sukiu.top/img</p></div></a></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;之前在 CSDN 上发表过 &lt;a href=&quot;https://blog.csdn.net/qq_43640009/article/details/107945584&quot;&gt;制作自己的随机图API，快速、稳定、简易！&lt;/a&gt;，主要通过一个简单的 php 脚本部署在服务器上。&lt;/p&gt;
&lt;p&gt;这次通过 CloudFlare Worker 实现一个完全无成本的随机图片 API！&lt;/p&gt;</summary>
    
    
    
    <category term="Mixed" scheme="http://blog.sukiu.top/categories/Mixed/"/>
    
    
    <category term="CloudFlare Worker" scheme="http://blog.sukiu.top/tags/CloudFlare-Worker/"/>
    
  </entry>
  
  <entry>
    <title>《图解HTTP》笔记</title>
    <link href="http://blog.sukiu.top/Computer-Basics/Computer-Network/Graphic-Http-Notes/"/>
    <id>http://blog.sukiu.top/Computer-Basics/Computer-Network/Graphic-Http-Notes/</id>
    <published>2022-03-06T05:36:00.000Z</published>
    <updated>2022-03-06T05:36:00.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>本书图文并茂，大量图片穿插文中，生动形象地向读者介绍每一个应用案例，减少了读者阅读时的枯燥感。</p><p>借助一张张配图，读者们不仅会加深视觉记忆，在轻松愉悦的氛围中，还可以更深刻地理解通信机 制等背后的工作原理。</p><p>正所谓一图胜千文。</p></blockquote><span id="more"></span><h2 id="HTTP-协议"><a href="#HTTP-协议" class="headerlink" title="HTTP 协议"></a>HTTP 协议</h2><h3 id="请求-x2F-响应通信"><a href="#请求-x2F-响应通信" class="headerlink" title="请求&#x2F;响应通信"></a>请求&#x2F;响应通信</h3><p>请求报文由<strong>请求方法、请求 URI、协议版本、可选的请求首部字段和内容实体</strong>构成。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061347720.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061347720.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>响应报文由<strong>协议版本、状态码（原因短语）、可选的响应首部字段和主体</strong>构成。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061349516.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061349516.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><h3 id="不保存状态"><a href="#不保存状态" class="headerlink" title="不保存状态"></a>不保存状态</h3><p>HTTP 是一种不保存状态，即无状态（stateless）协议。</p><p>HTTP 协议自身不对请求和响应之间的通信状态进行保存，协议对于发送过的请求或响应都不做持久化处理。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061351286.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061351286.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h3 id="HTTP-方法"><a href="#HTTP-方法" class="headerlink" title="HTTP 方法"></a>HTTP 方法</h3><h4 id="GET：获取资源"><a href="#GET：获取资源" class="headerlink" title="GET：获取资源"></a>GET：获取资源</h4><p>GET 方法用来请求访问已被 URI 识别的资源。</p><p>指定的资源经服务器端解析后返回响应内容。</p><blockquote><p>如果请求的资源是文本，那就保持原样返回；</p><p>如果是像 CGI（Common Gateway Interface，通用网关接 口）那样的程序，则返回经过执行后的输出结果。</p></blockquote><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061355943.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061355943.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h4 id="POST：传输实体主体"><a href="#POST：传输实体主体" class="headerlink" title="POST：传输实体主体"></a>POST：传输实体主体</h4><p>POST 方法用来传输实体的主体。</p><p>虽然用 GET 方法也可以传输实体的主体，但一般不用 GET 方法进行 传输，而是用 POST 方法。</p><p>虽说 POST 的功能与 GET 很相似，但 POST 的主要目的并不是获取响应的主体内容。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061356954.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061356954.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h4 id="PUT：传输文件"><a href="#PUT：传输文件" class="headerlink" title="PUT：传输文件"></a>PUT：传输文件</h4><p>PUT 方法用来传输文件。</p><p>就像 FTP 协议的文件上传一样，要求在请求报文的主体中包含文件内容，然后保存到请求 URI 指定的位置。</p><p>但是，鉴于 HTTP&#x2F;1.1 的 PUT 方法自身不带验证机制，任何人都可以上传文件 , 存在安全性问题，因此一般的 Web 网站不使用该方法。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061359052.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061359052.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h4 id="HEAD：获得报文首部"><a href="#HEAD：获得报文首部" class="headerlink" title="HEAD：获得报文首部"></a>HEAD：获得报文首部</h4><p>HEAD 方法和 GET 方法一样，只是不返回报文主体部分。</p><p>用于确认 URI 的有效性及资源更新的日期时间等。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061359184.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061359184.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h4 id="DELETE：删除文件"><a href="#DELETE：删除文件" class="headerlink" title="DELETE：删除文件"></a>DELETE：删除文件</h4><p>DELETE 方法用来删除文件，是与 PUT 相反的方法。</p><p>DELETE 方法按请求 URI 删除指定的资源。</p><p>但是，HTTP&#x2F;1.1 的 DELETE 方法本身和 PUT 方法一样不带验证机制，所以一般的 Web 网站也不使用 DELETE 方法。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061400518.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061400518.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><h4 id="OPTIONS：询问支持的方法"><a href="#OPTIONS：询问支持的方法" class="headerlink" title="OPTIONS：询问支持的方法"></a>OPTIONS：询问支持的方法</h4><p>OPTIONS 方法用来查询针对请求 URI 指定的资源支持的方法。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061406769.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061406769.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h4 id="TRACE：追踪路径"><a href="#TRACE：追踪路径" class="headerlink" title="TRACE：追踪路径"></a>TRACE：追踪路径</h4><p>TRACE 方法是让 Web 服务器端将之前的请求通信环回给客户端的方法。</p><p>发送请求时，在 Max-Forwards 首部字段中填入数值，每经过一个服务器端就将该数字减 1，当数值刚好减到 0 时，就停止继续传输，最后接收到请求的服务器端则返回状态码 200 OK 的响应。</p><p>但是，TRACE 方法本来就不怎么常用，再加上它容易引发 XST（Cross-Site Tracing，跨站追踪）攻击，通常就更不会用到了。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061402888.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061402888.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h4 id="CONNECT：要求用隧道协议连接代理"><a href="#CONNECT：要求用隧道协议连接代理" class="headerlink" title="CONNECT：要求用隧道协议连接代理"></a>CONNECT：要求用隧道协议连接代理</h4><p>CONNECT 方法要求在与代理服务器通信时建立隧道，实现用隧道协议进行 TCP 通信。</p><p>主要使用 SSL（Secure Sockets Layer，安全套接层）和 TLS（Transport Layer Security，传输层安全）协议把通信内容加密后经网络隧道传输。</p><p>格式：<code>CONNECT 代理服务器名: 端口号 HTTP 版本</code></p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061404359.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061404359.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h3 id="持久连接"><a href="#持久连接" class="headerlink" title="持久连接"></a>持久连接</h3><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061407328.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061407328.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220306140731254" style="zoom: 67%;" /><p>为解决上述 TCP 连接的问题，HTTP&#x2F;1.1 和一部分的 HTTP&#x2F;1.0 想出了持久连接（HTTP Persistent Connections，也称为 HTTP keep-alive 或 HTTP connection reuse）的方法。</p><p>持久连接的特点是，<strong>只要任意一端没有明确提出断开连接，则保持 TCP 连接状态</strong>。</p><p>在 HTTP&#x2F;1.1 中，所有的连接默认都是持久连接。</p><h4 id="管线化-Pipelining"><a href="#管线化-Pipelining" class="headerlink" title="管线化 Pipelining"></a>管线化 Pipelining</h4><p>持久连接使得多数请求以管线化（pipelining）方式发送成为可能。</p><p>从前发送请求后需等待并收到响应，才能发送下一个请求。管线化技术出现后，不用等待响应亦可直接发送下一个请求。</p><p>这样就能够做到同时<strong>并行发送多个请求</strong>，而不需要一个接一个地等待响应了。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061410650.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061410650.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><h3 id="使用-COOKIE"><a href="#使用-COOKIE" class="headerlink" title="使用 COOKIE"></a>使用 COOKIE</h3><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061412524.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061412524.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><p>保留无状态协议这个特征的同时又要解决类似的矛盾问题，于是引入了 Cookie 技术。Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。</p><ul><li>Cookie 会根据从服务器端发送的响应报文内的一个叫做 Set-Cookie 的首部字段信息，通知客户端保存 Cookie。当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值后发送出去。</li><li>服务器端发现客户端发送过来的 Cookie 后，会去检查究竟是从哪一个客户端发来的连接请求，然后对比服务器上的记录，最后得到之前的状态信息。</li></ul><table>    <tr>        <td><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061414206.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061414206.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="  /></td>        <td><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061415535.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061415535.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="  /></td>    </tr></table><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061417981.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061417981.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><h2 id="HTTP-报文"><a href="#HTTP-报文" class="headerlink" title="HTTP 报文"></a>HTTP 报文</h2><p>用于 HTTP 协议交互的信息被称为 HTTP 报文。请求端（客户端）的 HTTP 报文叫做请求报文，响应端（服务器端）的叫做响应报文。</p><p>HTTP 报文本身是由多行（用 CR+LF 作换行符）数据构成的字符串文本。</p><p>HTTP 报文大致可分为报文首部和报文主体两块。两者由最初出现的 空行（CR+LF）来划分。通常，并不一定要有报文主体。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061435574.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061435574.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><ul><li>请求行包含用于请求的方法，请求 URI 和 HTTP 版本。</li><li>状态行包含表明响应结果的状态码，原因短语和 HTTP 版本。</li><li>首部字段包含表示请求和响应的各种条件和属性的各类首部。</li></ul><h3 id="编码传输"><a href="#编码传输" class="headerlink" title="编码传输"></a>编码传输</h3><p>HTTP 在传输数据时可以按照数据原貌直接传输，但也可以在传输过 程中通过编码提升传输速率。但是，编码的操作需要计算机来完成，因此会消耗更多的 CPU 等资源。</p><h4 id="报文-x2F-实体主体"><a href="#报文-x2F-实体主体" class="headerlink" title="报文&#x2F;实体主体"></a>报文&#x2F;实体主体</h4><ul><li>报文（message）：HTTP 通信中的基本单位，由 8 位组字节流（octet sequence， 其中 octet 为 8 个比特）组成，通过 HTTP 通信传输。</li><li>实体（entity）：作为请求或响应的有效载荷数据（补充项）被传输，其内容由实体首部和实体主体组成。</li></ul><p>HTTP 报文的主体用于传输请求或响应的<strong>实体主体</strong>。</p><blockquote><p>通常，报文主体等于实体主体。</p><p>只有当传输中进行编码操作时，实体主体的<strong>内容发生变化</strong>，才导致它和报文主体产生差异。</p></blockquote><h4 id="压缩传输的内容编码"><a href="#压缩传输的内容编码" class="headerlink" title="压缩传输的内容编码"></a>压缩传输的内容编码</h4><p>向待发送邮件内增加附件时，为了使邮件容量变小，我们会先用 ZIP 压缩文件之后再添加附件发送。</p><p>HTTP 协议中有一种被称为内容编码的功能也能进行类似的操作。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061442983.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061442983.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><p>常用的内容编码有以下几种：</p><ul><li>gzip（GNU zip）</li><li>compress（UNIX 系统的标准压缩）</li><li>deflate（zlib）</li><li>identity（不进行编码）</li></ul><h4 id="分割发送的分块传输编码"><a href="#分割发送的分块传输编码" class="headerlink" title="分割发送的分块传输编码"></a>分割发送的分块传输编码</h4><p>在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面。</p><p>这种把实体主体分块的功能称为分块传输编码（Chunked Transfer Coding）。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061443064.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061443064.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><ul><li>分块传输编码会将实体主体分成多个部分（块）。每一块都会用十六 进制来标记块的大小，而实体主体的最后一块会使用“0(CR+LF)”来标记。</li><li>使用分块传输编码的实体主体会由接收的客户端负责解码，恢复到编码前的实体主体。</li></ul><p>HTTP&#x2F;1.1 中存在一种称为传输编码（Transfer Coding）的机制，它可以在通信时按某种编码方式传输，但只定义作用于分块传输编码中。</p><h3 id="对象集合"><a href="#对象集合" class="headerlink" title="对象集合"></a>对象集合</h3><p>发送邮件时，我们可以在邮件里写入文字并添加多份附件。</p><p>这是因为采用了 MIME（Multipurpose Internet Mail Extensions，多用途因特网邮件扩展）机制，它允许邮件处理文本、图片、视频等多个不同类型的数据。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061445336.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061445336.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>HTTP 协议中也采纳了多部分对象集合（Multipart），发送的一份报文主体内可含有多类型实体。通常是在图片或文本文件等上传时使用。</p><p>在 HTTP 报文中使用多部分对象集合时，需要在首部字段里加上 Content-type。</p><h3 id="获取部分内容的范围请求"><a href="#获取部分内容的范围请求" class="headerlink" title="获取部分内容的范围请求"></a>获取部分内容的范围请求</h3><p>如果下载过程中遇到网络中断的情况，那就必须重头开始。为了解决上述问题，需要一种可恢复的机制。所谓恢复是指能从之前下载中断处恢复下载。</p><p>要实现该功能需要指定下载的实体范围。像这样，指定范围发送的请求叫做范围请求（Range Request）。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061450934.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203061450934.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><p>执行范围请求时，会用到首部字段 Range 来指定资源的 byte 范围。</p><blockquote><p>针对范围请求，响应会返回状态码为 206 Partial Content 的响应报文。</p><p>另外，对于多重范围的范围请求，响应会在首部字段 ContentType 标明 multipart&#x2F;byteranges 后返回响应报文。</p></blockquote><h2 id="HTTP-协作"><a href="#HTTP-协作" class="headerlink" title="HTTP 协作"></a>HTTP 协作</h2><h3 id="通信数据转发"><a href="#通信数据转发" class="headerlink" title="通信数据转发"></a>通信数据转发</h3><p>HTTP 通信时，除客户端和服务器以外，还有一些用于通信数据转发的应用程序，例如代理、网关和隧道。它们可以配合服务器工作。</p><h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><p>代理是一种有转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062113232.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062113232.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>使用代理服务器的理由有：利用缓存技术（稍后讲解）减少网络带宽的流量，组织内部针对特定网站的访问控制，以获取访问日志为主要目的等等。</p><p>代理有多种使用方法，按两种基准分类。一种是是否使用缓存，另一种是是否会修改报文。</p><ul><li>缓存代理：代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本（缓存）保存在代理服务器上。当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回。</li><li>透明代理：转发请求或响应时，不对报文做任何加工的代理类型被称为透明代理（Transparent Proxy）。反之，对报文内容进行加工的代理被称为非透明代理。</li></ul><h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><p>网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062135522.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062135522.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>网关的工作机制和代理十分相似。而网关能使通信线路上的服务器提供非 HTTP 协议服务。</p><p>利用网关能提高通信的安全性，因为可以在客户端与网关之间的通信线路上加密以确保连接的安全。</p><p>比如，网关可以连接数据库，使用 SQL 语句查询数据。另外，在 Web 购物网站上进行信用卡结算时，网关可以和信用卡结算系统联动。</p><h4 id="隧道"><a href="#隧道" class="headerlink" title="隧道"></a>隧道</h4><p>隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。</p><p>隧道可按要求建立起一条与其他服务器的通信线路，届时使用 SSL 等加密手段进行通信。隧道的目的是确保客户端能与服务器进行安全的通信。</p><p>隧道本身不会去解析 HTTP 请求。也就是说，请求保持原样中转给之 后的服务器。隧道会在通信双方断开连接时结束。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062138636.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062138636.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><h3 id="保存资源的缓存"><a href="#保存资源的缓存" class="headerlink" title="保存资源的缓存"></a>保存资源的缓存</h3><p>缓存是指代理服务器或客户端本地磁盘内保存的资源副本。利用缓存可减少对源服务器的访问，因此也就节省了通信流量和通信时间。</p><p>缓存服务器是代理服务器的一种，并归类在缓存代理类型中。换句话说，当代理转发从服务器返回的响应时，代理服务器将会保存一份资源的副本。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062144618.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062144618.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><p>缓存服务器的优势在于利用缓存可避免多次从源服务器转发资源。因此客户端可就近从缓存服务器上获取资源，而源服务器也不必多次处理相同的请求了。</p><h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><h3 id="HTTP-缺点"><a href="#HTTP-缺点" class="headerlink" title="HTTP 缺点"></a>HTTP 缺点</h3><p>HTTP 主要有这些不足：</p><ul><li>通信使用明文（不加密），内容可能会被窃听</li><li>不验证通信方的身份，因此有可能遭遇伪装</li><li>无法证明报文的完整性，所以有可能已遭篡改</li></ul><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062156625.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062156625.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><h3 id="HTTP-加密-认证-完整性保护-x3D-HTTPS"><a href="#HTTP-加密-认证-完整性保护-x3D-HTTPS" class="headerlink" title="HTTP + 加密 + 认证 + 完整性保护 &#x3D; HTTPS"></a>HTTP + 加密 + 认证 + 完整性保护 &#x3D; HTTPS</h3><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062201021.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062201021.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><h4 id="HTTPS-是身披-SSL-外壳的-HTTP"><a href="#HTTPS-是身披-SSL-外壳的-HTTP" class="headerlink" title="HTTPS 是身披 SSL 外壳的 HTTP"></a>HTTPS 是身披 SSL 外壳的 HTTP</h4><p>HTTPS 并非是应用层的一种新协议。只是 HTTP 通信接口部分用 SSL（Secure Socket Layer）和 TLS（Transport Layer Security）协议代替而已。</p><p>通常，HTTP 直接和 TCP 通信。当使用 SSL 时，则演变成先和 SSL 通信，再由 SSL 和 TCP 通信了。简言之，所谓 HTTPS，其实就是身披 SSL 协议这层外壳的 HTTP。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062217085.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062217085.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><blockquote><p>SSL 是独立于 HTTP 的协议，所以不光是 HTTP 协议，其他运行在应用层的 SMTP 和 Telnet 等协议均可配合 SSL 协议使用。</p><p>可以说 SSL 是 当今世界上应用最为广泛的网络安全技术。</p></blockquote><h4 id="相互交换密钥的公开密钥加密技术"><a href="#相互交换密钥的公开密钥加密技术" class="headerlink" title="相互交换密钥的公开密钥加密技术"></a>相互交换密钥的公开密钥加密技术</h4><p>SSL 采用一种叫做公开密钥加密（Public-key cryptography）的加密处理方式。</p><p>近代的加密方法中加密算法是公开的，而密钥却是保密的。通过这种方式得以保持加密方法的安全性。</p><blockquote><p>对称加密：加密和解密同用一个密钥</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062221048.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062221048.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>非对称加密：公开密钥加密使用一对非对称的密钥。一把叫做私有密钥（private key），另一把叫做公开密钥（public key）</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062223969.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062223969.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /></blockquote><p>HTTPS 采用共享密钥加密和公开密钥加密两者并用的混合加密机制。</p><p>若密钥能够实现安全交换，那么有可能会考虑仅使用公开密钥加密来通信。但是公开密钥加密与共享密钥加密相比，其处理速度要慢。</p><p>所以应充分利用两者各自的优势，将多种方法组合起来用于通信。在交换密钥环节使用公开密钥加密方式，之后的建立通信交 换报文阶段则使用共享密钥加密方式。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062225654.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062225654.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><h4 id="证明公开密钥正确性的证书"><a href="#证明公开密钥正确性的证书" class="headerlink" title="证明公开密钥正确性的证书"></a>证明公开密钥正确性的证书</h4><p>遗憾的是，公开密钥加密方式还是存在一些问题的。那就是无法证明公开密钥本身就是货真价实的公开密钥。或许在公开密钥传输途中，真正的公开密钥已经被攻击者替换掉了。</p><p>为了解决上述问题，可以使用由数字证书认证机构（CA，Certificate Authority）和其相关机关颁发的公开密钥证书。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062230419.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062230419.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><h3 id="HTTPS-通信"><a href="#HTTPS-通信" class="headerlink" title="HTTPS 通信"></a>HTTPS 通信</h3><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062235169.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062235169.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><ul><li>步骤 1： 客户端通过发送 Client Hello 报文开始 SSL 通信。报文中包含客户端支持的 SSL 的指定版本、加密组件（Cipher Suite）列表（所使用的加密算法及密钥长度等）。</li><li>步骤 2： 服务器可进行 SSL 通信时，会以 Server Hello 报文作为应答。和客户端一样，在报文中包含 SSL 版本以及加密组件。服务器的加密组件内容是从接收到的客户端加密组件内筛选出来的。</li><li>步骤 3： 之后服务器发送 Certificate 报文。报文中包含公开密钥证书。</li><li>步骤 4： 最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的 SSL 握手协商部分结束。</li><li>步骤 5： SSL 第一次握手结束之后，客户端以 Client Key Exchange 报 文作为回应。报文中包含通信加密中使用的一种被称为 Pre-master secret 的随机密码串。该报文已用步骤 3 中的公开密钥进行加密。</li><li>步骤 6： 接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用 Pre-master secret 密钥加密。</li><li>步骤 7： 客户端发送 Finished 报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判定标准。</li><li>步骤 8： 服务器同样发送 Change Cipher Spec 报文。</li><li>步骤 9： 服务器同样发送 Finished 报文。</li><li>步骤 10： 服务器和客户端的 Finished 报文交换完毕之后，SSL 连接 就算建立完成。当然，通信会受到 SSL 的保护。从此处开始进行应用层协议的通信，即发送 HTTP 请求。</li><li>步骤 11： 应用层协议通信，即发送 HTTP 响应。</li><li>步骤 12： 最后由客户端断开连接。断开连接时，发送 close_notify 报文。上图做了一些省略，这步之后再发送 TCP FIN 报文来关闭与 TCP 的通信。</li></ul><h3 id="HTTPS-缺点"><a href="#HTTPS-缺点" class="headerlink" title="HTTPS 缺点"></a>HTTPS 缺点</h3><p>HTTPS 也存在一些问题，那就是当使用 SSL 时，它的处理速度会变慢。</p><p>SSL 的慢分两种：一种是指通信慢，另一种是指由于大量消耗 CPU 及内存等资源，导致处理速度变慢。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062239123.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203062239123.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><blockquote><p>如果是非敏感信息则使用 HTTP 通信，只有在包含个人信息等敏感数据时，才利用 HTTPS 加密通信。</p><p>特别是每当那些访问量较多的 Web 网站在进行加密处理时，它们所承担着的负载不容小觑。在进行加密处理时，并非对所有内容都进行加密处理，而是仅在那些需要信息隐藏时才会加密，以节约资源。</p><p>除此之外，想要节约购买证书的开销也是原因之一。</p></blockquote><h2 id="Web-攻击技术"><a href="#Web-攻击技术" class="headerlink" title="Web 攻击技术"></a>Web 攻击技术</h2><p>简单的 HTTP 协议本身并不存在安全性问题，因此协议本身几乎不会 成为攻击的对象。</p><p>应用 HTTP 协议的服务器和客户端，以及运行在服务器上的 Web 应用等资源才是攻击目标。</p><blockquote><p>从整体上看，HTTP 就是一个通用的单纯协议机制。因此它具备较多优势，但是在安全性方面则呈劣势。</p><ul><li>拿远程登录时会用到的 SSH 协议来说，SSH 具备协议级别的认证及会话管理等功能，HTTP 协议则没有。另外在架设 SSH 服务方面，任何人都可以轻易地创建安全等级高的服务，而 HTTP 即使已架设好服务器，但若想提供服务器基础上的 Web 应用，很多情况下都需要重新开发。</li><li>因此，开发者需要<strong>自行设计并开发认证及会话管理功能来满足 Web 应用的安全</strong>。而自行设计就意味着会出现各种形形色色的实现。结果，安全等级并不完备，可仍在运作的 Web 应用背后却隐藏着各种容易被攻击者滥用的安全漏洞的 Bug。</li></ul></blockquote><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203121042239.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203121042239.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><h3 id="攻击模式"><a href="#攻击模式" class="headerlink" title="攻击模式"></a>攻击模式</h3><ul><li><strong>以服务器为目标的主动攻击（active attack）</strong>：攻击者通过直接访问 Web 应用， 把攻击代码传入的攻击模式。由于该模式是直接针对服务器上的资源进行攻击，因此攻击者需要能够访问到那些资源。<ul><li>SQL 注入攻击</li><li>OS 命令注入攻击</li></ul></li></ul><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203121044184.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203121044184.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><ul><li><strong>以服务器为目标的被动攻击（passive attack）</strong>：利用圈套策略执行攻击代码的攻击模式。在被动攻击过程中，攻击者不直接对目标 Web 应用访问发起攻击。<ul><li>跨站脚本攻击</li><li>跨站点请求伪造</li></ul></li></ul><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203121046510.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203121046510.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" />]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;本书图文并茂，大量图片穿插文中，生动形象地向读者介绍每一个应用案例，减少了读者阅读时的枯燥感。&lt;/p&gt;
&lt;p&gt;借助一张张配图，读者们不仅会加深视觉记忆，在轻松愉悦的氛围中，还可以更深刻地理解通信机 制等背后的工作原理。&lt;/p&gt;
&lt;p&gt;正所谓一图胜千文。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Computer Basics" scheme="http://blog.sukiu.top/categories/Computer-Basics/"/>
    
    <category term="Computer Network" scheme="http://blog.sukiu.top/categories/Computer-Basics/Computer-Network/"/>
    
    
    <category term="HTTP" scheme="http://blog.sukiu.top/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>Redis设计与实现</title>
    <link href="http://blog.sukiu.top/Database/Redis/Redis-Pro/"/>
    <id>http://blog.sukiu.top/Database/Redis/Redis-Pro/</id>
    <published>2022-03-03T04:02:00.000Z</published>
    <updated>2022-03-03T04:02:00.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>《Redis 设计与实现》一书全面而完整地讲解了 Redis 的内部运行机制， 对 Redis 的大多数单机功能以及所有多机功能的实现原理进行了介绍， 展示了这些功能的核心数据结构以及关键的算法思想。</p></blockquote><span id="more"></span><h2 id="底层数据结构"><a href="#底层数据结构" class="headerlink" title="底层数据结构"></a>底层数据结构</h2><h3 id="简单动态字符串"><a href="#简单动态字符串" class="headerlink" title="简单动态字符串"></a>简单动态字符串</h3><blockquote><ul><li>Redis 只会使用 C 字符串作为字面量， 在大多数情况下， Redis 使用 SDS （Simple Dynamic String，简单动态字符串）作为字符串表示。</li><li>比起 C 字符串， SDS 具有以下优点：<ol><li>常数复杂度获取字符串长度。</li><li>杜绝缓冲区溢出。</li><li>减少修改字符串长度时所需的内存重分配次数。</li><li>二进制安全。</li><li>兼容部分 C 字符串函数。</li></ol></li></ul></blockquote><p>Redis 没有直接使用 C 语言传统的字符串表示（以空字符结尾的字符数组）， 而是自己构建了一种名为简单动态字符串（simple dynamic string，SDS）的抽象类型， 并将 SDS 用作 Redis 的默认字符串表示，是一个可以被修改的字符串值。</p><blockquote><p>在 Redis 里面， C 字符串只会作为字符串字面量（string literal）， 用在一些无须对字符串值进行修改的地方， 比如打印日志</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">redis&gt; </span><span class="language-bash">SET msg <span class="string">&quot;hello world&quot;</span></span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li>键值对的键是一个字符串对象， 对象的底层实现是一个保存着字符串 <code>&quot;msg&quot;</code> 的 SDS 。</li><li>键值对的值也是一个字符串对象， 对象的底层实现是一个保存着字符串 <code>&quot;hello world&quot;</code> 的 SDS 。</li></ul><h4 id="底层实现"><a href="#底层实现" class="headerlink" title="底层实现"></a>底层实现</h4><p>每个 <code>sds.h/sdshdr</code> 结构表示一个 SDS 值：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sdshdr</span> &#123;</span><br><span class="line">    <span class="comment">// 记录 buf 数组中已使用字节的数量</span></span><br><span class="line">    <span class="comment">// 等于 SDS 所保存字符串的长度</span></span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="comment">// 记录 buf 数组中未使用字节的数量</span></span><br><span class="line">    <span class="type">int</span> free;</span><br><span class="line">    <span class="comment">// 字节数组，用于保存字符串</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>一个 SDS 示例：</p><ul><li><code>free</code> 属性的值为 <code>0</code> ， 表示这个 SDS 没有分配任何未使用空间。</li><li><code>len</code> 属性的值为 <code>5</code> ， 表示这个 SDS 保存了一个五字节长的字符串。</li><li><code>buf</code> 属性是一个 <code>char</code> 类型的数组， 数组的前五个字节分别保存了 <code>&#39;R&#39;</code> 、 <code>&#39;e&#39;</code> 、 <code>&#39;d&#39;</code> 、 <code>&#39;i&#39;</code> 、 <code>&#39;s&#39;</code> 五个字符， 而最后一个字节则保存了空字符 <code>&#39;\0&#39;</code>（有需要时重用 <code>&lt;string.h&gt;</code> 函数库） 。</li></ul><img src="https://box.kancloud.cn/2015-09-13_55f50d7faffa3.png" class="lazyload" data-srcset="https://box.kancloud.cn/2015-09-13_55f50d7faffa3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="SDS"  /><blockquote><p>SDS 遵循 C 字符串以空字符结尾的惯例， 保存空字符的 <code>1</code> 字节空间不计算在 SDS 的 <code>len</code> 属性里面， 并且为空字符分配额外的 <code>1</code> 字节空间， 以及添加空字符到字符串末尾等操作都是由 SDS 函数自动完成的， 所以这个空字符对于 SDS 的使用者来说是完全透明的。</p><p>遵循空字符结尾这一惯例的好处是， SDS 可以直接重用一部分 C 字符串函数库里面的函数。</p><p>如果有个指针 s 指向 SDS，那么可以通过 <code>printf(&quot;%s&quot;, s-&gt;buf);</code> 打印</p></blockquote><p>下面这个 SDS 为 <code>buf</code> 数组分配了五字节未使用空间， 所以它的 <code>free</code> 属性的值为 <code>5</code></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203031221680.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203031221680.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="未使用空间SDS"></p><h4 id="SDS-与-C-字符串的区别"><a href="#SDS-与-C-字符串的区别" class="headerlink" title="SDS 与 C 字符串的区别"></a>SDS 与 C 字符串的区别</h4><p>C 语言使用长度为 <code>N+1</code> 的字符数组来表示长度为 <code>N</code> 的字符串， 并且字符数组的最后一个元素总是空字符 <code>&#39;\0&#39;</code></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203031223573.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203031223573.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="C字符串"></p><p>以上并不能满足 Redis 对字符串在安全性、效率、以及功能方面的要求：</p><p>SDS 通过未使用空间解除了字符串长度和底层数组长度之间的关联：</p><p>在 SDS 中， <code>buf</code> 数组的长度不一定就是字符数量加一， 数组里面可以包含未使用的字节， 而这些字节的数量就由 SDS 的 <code>free</code> 属性记录。</p><blockquote><p>对于 C 字符串：</p><ul><li><p>如果程序执行的是增长字符串的操作， 比如拼接操作（append）， 那么在执行这个操作之前， 程序需要先通过内存重分配来扩展底层数组的空间大小 —— 如果忘了这一步就会产生<strong>缓冲区溢出</strong>。</p></li><li><p>如果程序执行的是缩短字符串的操作， 比如截断操作（trim）， 那么在执行这个操作之后， 程序需要通过内存重分配来释放字符串不再使用的那部分空间 —— 如果忘了这一步就会产生<strong>内存泄漏</strong>。</p></li></ul><p>Redis 作为数据库， 经常被用于速度要求严苛、数据被频繁修改的场合， 如果每次修改字符串的长度都需要执行一次内存重分配的话， 那么光是执行内存重分配的时间就会占去修改字符串所用时间的一大部分， 如果这种修改频繁地发生的话， 可能还会对性能造成影响。</p><ul><li><strong>空间预分配</strong>：优化 SDS 的字符串增长操作，程序不仅会为 SDS 分配修改所必须要的空间， 还会为 SDS 分配额外的未使用空间。</li><li><strong>惰性空间释放</strong>：优化 SDS 的字符串缩短操作，程序并不立即使用内存重分配来回收缩短后多出来的字节， 而是使用 <code>free</code> 属性将这些字节的数量记录起来， 并等待将来使用。</li></ul></blockquote><table><thead><tr><th>C 字符串</th><th>SDS</th></tr></thead><tbody><tr><td>获取字符串长度的复杂度为&nbsp;O(N)&nbsp;</td><td>获取字符串长度的复杂度为&nbsp;O(1)&nbsp;</td></tr><tr><td>API 是不安全的，可能会造成缓冲区溢出</td><td>API 是安全的，不会造成缓冲区溢出，自动将 SDS 的空间扩展至执行修改所需的大小</td></tr><tr><td>修改字符串长度&nbsp;<code>N</code>&nbsp; 次<b>必然</b>需要执行&nbsp;<code>N</code>&nbsp; 次内存重分配</td><td>修改字符串长度&nbsp;<code>N</code>&nbsp; 次<b>最多</b>需要执行&nbsp;<code>N</code>&nbsp; 次内存重分配。</td></tr><tr><td>只能保存文本数据</td><td>可以保存文本或者二进制数据，以处理二进制的方式来处理 SDS 存放在 buf 数组里的数据，</td></tr><tr><td>可以使用所有&nbsp;<code>&lt;string.h&gt;</code>&nbsp; 库中的函数</td><td>可以使用一部分&nbsp;<code>&lt;string.h&gt;</code>&nbsp; 库中的函数</td></tr></tbody></table><h3 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h3><blockquote><ul><li>链表被广泛用于实现 Redis 的各种功能， 比如列表键， 发布与订阅， 慢查询， 监视器， 等等。</li><li>每个链表节点由一个 <code>listNode</code> 结构来表示， 每个节点都有一个指向前置节点和后置节点的指针， 所以 Redis 的链表实现是双端链表。</li><li>每个链表使用一个 <code>list</code> 结构来表示， 这个结构带有表头节点指针、表尾节点指针、以及链表长度等信息。</li><li>因为链表表头节点的前置节点和表尾节点的后置节点都指向 <code>NULL</code> ， 所以 Redis 的链表实现是无环链表。</li><li>通过为链表设置不同的类型特定函数， Redis 的链表可以用于保存各种不同类型的值。</li></ul></blockquote><h4 id="底层实现-1"><a href="#底层实现-1" class="headerlink" title="底层实现"></a>底层实现</h4><p>每个链表节点使用一个 <code>adlist.h/listNode</code> 结构来表示，即一个双向链表：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">listNode</span> &#123;</span><br><span class="line">    <span class="comment">// 前置节点</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">listNode</span> *prev;</span><br><span class="line">    <span class="comment">// 后置节点</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">listNode</span> *next;</span><br><span class="line">    <span class="comment">// 节点的值</span></span><br><span class="line">    <span class="type">void</span> *value;</span><br><span class="line">&#125; listNode;</span><br></pre></td></tr></table></figure><p>使用 <code>adlist.h/list</code> 来持有链表的话， 操作起来会更方便：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">list</span> &#123;</span><br><span class="line">    <span class="comment">// 表头节点</span></span><br><span class="line">    listNode *head;</span><br><span class="line">    <span class="comment">// 表尾节点</span></span><br><span class="line">    listNode *tail;</span><br><span class="line">    <span class="comment">// 链表所包含的节点数量</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line">    <span class="comment">// 节点值复制函数</span></span><br><span class="line">    <span class="type">void</span> *(*dup)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="comment">// 节点值释放函数</span></span><br><span class="line">    <span class="built_in">void</span> (*free)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="comment">// 节点值对比函数</span></span><br><span class="line">    <span class="built_in">int</span> (*match)(<span class="type">void</span> *ptr, <span class="type">void</span> *key);</span><br><span class="line">&#125; list;</span><br></pre></td></tr></table></figure><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203031244834.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203031244834.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="list 结构 " style="zoom: 80%;" /><h4 id="链表特性"><a href="#链表特性" class="headerlink" title="链表特性"></a>链表特性</h4><p>Redis 的链表实现的特性可以总结如下：</p><ul><li>双端： 链表节点带有 <code>prev</code> 和 <code>next</code> 指针， 获取某个节点的前置节点和后置节点的复杂度都是 $O(1)$。</li><li>无环： 表头节点的 <code>prev</code> 指针和表尾节点的 <code>next</code> 指针都指向 <code>NULL</code> ， 对链表的访问以 <code>NULL</code> 为终点。</li><li>带表头指针和表尾指针： 通过 <code>list</code> 结构的 <code>head</code> 指针和 <code>tail</code> 指针， 程序获取链表的表头节点和表尾节点的复杂度为 $O(1)$。</li><li>带链表长度计数器： 程序使用 <code>list</code> 结构的 <code>len</code> 属性来对 <code>list</code> 持有的链表节点进行计数， 程序获取链表中节点数量的复杂度为 $O(1)$。</li><li>多态： 链表节点使用 <code>void*</code> 指针来保存节点值， 并且可以通过 <code>list</code> 结构的 <code>dup</code> 、 <code>free</code> 、 <code>match</code> 三个属性为节点值设置类型特定函数， 所以链表可以用于保存各种不同类型的值。</li></ul><h3 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h3><blockquote><ul><li>字典被广泛用于实现 Redis 的各种功能， 其中包括数据库和哈希键。</li><li>Redis 中的字典使用<strong>哈希表</strong>作为底层实现， 每个字典带有两个哈希表， 一个用于平时使用， 另一个仅在进行 rehash 时使用。</li><li>当字典被用作数据库的底层实现， 或者哈希键的底层实现时， Redis 使用 MurmurHash2 算法来计算键的哈希值。</li><li>哈希表使用<strong>链地址法</strong>来解决键冲突， 被分配到同一个索引上的多个键值对会连接成一个单向链表。</li><li>在对哈希表进行扩展或者收缩操作时， 程序需要将现有哈希表包含的所有键值对 rehash 到新哈希表里面， 并且这个 rehash 过程并不是一次性地完成的， 而是渐进式地完成的。</li></ul></blockquote><h4 id="底层实现-2"><a href="#底层实现-2" class="headerlink" title="底层实现"></a>底层实现</h4><p>Redis 字典所使用的哈希表由 <code>dict.h/dictht</code> 结构定义：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dictht</span> &#123;</span><br><span class="line">    <span class="comment">// 哈希表数组</span></span><br><span class="line">    <span class="comment">// 数组中的每个元素都是一个指向 dict.h/dictEntry 结构的指针， 每个 dictEntry 结构保存着一个键值对。</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="comment">// 哈希表大小</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="comment">// 哈希表大小掩码，用于计算索引值</span></span><br><span class="line">    <span class="comment">// 总是等于 size - 1</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sizemask;</span><br><span class="line">    <span class="comment">// 该哈希表已有节点的数量</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> used;</span><br><span class="line">&#125; dictht;</span><br></pre></td></tr></table></figure><p>哈希表节点使用 <code>dictEntry</code> 结构表示， 每个 <code>dictEntry</code> 结构都保存着一个键值对：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dictEntry</span> &#123;</span><br><span class="line">    <span class="comment">// 键</span></span><br><span class="line">    <span class="type">void</span> *key;</span><br><span class="line">    <span class="comment">// 值</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="type">void</span> *val;</span><br><span class="line">        <span class="type">uint64_t</span> u64;</span><br><span class="line">        <span class="type">int64_t</span> s64;</span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="comment">// 指向下个哈希表节点，形成链表</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dictEntry</span> *next;</span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure><p>Redis 中的字典由 <code>dict.h/dict</code> 结构表示：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dict</span> &#123;</span><br><span class="line">    <span class="comment">// 类型特定函数</span></span><br><span class="line">    dictType *type;</span><br><span class="line">    <span class="comment">// 私有数据</span></span><br><span class="line">    <span class="type">void</span> *privdata;</span><br><span class="line">    <span class="comment">// 哈希表</span></span><br><span class="line">    <span class="comment">// 一般只使用ht[0]；ht[1] 哈希表只会在对 ht[0] 哈希表进行 rehash 时使用。</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// rehash 索引</span></span><br><span class="line">    <span class="comment">// 当 rehash 不在进行时，值为 -1</span></span><br><span class="line">    <span class="type">int</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052058867.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052058867.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 67%;" /><h4 id="哈希算法"><a href="#哈希算法" class="headerlink" title="哈希算法"></a>哈希算法</h4><p>Redis 计算哈希值和索引值的方法如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用字典设置的哈希函数，计算键 key 的哈希值</span></span><br><span class="line">hash = dict-&gt;type-&gt;hashFunction(key);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用哈希表的 sizemask 属性和哈希值，计算出索引值</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据情况不同， ht[x] 可以是 ht[0] 或者 ht[1]</span></span><br><span class="line">index = hash &amp; dict-&gt;ht[x].sizemask;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">假设计算得出的哈希值为 8 ， 那么程序会继续使用语句：</span></span><br><span class="line">index = hash &amp; dict-&gt;ht[0].sizemask = 8 &amp; 3 = 0;</span><br></pre></td></tr></table></figure><table><tr>    <td><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052105563.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052105563.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" /></td>    <td><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052104825.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052104825.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" /></td></tr></table><blockquote><p>当字典被用作数据库的底层实现， 或者哈希键的底层实现时， Redis 使用 MurmurHash2 算法来计算键的哈希值。</p><p>MurmurHash 算法最初由 Austin Appleby 于 2008 年发明， 这种算法的优点在于， 即使输入的键是有规律的， 算法仍能给出一个很好的随机分布性， 并且算法的计算速度也非常快。</p><p>MurmurHash 算法目前的最新版本为 MurmurHash3 ， 而 Redis 使用的是 MurmurHash2 ， 关于 MurmurHash 算法的更多信息可以参考该算法的主页： &lt;<a href="http://code.google.com/p/smhasher/">http://code.google.com/p/smhasher/</a>&gt; 。</p></blockquote><h4 id="哈希冲突"><a href="#哈希冲突" class="headerlink" title="哈希冲突"></a>哈希冲突</h4><p>Redis 的哈希表使用链地址法（separate chaining）（拉链法）来解决键冲突。</p><p>每个哈希表节点都有一个 <code>next</code> 指针， 多个哈希表节点可以用 <code>next</code> 指针构成一个单向链表， 被分配到同一个索引上的多个节点可以用这个单向链表连接起来， 这就解决了键冲突的问题。</p><p>因为 <code>dictEntry</code> 节点组成的链表没有指向链表表尾的指针， 所以为了速度考虑， 程序总是将新节点添加到链表的表头位置（复杂度为 $O(1)$)， 排在其他已有节点的前面。</p><img src="https://box.kancloud.cn/2015-09-13_55f512c4d7f99.png" class="lazyload" data-srcset="https://box.kancloud.cn/2015-09-13_55f512c4d7f99.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:67%;" /><h4 id="Rehash"><a href="#Rehash" class="headerlink" title="Rehash"></a>Rehash</h4><p>随着操作的不断执行， 哈希表保存的键值对会逐渐地增多或者减少， 为了让哈希表的负载因子（load factor）维持在一个合理的范围之内， 当哈希表保存的键值对数量太多或者太少时， 程序需要对哈希表的大小进行相应的扩展或者收缩。</p><p>扩展和收缩哈希表的工作可以通过执行 <strong>rehash （重新散列）</strong>操作来完成， Redis 对字典的哈希表执行 rehash 的步骤如下：</p><ol><li><p>为字典的 <code>ht[1]</code> 哈希表分配空间， 这个哈希表的空间大小取决于要执行的操作， 以及 <code>ht[0]</code> 当前包含的键值对数量 （也即是 <code>ht[0].used</code> 属性的值）：</p><pre><code> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- 如果执行的是扩展操作， 那么 `ht[1]` 的大小为第一个大于等于 `ht[0].used * 2` 的 $2^n$（`2` 的 `n` 次方幂）；</span><br><span class="line">- 如果执行的是收缩操作， 那么 `ht[1]` 的大小为第一个大于等于 `ht[0].used` 的 $2^n$。</span><br></pre></td></tr></table></figure></code></pre></li><li><p>将保存在 <code>ht[0]</code> 中的所有键值对 rehash 到 <code>ht[1]</code> 上面： rehash 指的是<strong>重新计算</strong>键的哈希值和索引值， 然后将键值对放置到 <code>ht[1]</code> 哈希表的指定位置上。</p></li><li><p>当 <code>ht[0]</code> 包含的所有键值对都迁移到了 <code>ht[1]</code> 之后 （<code>ht[0]</code> 变为空表）， 释放 <code>ht[0]</code> ， 将 <code>ht[1]</code> 设置为 <code>ht[0]</code> ， 并在 <code>ht[1]</code> 新创建一个空白哈希表， 为下一次 rehash 做准备。</p></li></ol><p>当以下条件中的任意一个被满足时， 程序会自动开始对哈希表执行扩展操作：</p><ol><li>服务器目前没有在执行 BGSAVE 命令或者 BGREWRITEAOF 命令， 并且哈希表的负载因子大于等于 <code>1</code></li><li>服务器目前正在执行 BGSAVE 命令或者 BGREWRITEAOF 命令， 并且哈希表的负载因子大于等于 <code>5</code></li></ol><p>其中哈希表的负载因子可以通过公式：<strong>负载因子 &#x3D; 哈希表已保存节点数量 &#x2F; 哈希表大小</strong></p><p>$load_factor &#x3D; ht[0].used  &#x2F;  ht[0].size$</p><blockquote><p>在执行 BGSAVE 命令或 BGREWRITEAOF 命令的过程中， Redis 需要创建当前服务器进程的子进程， 而大多数操作系统都采用写时复制（<a href="http://en.wikipedia.org/wiki/Copy-on-write">copy-on-write</a>）技术来优化子进程的使用效率。</p><p>所以在子进程存在期间， 服务器会提高执行扩展操作所需的负载因子， 从而尽可能地避免在子进程存在期间进行哈希表扩展操作， 这可以避免不必要的内存写入操作， 最大限度地节约内存。</p><p>另一方面， 当哈希表的负载因子小于 <code>0.1</code> 时， 程序自动开始对哈希表执行收缩操作。</p></blockquote><h4 id="渐进式-Rehash"><a href="#渐进式-Rehash" class="headerlink" title="渐进式 Rehash"></a>渐进式 Rehash</h4><blockquote><p>如果哈希表里保存的键值对数量是四百万、四千万甚至四亿个键值对， 那么要一次性将这些键值对全部 rehash 到 <code>ht[1]</code> 的话， 庞大的计算量可能会导致服务器在一段时间内停止服务。</p></blockquote><p>为了避免 rehash 对服务器性能造成影响， 服务器不是一次性将 <code>ht[0]</code> 里面的所有键值对全部 rehash 到 <code>ht[1]</code> ， 而是分多次、渐进式地将 <code>ht[0]</code> 里面的键值对慢慢地 rehash 到 <code>ht[1]</code> 。</p><p>以下是哈希表渐进式 rehash 的详细步骤：</p><ol><li>为 <code>ht[1]</code> 分配空间， 让字典同时持有 <code>ht[0]</code> 和 <code>ht[1]</code> 两个哈希表。</li><li>在字典中维持一个索引计数器变量 <code>rehashidx</code> ， 并将它的值设置为 <code>0</code> ， 表示 rehash 工作正式开始。</li><li>在 rehash 进行期间， 每次对字典执行添加、删除、查找或者更新操作时， 程序除了执行指定的操作以外， 还会顺带将 <code>ht[0]</code> 哈希表在 <code>rehashidx</code> 索引上的所有键值对 rehash 到 <code>ht[1]</code> ， 当 rehash 工作完成之后， 程序将 <code>rehashidx</code> 属性的值增一。</li><li>随着字典操作的不断执行， 最终在某个时间点上， <code>ht[0]</code> 的所有键值对都会被 rehash 至 <code>ht[1]</code> ， 这时程序将 <code>rehashidx</code> 属性的值设为 <code>-1</code> ， 表示 rehash 操作已完成。</li></ol><blockquote><p>在进行渐进式 rehash 的过程中， 字典会同时使用 <code>ht[0]</code> 和 <code>ht[1]</code> 两个哈希表， 所以在渐进式 rehash 进行期间， 字典的删除（delete）、查找（find）、更新（update）等操作会在两个哈希表上进行：</p><ul><li><p>要在字典里面查找一个键的话， 程序会先在 <code>ht[0]</code> 里面进行查找， 如果没找到的话， 就会继续到 <code>ht[1]</code> 里面进行查找， 诸如此类。</p></li><li><p>在渐进式 rehash 执行期间， 新添加到字典的键值对一律会被保存到 <code>ht[1]</code> 里面， 而 <code>ht[0]</code> 则不再进行任何添加操作： 这一措施保证了 <code>ht[0]</code> 包含的键值对数量会只减不增， 并随着 rehash 操作的执行而最终变成空表。</p></li></ul></blockquote><h3 id="跳表"><a href="#跳表" class="headerlink" title="跳表"></a>跳表</h3><blockquote><ul><li>跳跃表是<strong>有序集合</strong>的底层实现之一， 除此之外它在 Redis 中没有其他应用。</li><li>Redis 的跳跃表实现由 <code>zskiplist</code> 和 <code>zskiplistNode</code> 两个结构组成， 其中 <code>zskiplist</code> 用于保存跳跃表信息（比如表头节点、表尾节点、长度）， 而 <code>zskiplistNode</code> 则用于表示跳跃表节点。</li><li>每个跳跃表节点的层高都是 <code>1</code> 至 <code>32</code> 之间的随机数。</li><li>在同一个跳跃表中， 多个节点可以包含相同的分值， 但每个节点的成员对象必须是唯一的。</li><li>跳跃表中的节点按照分值大小进行排序， 当分值相同时， 节点按照成员对象的大小进行排序。</li></ul></blockquote><h4 id="底层实现-3"><a href="#底层实现-3" class="headerlink" title="底层实现"></a>底层实现</h4><p>跳跃表节点的实现由 <code>redis.h/zskiplistNode</code> 结构定义：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">zskiplistNode</span> &#123;</span><br><span class="line">    <span class="comment">// 后退指针</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">zskiplistNode</span> *backward;</span><br><span class="line">    <span class="comment">// 分值，节点按各自所保存的分值从小到大排列</span></span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line">    <span class="comment">// 成员对象</span></span><br><span class="line">    robj *obj;</span><br><span class="line">    <span class="comment">// 层</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">zskiplistLevel</span> &#123;</span><br><span class="line">        <span class="comment">// 前进指针：访问位于表尾方向的其他节点</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">zskiplistNode</span> *forward;</span><br><span class="line">        <span class="comment">// 跨度：记录了前进指针所指向节点和当前节点的距离</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">&#125; zskiplistNode;</span><br></pre></td></tr></table></figure><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052123925.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202203052123925.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><p><code>zskiplist</code> 结构的定义如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">zskiplist</span> &#123;</span><br><span class="line">    <span class="comment">// 表头节点和表尾节点</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">zskiplistNode</span> *header, *tail;</span><br><span class="line">    <span class="comment">// 表中节点的数量</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">    <span class="comment">// 表中层数最大的节点的层数</span></span><br><span class="line">    <span class="type">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;《Redis 设计与实现》一书全面而完整地讲解了 Redis 的内部运行机制， 对 Redis 的大多数单机功能以及所有多机功能的实现原理进行了介绍， 展示了这些功能的核心数据结构以及关键的算法思想。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Database" scheme="http://blog.sukiu.top/categories/Database/"/>
    
    <category term="Redis" scheme="http://blog.sukiu.top/categories/Database/Redis/"/>
    
    
    <category term="Redis" scheme="http://blog.sukiu.top/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>智力题</title>
    <link href="http://blog.sukiu.top/Mixed/Interview/Brain-Teaser/"/>
    <id>http://blog.sukiu.top/Mixed/Interview/Brain-Teaser/</id>
    <published>2022-02-25T08:04:00.000Z</published>
    <updated>2022-02-25T08:04:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>面试智力题汇总</p><span id="more"></span><h2 id="1000-瓶药水找毒药"><a href="#1000-瓶药水找毒药" class="headerlink" title="1000 瓶药水找毒药"></a>1000 瓶药水找毒药</h2><p>一共 1000 瓶药水，其中 1 瓶有毒药。</p><p>已知小白鼠喝毒药一天内死，若想在一天内找到毒药，最少需要几只小白鼠？</p><blockquote><p>答案：<strong>10 只</strong>。</p><p>解析：二进制思想。</p><p><code>0 000 000 001</code> 表示 1 号老鼠，喝了药水 1 。</p><p><code>0 000 000 010</code> 表示 2 号老鼠，喝了药水 2 。</p><p><code>0 000 000 011</code> 表示 1 号、 2 号老鼠，喝了药水 3 。</p><p>… …</p><p><code>1 111 101 000</code> 表示 4、6、7、8、9、10 号老鼠，喝了药水 1000。</p><p>按照上述的方法依次喝</p><p>第一回合，1 号老鼠喝药水 1</p><p>第二回合，2 号老鼠喝药水 2</p><p>…</p><p>第一千回合，4、6、7、8、9、10 号老鼠喝药水 1000</p><p>喝完一天时，看 10 只老鼠的状态，根据老鼠状态就知道哪瓶药水有毒了。</p><p>比如最后只是 2 号老鼠死了，那就说明第 2 瓶药水有毒；如果 4、6、7、8、9、10 死了，那就说明第 1000 瓶药水有毒！</p><p>想明白这个道理，再来看怎么答案为何是 10</p><p>我们需要让二进制表示的种类数&gt;&#x3D;药水总数（1000）</p><p>求的是最小值，显然，为 10 的时候满足要求</p><p>也可以这么计算：<code>⌈ log N ⌉</code>，log 底数为 2</p></blockquote><h2 id="抢-30"><a href="#抢-30" class="headerlink" title="抢 30"></a>抢 30</h2><p>抢 30 是双人游戏<br>游戏规则是：第一个人喊 “ 1 ”或 “ 2 ”，第二个人要接着往下喊一个或两个数，然后再轮到第一个人。</p><p>两人轮流进行下去。最后喊 30 的人获胜。问喊数字的最佳策略。</p><blockquote><p>答案：<strong>尽量喊 3 的倍数</strong>。</p><p>解析：倒着看，其实，喊 27 时，就决定胜负了。假设 A 喊了 27，B 只能喊 28 或 29 ，下个回合，A 一定可以喊 30。也就是说，喊 27 者必胜。</p><p>再倒着看，其实喊 24 时，就定胜负了。假设 A 喊了 24 ，B 只能喊 25 或 26 ，下个回合 A 一定能喊 27 。</p><p>由于喊 27 者必胜，因此喊 24 者也必胜。</p><p>同理可以推出：<strong>喊 3 的倍数者必胜</strong>。</p><p>然后就会发现，这个游戏，<strong>谁先喊，谁一定输</strong>。</p></blockquote><h2 id="灯泡开关"><a href="#灯泡开关" class="headerlink" title="灯泡开关"></a>灯泡开关</h2><p>一个圆环上有 100 个灯泡，灯泡有亮和暗两种状态。按一个灯泡的开关可以改变它和与它相邻两个灯泡的状态。</p><p>设计一种算法，对于任意初始状态，使所有灯泡全亮。</p><blockquote><p>将灯泡编号 1 ~ 100</p><p><strong>步骤一：将灯泡变为全亮或只剩一个为暗</strong></p><p>从 1 循环到 98 ，遇到暗的则按它<strong>下一个</strong>，使之变亮。循环完毕，1 ~ 98 必然全亮。99 和 100 可能为亮亮、暗亮、亮暗、暗暗四种状态。</p><ul><li>若为亮亮，皆大欢喜，满足题目要求</li><li>暗亮、亮暗，达到只剩一个为暗的状态；</li><li>若为暗暗。则按下编号 100 的灯泡，使编号 99 、100 变为亮，编号 1 的灯泡变为暗，从而达到只剩一个为暗的状态。</li></ul><p><strong>步骤二：将灯泡变为全暗</strong></p><p>由于灯泡环形摆放，我们指定暗的灯泡编号为 1 ，将剩下 99 个亮着的灯泡每 3 个为一组。按下每组中间的灯泡后，使得所有灯泡变为暗。</p><p><strong>步骤三：将灯泡变为全亮</strong></p><p>将所有灯泡按一下，灯泡变为全亮。</p></blockquote><h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>对于 N 个灯泡的任意初始状态 ( N &gt; 3 ) ，能否经过若干次操作使得所有灯泡全亮？</p><blockquote><p>N 个灯泡做分类讨论。</p><ol><li><code>N = 3*k+1</code> 一定可以。方法与上述步骤相同，在步骤二中可以将 3k 个亮的灯泡分为 k 组。</li><li><code>N = 3*k+2</code> 一定可以。将上述步骤一目标状态的只剩一个为暗改成<strong>剩两个相邻为暗</strong>，其余 3 * k 个灯泡分组按即可。因为，对于任意只剩一个为暗的状态，按下该灯泡左右任意一个就可以变成剩两个相邻为暗的状态！</li><li><code>N = 3*k</code> 不一定。如果经过上述步骤一可以将灯泡变成全亮的状态则有解；否则，无解。（该结论有待证明）</li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;面试智力题汇总&lt;/p&gt;</summary>
    
    
    
    <category term="Mixed" scheme="http://blog.sukiu.top/categories/Mixed/"/>
    
    <category term="Interview" scheme="http://blog.sukiu.top/categories/Mixed/Interview/"/>
    
    
    <category term="Interview" scheme="http://blog.sukiu.top/tags/Interview/"/>
    
  </entry>
  
  <entry>
    <title>Go的设计模式</title>
    <link href="http://blog.sukiu.top/System-Design/Design-Pattern/Go-Design-Pattern/"/>
    <id>http://blog.sukiu.top/System-Design/Design-Pattern/Go-Design-Pattern/</id>
    <published>2022-02-23T03:19:00.000Z</published>
    <updated>2022-02-23T03:19:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Go 语言的设计模式之美。</p><span id="more"></span><p>Go 的设计模式：❌指在 Go 中不常用</p><ul><li>创建型<ul><li>单例模式：一个类只有一个实例<ul><li>饿汉：系统初始化时创建并初始化单例对象</li><li>懒汉：调用实例时初始化单例对象</li></ul></li><li>工厂模式：使用共同接口创建对象</li><li>建造者模式：与工厂不同在于，创建参数复杂的对象</li><li>原型模式：利用已有对象复制的方式来创建新的对象 ❌</li></ul></li><li>结构型<ul><li>代理模式：为其他对象提供⼀种代理以控制这个对象的访问 <strong>代理访问</strong></li><li>桥接模式：将类的抽象部分和它的实现部分分离开来，使它们可以独立地变化 <strong>抽象实现拆分独立</strong></li><li>装饰模式：动态地给⼀个对象添加⼀些额外的职责 <strong>附加职责</strong></li><li>适配器模式：将⼀个类的接口转换成用户希望得到的另⼀个接口 <strong>转换接口</strong></li><li>门面模式：定义⼀个高层接口，为子系统中的⼀组接口提供一个一致的外观 <strong>对外统一接口</strong> ❌</li><li>组合模式：将对象组合成树型结构以表示”整体 - 部分”的层次结构 <strong>树型目录结构</strong> ❌</li><li>享元模式：提供支持大量细粒度对象共享的有效方法 ❌</li></ul></li><li>行为型<ul><li>观察者模式：定义对象间的⼀种⼀对多的依赖关系，当⼀个对象的状态发生改变时，所有依赖于它的对象都得到通知并自动更新</li><li>模板模式：定义⼀个操作中的算法骨架，而将⼀些步骤延迟到子类中，使得子类可以不改变⼀个算法的结构即可重新定义算法的某些特定步骤</li><li>策略模式：定义⼀系列算法，把它们⼀个个封装起来，并且使它们之间可互相替换，从而让算法可以独立于使用它的用户而变化</li><li>职责链模式：通过给多个对象处理请求的机会，减少请求的发送者与接收者之间的耦合。将接收对象链接起来，在链中传递请求，直到有⼀个对象处理这个请求 <strong>传递职责</strong></li><li>状态模式：允许⼀个对象在其内部状态改变时改变它的行为</li><li>迭代器模式：提供⼀种方法来顺序访问⼀个聚合对象中的各个元素而不需要暴露该对象的内部表示</li><li>访问者模式：表示⼀个作用于某对象结构中的各元素的操作，使得在不改变各元素的类的前提下定义作用于这些元素的新操作 ❌</li><li>备忘录模式：在不破坏封装性的前提下，捕获⼀个对象的内部状态，并在该对象之外保存这个状态，从而可用在以后将该对象恢复到原先保存的状态 ❌</li><li>命令模式：将⼀个请求封装为⼀个对象，从而可用不同的请求对客户进行参数化，将请求排队或记录请求⽇志，支持可撤销的操作 ❌</li><li>解释器模式：给定⼀种语言，定义它的文法表示，并定义⼀个解释器，该解释器用来根据文法表示来解释语言中的句子 ❌</li><li>中介模式：用⼀个中介对象来封装⼀系列的对象交互。它使各对象不需要显式地相互调用，从而达到低耦合，还可以独立地改变对象间的交互 ❌</li></ul></li></ul><h2 id="创建型"><a href="#创建型" class="headerlink" title="创建型"></a>创建型</h2><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231202054.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231202054.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="创建型模式"></p><h3 id="单例模式-Singleton"><a href="#单例模式-Singleton" class="headerlink" title="单例模式 Singleton"></a>单例模式 Singleton</h3><p><strong>一个类只允许创建一个对象（实例）</strong>，这个类就是单例类，这种设计模式就叫单例模式<br><strong>用处：</strong> 业务上，有些数据在系统中只应该保存一份</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231129062.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231129062.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="单例模式"></p><h4 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a>饿汉式</h4><blockquote><p>在系统初始化的时候我们已经把对象创建好了，需要用的时候直接拿过来用就好了</p></blockquote><p>类一旦加载，就把单例初始化完成，保证 <code>getInstance</code> 的时候，单例是已经存在的了。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> singleton</span><br><span class="line"></span><br><span class="line"><span class="comment">// Singleton 饿汉式单例</span></span><br><span class="line"><span class="keyword">type</span> Singleton <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> singleton *Singleton</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    singleton = &amp;Singleton&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetInstance 获取实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetInstance</span><span class="params">()</span></span> *Singleton &#123;</span><br><span class="line">    <span class="keyword">return</span> singleton</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="懒汉式（双重检测）"><a href="#懒汉式（双重检测）" class="headerlink" title="懒汉式（双重检测）"></a>懒汉式（双重检测）</h4><blockquote><p>创建对象时比较懒，先不急着创建对象，在需要加载配置文件的时候再去创建</p></blockquote><p>只有当调用 <code>getInstance</code> 的时候，才会去初始化这个单例。</p><p>为了实现懒汉式不可避免的需要加锁。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> singleton</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;sync&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    lazySingleton *Singleton</span><br><span class="line">    once          = &amp;sync.Once&#123;&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetLazyInstance 懒汉式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLazyInstance</span><span class="params">()</span></span> *Singleton &#123;</span><br><span class="line">    <span class="keyword">if</span> lazySingleton == <span class="literal">nil</span> &#123;</span><br><span class="line">        once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            lazySingleton = &amp;Singleton&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lazySingleton</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工厂模式-Factory"><a href="#工厂模式-Factory" class="headerlink" title="工厂模式 Factory"></a>工厂模式 Factory</h3><p>在工厂模式中，在创建对象时不会对客户端暴露创建逻辑，并且是通过<strong>使用一个共同的接口来指向新创建的对象</strong>。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231147355.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231147355.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="工厂模式"></p><h4 id="简单工厂"><a href="#简单工厂" class="headerlink" title="简单工厂"></a>简单工厂</h4><p>Go 本身是没有构造函数的，一般而言采用 <code>NewName</code> 的方式创建对象&#x2F;接口，当它返回的是接口的时候，其实就是简单工厂模式。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> factory</span><br><span class="line"></span><br><span class="line"><span class="comment">// IRuleConfigParser IRuleConfigParser</span></span><br><span class="line"><span class="keyword">type</span> IRuleConfigParser <span class="keyword">interface</span> &#123;</span><br><span class="line">    Parse(data []<span class="type">byte</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jsonRuleConfigParser jsonRuleConfigParser</span></span><br><span class="line"><span class="keyword">type</span> jsonRuleConfigParser <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse Parse</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(J jsonRuleConfigParser)</span></span> Parse(data []<span class="type">byte</span>) &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;implement me&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// yamlRuleConfigParser yamlRuleConfigParser</span></span><br><span class="line"><span class="keyword">type</span> yamlRuleConfigParser <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse Parse</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Y yamlRuleConfigParser)</span></span> Parse(data []<span class="type">byte</span>) &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;implement me&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewIRuleConfigParser NewIRuleConfigParser</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIRuleConfigParser</span><span class="params">(t <span class="type">string</span>)</span></span> IRuleConfigParser &#123;</span><br><span class="line">    <span class="keyword">switch</span> t &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;json&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonRuleConfigParser&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;yaml&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> yamlRuleConfigParser&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h4><p>当对象的创建逻辑比较复杂，不只是简单的 new 一下就可以，而是要组合其他类对象。</p><p>做各种初始化操作的时候，推荐使用工厂方法模式，将复杂的创建逻辑拆分到多个工厂类中，让每个工厂类都不至于过于复杂。</p><blockquote><p>组合复用原则：优先使用组合 contains a（聚合 has a），而不是继承 is a 来达到目的</p><p>迪米特法则：⼀个对象应当对其他对象有尽可能少的了解，即不和陌生人说话</p><ul><li>优点：降低类之间的耦合</li><li>缺点：产生大量中介类，设计变复杂</li></ul></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IRuleConfigParserFactory 工厂方法接口</span></span><br><span class="line"><span class="keyword">type</span> IRuleConfigParserFactory <span class="keyword">interface</span> &#123;</span><br><span class="line">    CreateParser() IRuleConfigParser</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// yamlRuleConfigParserFactory yamlRuleConfigParser 的工厂类</span></span><br><span class="line"><span class="keyword">type</span> yamlRuleConfigParserFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateParser CreateParser</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(y yamlRuleConfigParserFactory)</span></span> CreateParser() IRuleConfigParser &#123;</span><br><span class="line">    <span class="keyword">return</span> yamlRuleConfigParser&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jsonRuleConfigParserFactory jsonRuleConfigParser 的工厂类</span></span><br><span class="line"><span class="keyword">type</span> jsonRuleConfigParserFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateParser CreateParser</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j jsonRuleConfigParserFactory)</span></span> CreateParser() IRuleConfigParser &#123;</span><br><span class="line">    <span class="keyword">return</span> jsonRuleConfigParser&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewIRuleConfigParserFactory 用一个简单工厂封装工厂方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIRuleConfigParserFactory</span><span class="params">(t <span class="type">string</span>)</span></span> IRuleConfigParserFactory &#123;</span><br><span class="line">    <span class="keyword">switch</span> t &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;json&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonRuleConfigParserFactory&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;yaml&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> yamlRuleConfigParserFactory&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="建造者模式-Builder"><a href="#建造者模式-Builder" class="headerlink" title="建造者模式 Builder"></a>建造者模式 Builder</h3><p>在 Golang 中对于创建类参数比较多的对象的时候，常见的做法是必填参数直接传递，可选参数通过传递可变的方法进行创建。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231158567.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231158567.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="建造者模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ResourcePoolConfigOption option</span></span><br><span class="line"><span class="keyword">type</span> ResourcePoolConfigOption <span class="keyword">struct</span> &#123;</span><br><span class="line">    maxTotal <span class="type">int</span></span><br><span class="line">    maxIdle  <span class="type">int</span></span><br><span class="line">    minIdle  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ResourcePoolConfigOptFunc to set option</span></span><br><span class="line"><span class="keyword">type</span> ResourcePoolConfigOptFunc <span class="function"><span class="keyword">func</span><span class="params">(option *ResourcePoolConfigOption)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewResourcePoolConfig NewResourcePoolConfig</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewResourcePoolConfig</span><span class="params">(name <span class="type">string</span>, opts ...ResourcePoolConfigOptFunc)</span></span> (*ResourcePoolConfig, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;name can not be empty&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    option := &amp;ResourcePoolConfigOption&#123;</span><br><span class="line">        maxTotal: <span class="number">10</span>,</span><br><span class="line">        maxIdle:  <span class="number">9</span>,</span><br><span class="line">        minIdle:  <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">        opt(option)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> option.maxTotal &lt; <span class="number">0</span> || option.maxIdle &lt; <span class="number">0</span> || option.minIdle &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;args err, option: %v&quot;</span>, option)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> option.maxTotal &lt; option.maxIdle || option.minIdle &gt; option.maxIdle &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;args err, option: %v&quot;</span>, option)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;ResourcePoolConfig&#123;</span><br><span class="line">        name:     name,</span><br><span class="line">        maxTotal: option.maxTotal,</span><br><span class="line">        maxIdle:  option.maxIdle,</span><br><span class="line">        minIdle:  option.minIdle,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="原型模式-Prototype"><a href="#原型模式-Prototype" class="headerlink" title="原型模式 Prototype"></a>原型模式 Prototype</h3><p>利用已有对象（原型）进行复制（拷贝）的方式来创建新的对象，达到节省创建时间的目的。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231203233.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231203233.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="原型模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> prototype</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Keyword 搜索关键字</span></span><br><span class="line"><span class="keyword">type</span> Keyword <span class="keyword">struct</span> &#123;</span><br><span class="line">    word      <span class="type">string</span></span><br><span class="line">    visit     <span class="type">int</span></span><br><span class="line">    UpdatedAt *time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clone 这里使用序列化与反序列化的方式深拷贝</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k *Keyword)</span></span> Clone() *Keyword &#123;</span><br><span class="line">    <span class="keyword">var</span> newKeyword Keyword</span><br><span class="line">    b, _ := json.Marshal(k)</span><br><span class="line">    json.Unmarshal(b, &amp;newKeyword)</span><br><span class="line">    <span class="keyword">return</span> &amp;newKeyword</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Keywords 关键字 map</span></span><br><span class="line"><span class="keyword">type</span> Keywords <span class="keyword">map</span>[<span class="type">string</span>]*Keyword</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clone 复制一个新的 keywords</span></span><br><span class="line"><span class="comment">// updatedWords: 需要更新的关键词列表，由于从数据库中获取数据常常是数组的方式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(words Keywords)</span></span> Clone(updatedWords []*Keyword) Keywords &#123;</span><br><span class="line">    newKeywords := Keywords&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> words &#123;</span><br><span class="line">        <span class="comment">// 这里是浅拷贝，直接拷贝了地址</span></span><br><span class="line">        newKeywords[k] = v</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 替换掉需要更新的字段，这里用的是深拷贝</span></span><br><span class="line">    <span class="keyword">for</span> _, word := <span class="keyword">range</span> updatedWords &#123;</span><br><span class="line">        newKeywords[word.word] = word.Clone()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newKeywords</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结构型"><a href="#结构型" class="headerlink" title="结构型"></a>结构型</h2><h3 id="代理模式-Proxy"><a href="#代理模式-Proxy" class="headerlink" title="代理模式 Proxy"></a>代理模式 Proxy</h3><p>为其他对象提供⼀种代理以控制这个对象的访问。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231208710.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231208710.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="代理模式"></p><h4 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> proxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// IUser IUser</span></span><br><span class="line"><span class="keyword">type</span> IUser <span class="keyword">interface</span> &#123;</span><br><span class="line">    Login(username, password <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// User 用户</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Login 用户登录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> Login(username, password <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 不实现细节</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserProxy 代理类</span></span><br><span class="line"><span class="keyword">type</span> UserProxy <span class="keyword">struct</span> &#123;</span><br><span class="line">    user *User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewUserProxy NewUserProxy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUserProxy</span><span class="params">(user *User)</span></span> *UserProxy &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;UserProxy&#123;</span><br><span class="line">        user: user,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Login 登录，和 user 实现相同的接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *UserProxy)</span></span> Login(username, password <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// before 这里可能会有一些统计的逻辑</span></span><br><span class="line">    start := time.Now()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里是原有的业务逻辑</span></span><br><span class="line">    <span class="keyword">if</span> err := p.user.Login(username, password); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// after 这里可能也有一些监控统计的逻辑</span></span><br><span class="line">    log.Printf(<span class="string">&quot;user login cost time: %s&quot;</span>, time.Now().Sub(start))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="桥接模式-Bridge"><a href="#桥接模式-Bridge" class="headerlink" title="桥接模式 Bridge"></a>桥接模式 Bridge</h3><p>将类的抽象部分和它的实现部分分离开来，使它们可以独立地变化。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231210754.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231210754.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="桥接模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> bridge</span><br><span class="line"></span><br><span class="line"><span class="comment">// IMsgSender IMsgSender</span></span><br><span class="line"><span class="keyword">type</span> IMsgSender <span class="keyword">interface</span> &#123;</span><br><span class="line">    Send(msg <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EmailMsgSender 发送邮件</span></span><br><span class="line"><span class="comment">// 可能还有 电话、短信等各种实现</span></span><br><span class="line"><span class="keyword">type</span> EmailMsgSender <span class="keyword">struct</span> &#123;</span><br><span class="line">    emails []<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewEmailMsgSender NewEmailMsgSender</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEmailMsgSender</span><span class="params">(emails []<span class="type">string</span>)</span></span> *EmailMsgSender &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;EmailMsgSender&#123;emails: emails&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send Send</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *EmailMsgSender)</span></span> Send(msg <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 这里去发送消息</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// INotification 通知接口</span></span><br><span class="line"><span class="keyword">type</span> INotification <span class="keyword">interface</span> &#123;</span><br><span class="line">    Notify(msg <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ErrorNotification 错误通知</span></span><br><span class="line"><span class="comment">// 后面可能还有 warning 各种级别</span></span><br><span class="line"><span class="keyword">type</span> ErrorNotification <span class="keyword">struct</span> &#123;</span><br><span class="line">    sender IMsgSender</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewErrorNotification NewErrorNotification</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewErrorNotification</span><span class="params">(sender IMsgSender)</span></span> *ErrorNotification &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;ErrorNotification&#123;sender: sender&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notify 发送通知</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *ErrorNotification)</span></span> Notify(msg <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> n.sender.Send(msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="装饰模式-Decorator"><a href="#装饰模式-Decorator" class="headerlink" title="装饰模式 Decorator"></a>装饰模式 Decorator</h3><p>动态地给⼀个对象添加⼀些额外的职责。它提供了用子类扩展功能的⼀个灵活的替代，比派生一个子类更加灵活。</p><p><strong>附加职责</strong></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231212129.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231212129.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="装饰模式"></p><p>下面是一个简单的画画的例子，默认的 <code>Square</code> 只有基础的画画功能， <code>ColorSquare</code> 为他加上了颜色</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="comment">// IDraw IDraw</span></span><br><span class="line"><span class="keyword">type</span> IDraw <span class="keyword">interface</span> &#123;</span><br><span class="line">    Draw() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Square 正方形</span></span><br><span class="line"><span class="keyword">type</span> Square <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Draw Draw</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Square)</span></span> Draw() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;this is a square&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ColorSquare 有颜色的正方形</span></span><br><span class="line"><span class="keyword">type</span> ColorSquare <span class="keyword">struct</span> &#123;</span><br><span class="line">    square IDraw</span><br><span class="line">    color  <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewColorSquare NewColorSquare</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewColorSquare</span><span class="params">(square IDraw, color <span class="type">string</span>)</span></span> ColorSquare &#123;</span><br><span class="line">    <span class="keyword">return</span> ColorSquare&#123;color: color, square: square&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Draw Draw</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c ColorSquare)</span></span> Draw() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c.square.Draw() + <span class="string">&quot;, color is &quot;</span> + c.color</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="适配器模式-Adapter"><a href="#适配器模式-Adapter" class="headerlink" title="适配器模式 Adapter"></a>适配器模式 Adapter</h3><p>将⼀个类的接口转换成用户希望得到的另⼀个接口，它使原本不相容的接口得以协同⼯作。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231214029.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231214029.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="适配器模式"></p><p>假设现在有一个运维系统，需要分别调用阿里云和 AWS 的 SDK 创建主机，两个 SDK 提供的创建主机的接口不一致，此时就可以通过适配器模式，将两个接口统一。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> adapter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ICreateServer 创建云主机</span></span><br><span class="line"><span class="keyword">type</span> ICreateServer <span class="keyword">interface</span> &#123;</span><br><span class="line">    CreateServer(cpu, mem <span class="type">float64</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AWSClient aws sdk</span></span><br><span class="line"><span class="keyword">type</span> AWSClient <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RunInstance 启动实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *AWSClient)</span></span> RunInstance(cpu, mem <span class="type">float64</span>) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;aws client run success, cpu： %f, mem: %f&quot;</span>, cpu, mem)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AwsClientAdapter 适配器</span></span><br><span class="line"><span class="keyword">type</span> AwsClientAdapter <span class="keyword">struct</span> &#123;</span><br><span class="line">    Client AWSClient</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateServer 启动实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *AwsClientAdapter)</span></span> CreateServer(cpu, mem <span class="type">float64</span>) <span class="type">error</span> &#123;</span><br><span class="line">    a.Client.RunInstance(cpu, mem)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AliyunClient aliyun sdk</span></span><br><span class="line"><span class="keyword">type</span> AliyunClient <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateServer 启动实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *AliyunClient)</span></span> CreateServer(cpu, mem <span class="type">int</span>) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;aws client run success, cpu： %d, mem: %d&quot;</span>, cpu, mem)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AliyunClientAdapter 适配器</span></span><br><span class="line"><span class="keyword">type</span> AliyunClientAdapter <span class="keyword">struct</span> &#123;</span><br><span class="line">    Client AliyunClient</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateServer 启动实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *AliyunClientAdapter)</span></span> CreateServer(cpu, mem <span class="type">float64</span>) <span class="type">error</span> &#123;</span><br><span class="line">    a.Client.CreateServer(<span class="type">int</span>(cpu), <span class="type">int</span>(mem))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="门面模式-Facade"><a href="#门面模式-Facade" class="headerlink" title="门面模式 Facade"></a>门面模式 Facade</h3><p>定义⼀个高层接口，为子系统中的⼀组接口提供一个一致的外观，从而简化了该子系统的使用。</p><p><strong>对外统一接口</strong></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231353536.jpeg" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231353536.jpeg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="门面模式"></p><blockquote><p>假设现在我有一个网站，以前有登录和注册的流程，登录的时候调用用户的查询接口，注册时调用用户的创建接口。为了简化用户的使用流程，我们现在提供直接验证码登录&#x2F;注册的功能，如果该手机号已注册那么我们就走登录流程，如果该手机号未注册，那么我们就创建一个新的用户。</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> facade</span><br><span class="line"></span><br><span class="line"><span class="comment">// IUser 用户接口</span></span><br><span class="line"><span class="keyword">type</span> IUser <span class="keyword">interface</span> &#123;</span><br><span class="line">    Login(phone <span class="type">int</span>, code <span class="type">int</span>) (*User, <span class="type">error</span>)</span><br><span class="line">    Register(phone <span class="type">int</span>, code <span class="type">int</span>) (*User, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IUserFacade 门面模式</span></span><br><span class="line"><span class="keyword">type</span> IUserFacade <span class="keyword">interface</span> &#123;</span><br><span class="line">    LoginOrRegister(phone <span class="type">int</span>, code <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// User 用户</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserService UserService</span></span><br><span class="line"><span class="keyword">type</span> UserService <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Login 登录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u UserService)</span></span> Login(phone <span class="type">int</span>, code <span class="type">int</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 校验操作 ...</span></span><br><span class="line">    <span class="keyword">return</span> &amp;User&#123;Name: <span class="string">&quot;test login&quot;</span>&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register 注册</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u UserService)</span></span> Register(phone <span class="type">int</span>, code <span class="type">int</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 校验操作 ...</span></span><br><span class="line">    <span class="comment">// 创建用户</span></span><br><span class="line">    <span class="keyword">return</span> &amp;User&#123;Name: <span class="string">&quot;test register&quot;</span>&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LoginOrRegister 登录或注册</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u UserService)</span></span>LoginOrRegister(phone <span class="type">int</span>, code <span class="type">int</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">    user, err := u.Login(phone, code)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> user != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u.Register(phone, code)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="组合模式-Composite"><a href="#组合模式-Composite" class="headerlink" title="组合模式 Composite"></a>组合模式 Composite</h3><p>将对象组合成树型结构以表示“整体 - 部分”的层次结构，使得用户对单个对象和组合对象的使用具有⼀致性。</p><p><strong>树形目录结构</strong></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231355688.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231355688.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="组合模式"></p><blockquote><p>公司的人员组织就是一个典型的树状的结构，现在假设我们现在有部分，和员工，两种角色，一个部门下面可以存在子部门和员工，员工下面不能再包含其他节点。</p></blockquote><p>我们现在要实现一个统计一个部门下员工数量的功能</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> composite</span><br><span class="line"></span><br><span class="line"><span class="comment">// IOrganization 组织接口，都实现统计人数的功能</span></span><br><span class="line"><span class="keyword">type</span> IOrganization <span class="keyword">interface</span> &#123;</span><br><span class="line">    Count() <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Employee 员工</span></span><br><span class="line"><span class="keyword">type</span> Employee <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Count 人数统计</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Employee)</span></span> Count() <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Department 部门</span></span><br><span class="line"><span class="keyword">type</span> Department <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    SubOrganizations []IOrganization</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Count 人数统计</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d Department)</span></span> Count() <span class="type">int</span> &#123;</span><br><span class="line">    c := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _, org := <span class="keyword">range</span> d.SubOrganizations &#123;</span><br><span class="line">        c += org.Count()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddSub 添加子节点</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Department)</span></span> AddSub(org IOrganization) &#123;</span><br><span class="line">    d.SubOrganizations = <span class="built_in">append</span>(d.SubOrganizations, org)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewOrganization 构建组织架构 demo</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewOrganization</span><span class="params">()</span></span> IOrganization &#123;</span><br><span class="line">    root := &amp;Department&#123;Name: <span class="string">&quot;root&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        root.AddSub(&amp;Employee&#123;&#125;)</span><br><span class="line">        root.AddSub(&amp;Department&#123;Name: <span class="string">&quot;sub&quot;</span>, SubOrganizations: []IOrganization&#123;&amp;Employee&#123;&#125;&#125;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="享元模式-Flyweight"><a href="#享元模式-Flyweight" class="headerlink" title="享元模式 Flyweight"></a>享元模式 Flyweight</h3><p>提供支持大量细粒度对象共享的有效方法。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231358380.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231358380.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="享元模式"></p><blockquote><p>象棋，无论是什么对局，棋子的基本属性其实是固定的，并不会因为随着下棋的过程变化。那我们就可以把棋子变为享元，让所有的对局都共享这些对象，以此达到节省内存的目的。</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> flyweight</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> units = <span class="keyword">map</span>[<span class="type">int</span>]*ChessPieceUnit&#123;</span><br><span class="line">    <span class="number">1</span>: &#123;</span><br><span class="line">        ID:    <span class="number">1</span>,</span><br><span class="line">        Name:  <span class="string">&quot;車&quot;</span>,</span><br><span class="line">        Color: <span class="string">&quot;red&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">        ID:    <span class="number">2</span>,</span><br><span class="line">        Name:  <span class="string">&quot;炮&quot;</span>,</span><br><span class="line">        Color: <span class="string">&quot;red&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ... 其他棋子</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChessPieceUnit 棋子享元</span></span><br><span class="line"><span class="keyword">type</span> ChessPieceUnit <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID    <span class="type">uint</span></span><br><span class="line">    Name  <span class="type">string</span></span><br><span class="line">    Color <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewChessPieceUnit 工厂</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewChessPieceUnit</span><span class="params">(id <span class="type">int</span>)</span></span> *ChessPieceUnit &#123;</span><br><span class="line">    <span class="keyword">return</span> units[id]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChessPiece 棋子</span></span><br><span class="line"><span class="keyword">type</span> ChessPiece <span class="keyword">struct</span> &#123;</span><br><span class="line">    Unit *ChessPieceUnit</span><br><span class="line">    X    <span class="type">int</span></span><br><span class="line">    Y    <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChessBoard 棋局</span></span><br><span class="line"><span class="keyword">type</span> ChessBoard <span class="keyword">struct</span> &#123;</span><br><span class="line">    chessPieces <span class="keyword">map</span>[<span class="type">int</span>]*ChessPiece</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewChessBoard 初始化棋盘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewChessBoard</span><span class="params">()</span></span> *ChessBoard &#123;</span><br><span class="line">    board := &amp;ChessBoard&#123;chessPieces: <span class="keyword">map</span>[<span class="type">int</span>]*ChessPiece&#123;&#125;&#125;</span><br><span class="line">    <span class="keyword">for</span> id := <span class="keyword">range</span> units &#123;</span><br><span class="line">        board.chessPieces[id] = &amp;ChessPiece&#123;</span><br><span class="line">            Unit: NewChessPieceUnit(id),</span><br><span class="line">            X:    <span class="number">0</span>,</span><br><span class="line">            Y:    <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> board</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Move 移动棋子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ChessBoard)</span></span> Move(id, x, y <span class="type">int</span>) &#123;</span><br><span class="line">    c.chessPieces[id].X = x</span><br><span class="line">    c.chessPieces[id].Y = y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="行为型"><a href="#行为型" class="headerlink" title="行为型"></a>行为型</h2><h3 id="观察者模式-Observer"><a href="#观察者模式-Observer" class="headerlink" title="观察者模式 Observer"></a>观察者模式 Observer</h3><p>定义对象间的⼀种⼀对多的依赖关系，当⼀个对象的状态发生改变时，所有依赖于它的对象都得到通知并自动更新。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231408656.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231408656.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="观察者模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> observer</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ISubject subject</span></span><br><span class="line"><span class="keyword">type</span> ISubject <span class="keyword">interface</span> &#123;</span><br><span class="line">    Register(observer IObserver)</span><br><span class="line">    Remove(observer IObserver)</span><br><span class="line">    Notify(msg <span class="type">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IObserver 观察者</span></span><br><span class="line"><span class="keyword">type</span> IObserver <span class="keyword">interface</span> &#123;</span><br><span class="line">    Update(msg <span class="type">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Subject Subject</span></span><br><span class="line"><span class="keyword">type</span> Subject <span class="keyword">struct</span> &#123;</span><br><span class="line">    observers []IObserver</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register 注册</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sub *Subject)</span></span> Register(observer IObserver) &#123;</span><br><span class="line">    sub.observers = <span class="built_in">append</span>(sub.observers, observer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove 移除观察者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sub *Subject)</span></span> Remove(observer IObserver) &#123;</span><br><span class="line">    <span class="keyword">for</span> i, ob := <span class="keyword">range</span> sub.observers &#123;</span><br><span class="line">        <span class="keyword">if</span> ob == observer &#123;</span><br><span class="line">            sub.observers = <span class="built_in">append</span>(sub.observers[:i], sub.observers[i+<span class="number">1</span>:]...)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notify 通知</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sub *Subject)</span></span> Notify(msg <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> _, o := <span class="keyword">range</span> sub.observers &#123;</span><br><span class="line">        o.Update(msg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Observer1 Observer1</span></span><br><span class="line"><span class="keyword">type</span> Observer1 <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update 实现观察者接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Observer1)</span></span> Update(msg <span class="type">string</span>) &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Observer1: %s&quot;</span>, msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Observer2 Observer2</span></span><br><span class="line"><span class="keyword">type</span> Observer2 <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update 实现观察者接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Observer2)</span></span> Update(msg <span class="type">string</span>) &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Observer2: %s&quot;</span>, msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="模板模式-Template"><a href="#模板模式-Template" class="headerlink" title="模板模式 Template"></a>模板模式 Template</h3><p>定义⼀个操作中的算法骨架，而将⼀些步骤延迟到子类中，使得子类可以不改变⼀个算法的结构即可重新定义算法的某些特定步骤。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231409069.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231409069.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="模板模式"></p><blockquote><p>要做一个短信推送的系统，那么需要</p><ol><li>检查短信字数是否超过限制</li><li>检查手机号是否正确</li><li>发送短信</li><li>返回状态</li></ol><p>我们可以发现，在发送短信的时候由于不同的供应商调用的接口不同，所以会有一些实现上的差异，但是他的算法（业务逻辑）是固定的</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ISMS ISMS</span></span><br><span class="line"><span class="keyword">type</span> ISMS <span class="keyword">interface</span> &#123;</span><br><span class="line">    send(content <span class="type">string</span>, phone <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SMS 短信发送基类</span></span><br><span class="line"><span class="keyword">type</span> sms <span class="keyword">struct</span> &#123;</span><br><span class="line">    ISMS</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Valid 校验短信字数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sms)</span></span> Valid(content <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(content) &gt; <span class="number">63</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;content is too long&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send 发送短信</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sms)</span></span> Send(content <span class="type">string</span>, phone <span class="type">int</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := s.Valid(content); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用子类的方法发送短信</span></span><br><span class="line">    <span class="keyword">return</span> s.send(content, phone)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TelecomSms 走电信通道</span></span><br><span class="line"><span class="keyword">type</span> TelecomSms <span class="keyword">struct</span> &#123;</span><br><span class="line">    *sms</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewTelecomSms NewTelecomSms</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTelecomSms</span><span class="params">()</span></span> *TelecomSms &#123;</span><br><span class="line">    tel := &amp;TelecomSms&#123;&#125;</span><br><span class="line">    <span class="comment">// 这里有点绕，是因为 go 没有继承，用嵌套结构体的方法进行模拟</span></span><br><span class="line">    <span class="comment">// 这里将子类作为接口嵌入父类，就可以让父类的模板方法 Send 调用到子类的函数</span></span><br><span class="line">    <span class="comment">// 实际使用中，我们并不会这么写，都是采用组合+接口的方式完成类似的功能</span></span><br><span class="line">    tel.sms = &amp;sms&#123;ISMS: tel&#125;</span><br><span class="line">    <span class="keyword">return</span> tel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tel *TelecomSms)</span></span> send(content <span class="type">string</span>, phone <span class="type">int</span>) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;send by telecom success&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="策略模式-Strategy"><a href="#策略模式-Strategy" class="headerlink" title="策略模式 Strategy"></a>策略模式 Strategy</h3><p>定义⼀系列算法，把它们⼀个个封装起来，并且使它们之间可互相替换，从而让算法可以独立于使用它的用户而变化。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231410116.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231410116.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="策略模式"></p><blockquote><p>在保存文件的时候，由于政策或者其他的原因可能需要选择不同的存储方式，敏感数据我们需要加密存储，不敏感的数据我们可以直接明文保存。</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> strategy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// StorageStrategy 存储策略</span></span><br><span class="line"><span class="keyword">type</span> StorageStrategy <span class="keyword">interface</span> &#123;</span><br><span class="line">    Save(name <span class="type">string</span>, data []<span class="type">byte</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> strategys = <span class="keyword">map</span>[<span class="type">string</span>]StorageStrategy&#123;</span><br><span class="line">    <span class="string">&quot;file&quot;</span>:         &amp;fileStorage&#123;&#125;,</span><br><span class="line">    <span class="string">&quot;encrypt_file&quot;</span>: &amp;encryptFileStorage&#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewStorageStrategy NewStorageStrategy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStorageStrategy</span><span class="params">(t <span class="type">string</span>)</span></span> (StorageStrategy, <span class="type">error</span>) &#123;</span><br><span class="line">    s, ok := strategys[t]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;not found StorageStrategy: %s&quot;</span>, t)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FileStorage 保存到文件</span></span><br><span class="line"><span class="keyword">type</span> fileStorage <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Save Save</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fileStorage)</span></span> Save(name <span class="type">string</span>, data []<span class="type">byte</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ioutil.WriteFile(name, data, os.ModeAppend)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// encryptFileStorage 加密保存到文件</span></span><br><span class="line"><span class="keyword">type</span> encryptFileStorage <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Save Save</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *encryptFileStorage)</span></span> Save(name <span class="type">string</span>, data []<span class="type">byte</span>) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 加密</span></span><br><span class="line">    data, err := encrypt(data)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ioutil.WriteFile(name, data, os.ModeAppend)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">encrypt</span><span class="params">(data []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 这里实现加密算法</span></span><br><span class="line">    <span class="keyword">return</span> data, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="职责链模式-Chain-of-Responsibility"><a href="#职责链模式-Chain-of-Responsibility" class="headerlink" title="职责链模式 Chain of Responsibility"></a>职责链模式 Chain of Responsibility</h3><p>通过给多个对象处理请求的机会，减少请求的发送者与接收者之间的耦合。将接收对象链接起来，在链中传递请 求，直到有⼀个对象处理这个请求。<br><strong>传递职责</strong></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231411476.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231411476.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="职责链模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package chain 职责链模式</span></span><br><span class="line"><span class="comment">// 🌰 假设我们现在有个校园论坛，由于社区规章制度、广告、法律法规的原因需要对用户的发言进行敏感词过滤</span></span><br><span class="line"><span class="comment">//    如果被判定为敏感词，那么这篇帖子将会被封禁</span></span><br><span class="line"><span class="keyword">package</span> chain</span><br><span class="line"></span><br><span class="line"><span class="comment">// SensitiveWordFilter 敏感词过滤器，判定是否是敏感词</span></span><br><span class="line"><span class="keyword">type</span> SensitiveWordFilter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Filter(content <span class="type">string</span>) <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SensitiveWordFilterChain 职责链</span></span><br><span class="line"><span class="keyword">type</span> SensitiveWordFilterChain <span class="keyword">struct</span> &#123;</span><br><span class="line">    filters []SensitiveWordFilter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddFilter 添加一个过滤器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SensitiveWordFilterChain)</span></span> AddFilter(filter SensitiveWordFilter) &#123;</span><br><span class="line">    c.filters = <span class="built_in">append</span>(c.filters, filter)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Filter 执行过滤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SensitiveWordFilterChain)</span></span> Filter(content <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, filter := <span class="keyword">range</span> c.filters &#123;</span><br><span class="line">        <span class="comment">// 如果发现敏感直接返回结果</span></span><br><span class="line">        <span class="keyword">if</span> filter.Filter(content) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AdSensitiveWordFilter 广告</span></span><br><span class="line"><span class="keyword">type</span> AdSensitiveWordFilter <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Filter 实现过滤算法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *AdSensitiveWordFilter)</span></span> Filter(content <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 实现算法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PoliticalWordFilter 政治敏感</span></span><br><span class="line"><span class="keyword">type</span> PoliticalWordFilter <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Filter 实现过滤算法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *PoliticalWordFilter)</span></span> Filter(content <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 实现算法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="状态模式-State"><a href="#状态模式-State" class="headerlink" title="状态模式 State"></a>状态模式 State</h3><p>允许⼀个对象在其内部状态改变时改变它的行为。</p><p><strong>状态变成类</strong></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231412401.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231412401.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="状态模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package state 状态模式</span></span><br><span class="line"><span class="comment">// 笔记请查看: https://lailin.xyz/state.html</span></span><br><span class="line"><span class="comment">// 这是一个工作流的例子，在企业内部或者是学校我们经常会看到很多审批流程</span></span><br><span class="line"><span class="comment">// 假设我们有一个报销的流程: 员工提交报销申请 -&gt; 直属部门领导审批 -&gt; 财务审批 -&gt; 结束</span></span><br><span class="line"><span class="comment">// 在这个审批流中，处在不同的环节就是不同的状态</span></span><br><span class="line"><span class="comment">// 而流程的审批、驳回就是不同的事件</span></span><br><span class="line"><span class="keyword">package</span> state</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Machine 状态机</span></span><br><span class="line"><span class="keyword">type</span> Machine <span class="keyword">struct</span> &#123;</span><br><span class="line">    state IState</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetState 更新状态</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Machine)</span></span> SetState(state IState) &#123;</span><br><span class="line">    m.state = state</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetStateName 获取当前状态</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Machine)</span></span> GetStateName() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> m.state.GetName()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Machine)</span></span> Approval() &#123;</span><br><span class="line">    m.state.Approval(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Machine)</span></span> Reject() &#123;</span><br><span class="line">    m.state.Reject(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IState 状态</span></span><br><span class="line"><span class="keyword">type</span> IState <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// 审批通过</span></span><br><span class="line">    Approval(m *Machine)</span><br><span class="line">    <span class="comment">// 驳回</span></span><br><span class="line">    Reject(m *Machine)</span><br><span class="line">    <span class="comment">// 获取当前状态名称</span></span><br><span class="line">    GetName() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// leaderApproveState 直属领导审批</span></span><br><span class="line"><span class="keyword">type</span> leaderApproveState <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Approval 获取状态名字</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(leaderApproveState)</span></span> Approval(m *Machine) &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;leader 审批成功&quot;</span>)</span><br><span class="line">    m.SetState(GetFinanceApproveState())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetName 获取状态名字</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(leaderApproveState)</span></span> GetName() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;LeaderApproveState&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reject 获取状态名字</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(leaderApproveState)</span></span> Reject(m *Machine) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLeaderApproveState</span><span class="params">()</span></span> IState &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;leaderApproveState&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// financeApproveState 财务审批</span></span><br><span class="line"><span class="keyword">type</span> financeApproveState <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Approval 审批通过</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f financeApproveState)</span></span> Approval(m *Machine) &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;财务审批成功&quot;</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;出发打款操作&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拒绝</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f financeApproveState)</span></span> Reject(m *Machine) &#123;</span><br><span class="line">    m.SetState(GetLeaderApproveState())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetName 获取名字</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f financeApproveState)</span></span> GetName() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;FinanceApproveState&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetFinanceApproveState GetFinanceApproveState</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetFinanceApproveState</span><span class="params">()</span></span> IState &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;financeApproveState&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="迭代器模式-Iterator"><a href="#迭代器模式-Iterator" class="headerlink" title="迭代器模式 Iterator"></a>迭代器模式 Iterator</h3><p>提供⼀种⽅法来顺序访问⼀个聚合对象中的各个元素而不需要暴露该对象的内部表示。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231412859.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231412859.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="迭代器模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> iterator</span><br><span class="line"></span><br><span class="line"><span class="comment">// Iterator 迭代器接口</span></span><br><span class="line"><span class="keyword">type</span> Iterator <span class="keyword">interface</span> &#123;</span><br><span class="line">    HasNext() <span class="type">bool</span></span><br><span class="line">    Next()</span><br><span class="line">    <span class="comment">// 获取当前元素，由于 Go 1.15 中还没有泛型，所以我们直接返回 interface&#123;&#125;</span></span><br><span class="line">    CurrentItem() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ArrayInt 数组</span></span><br><span class="line"><span class="keyword">type</span> ArrayInt []<span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Iterator 返回迭代器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ArrayInt)</span></span> Iterator() Iterator &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;ArrayIntIterator&#123;</span><br><span class="line">        arrayInt: a,</span><br><span class="line">        index:    <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ArrayIntIterator 数组迭代</span></span><br><span class="line"><span class="keyword">type</span> ArrayIntIterator <span class="keyword">struct</span> &#123;</span><br><span class="line">    arrayInt ArrayInt</span><br><span class="line">    index    <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HasNext 是否有下一个</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(iter *ArrayIntIterator)</span></span> HasNext() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iter.index &lt; <span class="built_in">len</span>(iter.arrayInt)<span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next 游标加一</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(iter *ArrayIntIterator)</span></span> Next() &#123;</span><br><span class="line">    iter.index++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CurrentItem 获取当前元素</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(iter *ArrayIntIterator)</span></span> CurrentItem() <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> iter.arrayInt[iter.index]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="访问者模式-Visitor"><a href="#访问者模式-Visitor" class="headerlink" title="访问者模式 Visitor"></a>访问者模式 Visitor</h3><p>表示⼀个作用于某对象结构中的各元素的操作，使得在不改变各元素的类的前提下定义作用于这些元素的新操作。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231413188.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231413188.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="访问者模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> visitor</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;path&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Visitor 访问者</span></span><br><span class="line"><span class="keyword">type</span> Visitor <span class="keyword">interface</span> &#123;</span><br><span class="line">    Visit(IResourceFile) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IResourceFile IResourceFile</span></span><br><span class="line"><span class="keyword">type</span> IResourceFile <span class="keyword">interface</span> &#123;</span><br><span class="line">    Accept(Visitor) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewResourceFile NewResourceFile</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewResourceFile</span><span class="params">(filepath <span class="type">string</span>)</span></span> (IResourceFile, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> path.Ext(filepath) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;.ppt&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;PPTFile&#123;path: filepath&#125;, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;.pdf&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;PdfFile&#123;path: filepath&#125;, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;not found file type: %s&quot;</span>, filepath)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PdfFile PdfFile</span></span><br><span class="line"><span class="keyword">type</span> PdfFile <span class="keyword">struct</span> &#123;</span><br><span class="line">    path <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Accept Accept</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *PdfFile)</span></span> Accept(visitor Visitor) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> visitor.Visit(f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PPTFile PPTFile</span></span><br><span class="line"><span class="keyword">type</span> PPTFile <span class="keyword">struct</span> &#123;</span><br><span class="line">    path <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Accept Accept</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *PPTFile)</span></span> Accept(visitor Visitor) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> visitor.Visit(f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compressor 实现压缩功能</span></span><br><span class="line"><span class="keyword">type</span> Compressor <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Visit 实现访问者模式方法</span></span><br><span class="line"><span class="comment">// 我们可以发现由于没有函数重载，我们只能通过断言来根据不同的类型调用不同函数</span></span><br><span class="line"><span class="comment">// 但是我们即使不采用访问者模式，我们其实也是可以这么操作的</span></span><br><span class="line"><span class="comment">// 并且由于采用了类型断言，所以如果需要操作的对象比较多的话，这个函数其实也会膨胀的比较厉害</span></span><br><span class="line"><span class="comment">// 后续可以考虑按照命名约定使用 generate 自动生成代码</span></span><br><span class="line"><span class="comment">// 或者是使用反射简化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Compressor)</span></span> Visit(r IResourceFile) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> f := r.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> *PPTFile:</span><br><span class="line">        <span class="keyword">return</span> c.VisitPPTFile(f)</span><br><span class="line">    <span class="keyword">case</span> *PdfFile:</span><br><span class="line">        <span class="keyword">return</span> c.VisitPDFFile(f)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;not found resource typr: %##v&quot;</span>, r)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VisitPPTFile VisitPPTFile</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Compressor)</span></span> VisitPPTFile(f *PPTFile) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;this is ppt file&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VisitPDFFile VisitPDFFile</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Compressor)</span></span> VisitPDFFile(f *PdfFile) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;this is pdf file&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="备忘录模式-Memento"><a href="#备忘录模式-Memento" class="headerlink" title="备忘录模式 Memento"></a>备忘录模式 Memento</h3><p>在不破坏封装性的前提下，捕获⼀个对象的内部状态，并在该对象之外保存这个状态，从而可用在以后将该对象恢复到原先保存的状态。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231414592.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231414592.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="备忘录模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package memento 备忘录模式</span></span><br><span class="line"><span class="comment">// 下面这个例子采用原课程的例子，一个输入程序</span></span><br><span class="line"><span class="comment">// 如果输入 :list 则显示当前保存的内容</span></span><br><span class="line"><span class="comment">// 如果输入 :undo 则删除上一次的输入</span></span><br><span class="line"><span class="comment">// 如果输入其他的内容则追加保存</span></span><br><span class="line"><span class="keyword">package</span> memento</span><br><span class="line"></span><br><span class="line"><span class="comment">// InputText 用于保存数据</span></span><br><span class="line"><span class="keyword">type</span> InputText <span class="keyword">struct</span> &#123;</span><br><span class="line">    content <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Append 追加数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(in *InputText)</span></span> Append(content <span class="type">string</span>) &#123;</span><br><span class="line">    in.content += content</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetText 获取数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(in *InputText)</span></span> GetText() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> in.content</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Snapshot 创建快照</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(in *InputText)</span></span> Snapshot() *Snapshot &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Snapshot&#123;content: in.content&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Restore 从快照中恢复</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(in *InputText)</span></span> Restore(s *Snapshot) &#123;</span><br><span class="line">    in.content = s.GetText()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Snapshot 快照，用于存储数据快照</span></span><br><span class="line"><span class="comment">// 对于快照来说，只能不能被外部（不同包）修改，只能获取数据，满足封装的特性</span></span><br><span class="line"><span class="keyword">type</span> Snapshot <span class="keyword">struct</span> &#123;</span><br><span class="line">    content <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetText GetText</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Snapshot)</span></span> GetText() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s.content</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="命令模式-Command"><a href="#命令模式-Command" class="headerlink" title="命令模式 Command"></a>命令模式 Command</h3><p>将⼀个请求封装为⼀个对象，从而可用不同的请求对客户进行参数化，将请求排队或记录请求⽇志，支持可撤销的操作。</p><p><strong>日志记录，可撤销</strong></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231415154.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231415154.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="命令模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package command 命令模式</span></span><br><span class="line"><span class="comment">// Blog: https://lailin.xyz/post/command.html</span></span><br><span class="line"><span class="comment">// 这是示例一，采用将函数封装为对象的方式实现，</span></span><br><span class="line"><span class="comment">// 示例说明:</span></span><br><span class="line"><span class="comment">// 假设现在有一个游戏服务，我们正在实现一个游戏后端</span></span><br><span class="line"><span class="comment">// 使用一个 goroutine 不断接收来自客户端请求的命令，并且将它放置到一个队列当中</span></span><br><span class="line"><span class="comment">// 然后我们在另外一个 goroutine 中来执行它</span></span><br><span class="line"><span class="keyword">package</span> command</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ICommand 命令</span></span><br><span class="line"><span class="keyword">type</span> ICommand <span class="keyword">interface</span> &#123;</span><br><span class="line">    Execute() <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StartCommand 游戏开始运行</span></span><br><span class="line"><span class="keyword">type</span> StartCommand <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewStartCommand NewStartCommand</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStartCommand</span><span class="params">( /*正常情况下这里会有一些参数*/ )</span></span> *StartCommand &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;StartCommand&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute Execute</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *StartCommand)</span></span> Execute() <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;game start&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ArchiveCommand 游戏存档</span></span><br><span class="line"><span class="keyword">type</span> ArchiveCommand <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewArchiveCommand NewArchiveCommand</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewArchiveCommand</span><span class="params">( /*正常情况下这里会有一些参数*/ )</span></span> *ArchiveCommand &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;ArchiveCommand&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute Execute</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ArchiveCommand)</span></span> Execute() <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;game archive&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解释器模式-Interpreter"><a href="#解释器模式-Interpreter" class="headerlink" title="解释器模式 Interpreter"></a>解释器模式 Interpreter</h3><p>给定⼀种语言，定义它的文法表示，并定义⼀个解释器，该解释器用来根据文法表示来解释语言中的句子。</p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231416104.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231416104.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="解释器模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package interpreter 解释器模式</span></span><br><span class="line"><span class="comment">// 采用原课程的示例, 并且做了一下简化</span></span><br><span class="line"><span class="comment">// 假设我们现在有一个监控系统</span></span><br><span class="line"><span class="comment">// 现在需要实现一个告警模块，可以根据输入的告警规则来决定是否触发告警</span></span><br><span class="line"><span class="comment">// 告警规则支持 &amp;&amp;、&gt;、&lt; 3种运算符</span></span><br><span class="line"><span class="comment">// 其中 &gt;、&lt; 优先级比  &amp;&amp; 更高</span></span><br><span class="line"><span class="keyword">package</span> interpreter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;regexp&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// AlertRule 告警规则</span></span><br><span class="line"><span class="keyword">type</span> AlertRule <span class="keyword">struct</span> &#123;</span><br><span class="line">    expression IExpression</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewAlertRule NewAlertRule</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAlertRule</span><span class="params">(rule <span class="type">string</span>)</span></span> (*AlertRule, <span class="type">error</span>) &#123;</span><br><span class="line">    exp, err := NewAndExpression(rule)</span><br><span class="line">    <span class="keyword">return</span> &amp;AlertRule&#123;expression: exp&#125;, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Interpret 判断告警是否触发</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r AlertRule)</span></span> Interpret(stats <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r.expression.Interpret(stats)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IExpression 表达式接口</span></span><br><span class="line"><span class="keyword">type</span> IExpression <span class="keyword">interface</span> &#123;</span><br><span class="line">    Interpret(stats <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>) <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GreaterExpression &gt;</span></span><br><span class="line"><span class="keyword">type</span> GreaterExpression <span class="keyword">struct</span> &#123;</span><br><span class="line">    key   <span class="type">string</span></span><br><span class="line">    value <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Interpret Interpret</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g GreaterExpression)</span></span> Interpret(stats <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    v, ok := stats[g.key]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v &gt; g.value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewGreaterExpression NewGreaterExpression</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGreaterExpression</span><span class="params">(exp <span class="type">string</span>)</span></span> (*GreaterExpression, <span class="type">error</span>) &#123;</span><br><span class="line">    data := regexp.MustCompile(<span class="string">`\s+`</span>).Split(strings.TrimSpace(exp), <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) != <span class="number">3</span> || data[<span class="number">1</span>] != <span class="string">&quot;&gt;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;exp is invalid: %s&quot;</span>, exp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    val, err := strconv.ParseFloat(data[<span class="number">2</span>], <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;exp is invalid: %s&quot;</span>, exp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;GreaterExpression&#123;</span><br><span class="line">        key:   data[<span class="number">0</span>],</span><br><span class="line">        value: val,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LessExpression &lt;</span></span><br><span class="line"><span class="keyword">type</span> LessExpression <span class="keyword">struct</span> &#123;</span><br><span class="line">    key   <span class="type">string</span></span><br><span class="line">    value <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Interpret Interpret</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g LessExpression)</span></span> Interpret(stats <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    v, ok := stats[g.key]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v &lt; g.value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewLessExpression NewLessExpression</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLessExpression</span><span class="params">(exp <span class="type">string</span>)</span></span> (*LessExpression, <span class="type">error</span>) &#123;</span><br><span class="line">    data := regexp.MustCompile(<span class="string">`\s+`</span>).Split(strings.TrimSpace(exp), <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) != <span class="number">3</span> || data[<span class="number">1</span>] != <span class="string">&quot;&lt;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;exp is invalid: %s&quot;</span>, exp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    val, err := strconv.ParseFloat(data[<span class="number">2</span>], <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;exp is invalid: %s&quot;</span>, exp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;LessExpression&#123;</span><br><span class="line">        key:   data[<span class="number">0</span>],</span><br><span class="line">        value: val,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AndExpression &amp;&amp;</span></span><br><span class="line"><span class="keyword">type</span> AndExpression <span class="keyword">struct</span> &#123;</span><br><span class="line">    expressions []IExpression</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Interpret Interpret</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e AndExpression)</span></span> Interpret(stats <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, expression := <span class="keyword">range</span> e.expressions &#123;</span><br><span class="line">        <span class="keyword">if</span> !expression.Interpret(stats) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewAndExpression NewAndExpression</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAndExpression</span><span class="params">(exp <span class="type">string</span>)</span></span> (*AndExpression, <span class="type">error</span>) &#123;</span><br><span class="line">    exps := strings.Split(exp, <span class="string">&quot;&amp;&amp;&quot;</span>)</span><br><span class="line">    expressions := <span class="built_in">make</span>([]IExpression, <span class="built_in">len</span>(exps))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, e := <span class="keyword">range</span> exps &#123;</span><br><span class="line">        <span class="keyword">var</span> expression IExpression</span><br><span class="line">        <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> strings.Contains(e, <span class="string">&quot;&gt;&quot;</span>):</span><br><span class="line">            expression, err = NewGreaterExpression(e)</span><br><span class="line">        <span class="keyword">case</span> strings.Contains(e, <span class="string">&quot;&lt;&quot;</span>):</span><br><span class="line">            expression, err = NewLessExpression(e)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            err = fmt.Errorf(<span class="string">&quot;exp is invalid: %s&quot;</span>, exp)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        expressions[i] = expression</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;AndExpression&#123;expressions: expressions&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="中介模式-Mediator"><a href="#中介模式-Mediator" class="headerlink" title="中介模式 Mediator"></a>中介模式 Mediator</h3><p>用⼀个中介对象来封装⼀系列的对象交互。它使各对象不需要显式地相互调用，从而达到低耦合，还可以独立地改变对象间的交互。</p><p><strong>不直接引用</strong></p><p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231416106.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202202231416106.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="中介模式"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package mediator 中介模式</span></span><br><span class="line"><span class="comment">// 采用原课程的示例，并且做了一些裁剪</span></span><br><span class="line"><span class="comment">// 假设我们现在有一个较为复杂的对话框，里面包括，登录组件，注册组件，以及选择框</span></span><br><span class="line"><span class="comment">// 当选择框选择“登录”时，展示登录相关组件</span></span><br><span class="line"><span class="comment">// 当选择框选择“注册”时，展示注册相关组件</span></span><br><span class="line"><span class="keyword">package</span> mediator</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input 假设这表示一个输入框</span></span><br><span class="line"><span class="keyword">type</span> Input <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// String String</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i Input)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Selection 假设这表示一个选择框</span></span><br><span class="line"><span class="keyword">type</span> Selection <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Selected 当前选中的对象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Selection)</span></span> Selected() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Button 假设这表示一个按钮</span></span><br><span class="line"><span class="keyword">type</span> Button <span class="keyword">struct</span> &#123;</span><br><span class="line">    onClick <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetOnClick 添加点击事件回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Button)</span></span> SetOnClick(f <span class="function"><span class="keyword">func</span><span class="params">()</span></span>) &#123;</span><br><span class="line">    b.onClick = f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IMediator 中介模式接口</span></span><br><span class="line"><span class="keyword">type</span> IMediator <span class="keyword">interface</span> &#123;</span><br><span class="line">    HandleEvent(component <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dialog 对话框组件</span></span><br><span class="line"><span class="keyword">type</span> Dialog <span class="keyword">struct</span> &#123;</span><br><span class="line">    LoginButton         *Button</span><br><span class="line">    RegButton           *Button</span><br><span class="line">    Selection           *Selection</span><br><span class="line">    UsernameInput       *Input</span><br><span class="line">    PasswordInput       *Input</span><br><span class="line">    RepeatPasswordInput *Input</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HandleEvent HandleEvent</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dialog)</span></span> HandleEvent(component <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> reflect.DeepEqual(component, d.Selection):</span><br><span class="line">        <span class="keyword">if</span> d.Selection.Selected() == <span class="string">&quot;登录&quot;</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;select login&quot;</span>)</span><br><span class="line">            fmt.Printf(<span class="string">&quot;show: %s\n&quot;</span>, d.UsernameInput)</span><br><span class="line">            fmt.Printf(<span class="string">&quot;show: %s\n&quot;</span>, d.PasswordInput)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> d.Selection.Selected() == <span class="string">&quot;注册&quot;</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;select register&quot;</span>)</span><br><span class="line">            fmt.Printf(<span class="string">&quot;show: %s\n&quot;</span>, d.UsernameInput)</span><br><span class="line">            fmt.Printf(<span class="string">&quot;show: %s\n&quot;</span>, d.PasswordInput)</span><br><span class="line">            fmt.Printf(<span class="string">&quot;show: %s\n&quot;</span>, d.RepeatPasswordInput)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// others, 如果点击了登录按钮，注册按钮</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Go 语言的设计模式之美。&lt;/p&gt;</summary>
    
    
    
    <category term="System Design" scheme="http://blog.sukiu.top/categories/System-Design/"/>
    
    <category term="Design Pattern" scheme="http://blog.sukiu.top/categories/System-Design/Design-Pattern/"/>
    
    
    <category term="Go" scheme="http://blog.sukiu.top/tags/Go/"/>
    
    <category term="Patterns" scheme="http://blog.sukiu.top/tags/Patterns/"/>
    
  </entry>
  
  <entry>
    <title>模拟题</title>
    <link href="http://blog.sukiu.top/Computer-Basics/Algorithm/Simulation/"/>
    <id>http://blog.sukiu.top/Computer-Basics/Algorithm/Simulation/</id>
    <published>2022-02-18T02:33:00.000Z</published>
    <updated>2022-02-18T02:33:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>一些经典模拟题</p><span id="more"></span><h2 id="计算器"><a href="#计算器" class="headerlink" title="计算器"></a>计算器</h2><p>对于「任何表达式」而言，都使用两个栈 <code>nums</code> 和 <code>ops</code>：</p><ul><li><code>nums</code> ： 存放所有的数字</li><li><code>ops</code> ：存放所有的数字以外的操作</li></ul><p>从前往后遍历字符，分情况讨论：</p><ul><li>空格 : 跳过（开始去除所有空格）</li><li><code>(</code> : 直接加入 <code>ops</code> 中，等待与之匹配的 <code>)</code></li><li><code>)</code> : 使用现有的 <code>nums</code> 和 <code>ops</code> 进行计算，直到遇到左边最近的一个左括号为止，计算结果放到 <code>nums</code></li><li>数字 : 从当前位置开始继续往后取，将整一个连续数字整体取出，加入 <code>nums</code></li><li><code>+ - * / ^ %</code> : 需要将操作放入 <code>ops</code> 中。<strong>在放入之前先把栈内可以算的都算掉（只有「栈内运算符」比「当前运算符」优先级高&#x2F;同等，才进行运算）</strong>，使用现有的 <code>nums</code> 和 <code>ops</code> 进行计算，直到没有操作或者遇到左括号，计算结果放到 <code>nums</code></li></ul><p><strong>只有「栈内运算符」比「当前运算符」优先级高&#x2F;同等，才进行运算</strong> 是什么意思：<br>从前往后做，假设我们当前已经扫描到 <code>2 + 1</code> 了（此时栈内的操作为 <code>+</code> ）。</p><ol><li>如果后面出现的 <code>+ 2</code> 或者 <code>- 1</code> 的话，满足「栈内运算符」比「当前运算符」优先级高&#x2F;同等，可以将 <code>2 + 1</code> 算掉，把结果放到 <code>nums</code> 中；</li><li>如果后面出现的是 <code>* 2</code> 或者 <code>/ 1</code> 的话，不满足「栈内运算符」比「当前运算符」优先级高&#x2F;同等，这时候不能计算 <code>2 + 1</code>。</li></ol><blockquote><ul><li>由于第一个数可能是负数，为了减少边界判断。一个小技巧是先往 <code>nums</code> 添加一个 0</li><li>从理论上分析，<code>nums</code> 最好存放的是 <code>long</code>，而不是 <code>int</code>，可能存在 中间结果溢出</li></ul></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">    unordered_map&lt;<span class="type">char</span>, <span class="type">int</span>&gt; opMap = &#123;&#123;<span class="string">&#x27;+&#x27;</span>, <span class="number">1</span>&#125;, &#123;<span class="string">&#x27;-&#x27;</span>, <span class="number">1</span>&#125;, &#123;<span class="string">&#x27;*&#x27;</span>, <span class="number">2</span>&#125;,</span><br><span class="line">                                      &#123;<span class="string">&#x27;/&#x27;</span>, <span class="number">2</span>&#125;, &#123;<span class="string">&#x27;%&#x27;</span>, <span class="number">2</span>&#125;, &#123;<span class="string">&#x27;^&#x27;</span>, <span class="number">3</span>&#125;&#125;;</span><br><span class="line">    stack&lt;ll&gt; nums;</span><br><span class="line">    stack&lt;<span class="type">char</span>&gt; ops;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">calc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums.<span class="built_in">size</span>() &lt; <span class="number">2</span> || ops.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line">        ll b = nums.<span class="built_in">top</span>();</span><br><span class="line">        nums.<span class="built_in">pop</span>();</span><br><span class="line">        ll a = nums.<span class="built_in">top</span>();</span><br><span class="line">        nums.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="type">char</span> op = ops.<span class="built_in">top</span>();</span><br><span class="line">        ops.<span class="built_in">pop</span>();</span><br><span class="line">        ll ans;</span><br><span class="line">        <span class="keyword">switch</span> (op) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">                ans = a + b;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                ans = a - b;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">                ans = a * b;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">                ans = a / b;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">                ans = a % b;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;^&#x27;</span>:</span><br><span class="line">                ans = <span class="built_in">pow</span>(a, b);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nums.<span class="built_in">push</span>(ans);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">calculate</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 去除所有空格</span></span><br><span class="line">        s.<span class="built_in">erase</span>(<span class="built_in">remove</span>(s.<span class="built_in">begin</span>(), s.<span class="built_in">end</span>(), <span class="string">&#x27; &#x27;</span>), s.<span class="built_in">end</span>());</span><br><span class="line">        nums.<span class="built_in">push</span>(<span class="number">0</span>);  <span class="comment">// 防止第一个数是负数</span></span><br><span class="line">        <span class="type">int</span> n = s.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="type">char</span> c = s[i];</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">                ops.<span class="built_in">push</span>(c);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;)&#x27;</span>) &#123;  <span class="comment">// 计算到最近的左括号</span></span><br><span class="line">                <span class="keyword">while</span> (!ops.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ops.<span class="built_in">top</span>() == <span class="string">&#x27;(&#x27;</span>) &#123;</span><br><span class="line">                        ops.<span class="built_in">pop</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">calc</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (c &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> num = <span class="number">0</span>, j;</span><br><span class="line">                    <span class="keyword">for</span> (j = i; j &lt; n &amp;&amp; s[j] &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; s[j] &lt;= <span class="string">&#x27;9&#x27;</span>; j++)</span><br><span class="line">                        num = num * <span class="number">10</span> + (s[j] - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">                    nums.<span class="built_in">push</span>(num);</span><br><span class="line">                    i = j - <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        (s[i - <span class="number">1</span>] == <span class="string">&#x27;(&#x27;</span> || s[i - <span class="number">1</span>] == <span class="string">&#x27;+&#x27;</span> || s[i - <span class="number">1</span>] == <span class="string">&#x27;-&#x27;</span>))</span><br><span class="line">                        nums.<span class="built_in">push</span>(<span class="number">0</span>);</span><br><span class="line">                    <span class="comment">// 新操作入栈，先计算栈内</span></span><br><span class="line">                    <span class="comment">// 只有满足栈内运算符高于或等于当前运算符才计算</span></span><br><span class="line">                    <span class="keyword">while</span> (!ops.<span class="built_in">empty</span>() &amp;&amp; ops.<span class="built_in">top</span>() != <span class="string">&#x27;(&#x27;</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (opMap[ops.<span class="built_in">top</span>()] &lt; opMap[c]) <span class="keyword">break</span>;</span><br><span class="line">                        <span class="built_in">calc</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    ops.<span class="built_in">push</span>(c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!ops.<span class="built_in">empty</span>()) <span class="built_in">calc</span>();</span><br><span class="line">        <span class="keyword">return</span> nums.<span class="built_in">top</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="大数运算"><a href="#大数运算" class="headerlink" title="大数运算"></a>大数运算</h2><h3 id="大数相加"><a href="#大数相加" class="headerlink" title="大数相加"></a>大数相加</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">sum</span><span class="params">(string a,string b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a.<span class="built_in">size</span>()&lt;b.<span class="built_in">size</span>()) </span><br><span class="line">        <span class="built_in">swap</span>(a,b);</span><br><span class="line">    <span class="type">int</span> i,j;</span><br><span class="line">    <span class="keyword">for</span> (i=a.<span class="built_in">size</span>()<span class="number">-1</span>,j=b.<span class="built_in">size</span>()<span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--,j--) &#123;</span><br><span class="line">        a[i]=(<span class="type">char</span>)(a[i]+(j&gt;=<span class="number">0</span>?b[j]-<span class="string">&#x27;0&#x27;</span>:<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">if</span> (a[i]-<span class="string">&#x27;0&#x27;</span>&gt;=<span class="number">10</span>) &#123;</span><br><span class="line">            a[i]=(<span class="type">char</span>)((a[i]-<span class="string">&#x27;0&#x27;</span>)%<span class="number">10</span>+<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>(i) a[i<span class="number">-1</span>]++;</span><br><span class="line">            <span class="keyword">else</span> a=<span class="string">&#x27;1&#x27;</span>+a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="大数相减"><a href="#大数相减" class="headerlink" title="大数相减"></a>大数相减</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">differ</span><span class="params">(string a,string b)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> flag=<span class="number">0</span>; <span class="comment">//标记符号</span></span><br><span class="line">    <span class="keyword">if</span> (a.<span class="built_in">size</span>()&lt;b.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        <span class="built_in">swap</span>(a,b);</span><br><span class="line">        flag=<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.<span class="built_in">size</span>()==b.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a&lt;b) &#123;</span><br><span class="line">            <span class="built_in">swap</span>(a,b);</span><br><span class="line">            flag=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=a.<span class="built_in">size</span>()<span class="number">-1</span>,j=b.<span class="built_in">size</span>()<span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--,j--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j&gt;=<span class="number">0</span>) b[i]=b[j];</span><br><span class="line">        <span class="keyword">else</span> b[i]=<span class="string">&#x27;0&#x27;</span>; <span class="comment">//给减数不足的位数补0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=a.<span class="built_in">size</span>()<span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--) &#123;<span class="comment">//模拟减法操作</span></span><br><span class="line">        <span class="keyword">if</span> (a[i]&gt;=b[i])</span><br><span class="line">            a[i]=a[i]-b[i]+<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            a[i]=a[i]-b[i]+<span class="number">10</span>+<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            a[i<span class="number">-1</span>]--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (a[<span class="number">0</span>]==<span class="string">&#x27;0&#x27;</span> &amp;&amp; a.<span class="built_in">size</span>()!=<span class="number">1</span>) &#123;<span class="comment">//去掉开头的0，如果全为0留一个</span></span><br><span class="line">        a.<span class="built_in">erase</span>(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (flag) a=<span class="string">&#x27;-&#x27;</span>+a;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="大数相乘"><a href="#大数相乘" class="headerlink" title="大数相乘"></a>大数相乘</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">product</span><span class="params">(string a, string b)</span> </span>&#123;</span><br><span class="line">    string ans=<span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (a.<span class="built_in">size</span>()&lt;b.<span class="built_in">size</span>())</span><br><span class="line">        <span class="built_in">swap</span>(a,b);</span><br><span class="line">    <span class="type">int</span> cnt=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=b.<span class="built_in">size</span>()<span class="number">-1</span>,j=a.<span class="built_in">size</span>()<span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--)&#123;</span><br><span class="line">        <span class="type">int</span> t=j;</span><br><span class="line">        string tmp;</span><br><span class="line">        <span class="type">int</span> next=<span class="number">0</span>;<span class="comment">//表示进位</span></span><br><span class="line">        <span class="keyword">while</span> (t&gt;=<span class="number">0</span>)&#123;<span class="comment">//循环得出中间的数</span></span><br><span class="line">            <span class="type">int</span> mid=(b[i]-<span class="string">&#x27;0&#x27;</span>)*(a[t]-<span class="string">&#x27;0&#x27;</span>)+next;<span class="comment">//存储中间的乘积</span></span><br><span class="line">            tmp=(<span class="type">char</span>)(mid%<span class="number">10</span>+<span class="string">&#x27;0&#x27;</span>)+tmp;</span><br><span class="line">            <span class="keyword">if</span> (mid&gt;=<span class="number">10</span>)<span class="comment">//乘积大于10则进位</span></span><br><span class="line">                next=mid/<span class="number">10</span>;</span><br><span class="line">            <span class="keyword">else</span> next=<span class="number">0</span>;</span><br><span class="line">            t--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next!=<span class="number">0</span>) tmp=(<span class="type">char</span>)(next+<span class="string">&#x27;0&#x27;</span>)+tmp;<span class="comment">//如果循环结束进位不为0，则在前面补</span></span><br><span class="line">        cnt++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k=<span class="number">0</span>; k&lt;cnt; k++)<span class="comment">//错位相加时补0</span></span><br><span class="line">            tmp=tmp+<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        ans=<span class="built_in">sum</span>(ans,tmp);</span><br><span class="line">        tmp.<span class="built_in">clear</span>();<span class="comment">//将存储清空</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (ans[<span class="number">0</span>]==<span class="string">&#x27;0&#x27;</span> &amp;&amp; ans.<span class="built_in">size</span>()!=<span class="number">1</span>)<span class="comment">//去掉前面多余的0</span></span><br><span class="line">        ans.<span class="built_in">erase</span>(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;一些经典模拟题&lt;/p&gt;</summary>
    
    
    
    <category term="Computer Basics" scheme="http://blog.sukiu.top/categories/Computer-Basics/"/>
    
    <category term="Algorithm" scheme="http://blog.sukiu.top/categories/Computer-Basics/Algorithm/"/>
    
    
    <category term="Simulation" scheme="http://blog.sukiu.top/tags/Simulation/"/>
    
  </entry>
  
  <entry>
    <title>文件管理</title>
    <link href="http://blog.sukiu.top/Computer-Basics/Operating-System/File-Management/"/>
    <id>http://blog.sukiu.top/Computer-Basics/Operating-System/File-Management/</id>
    <published>2022-01-21T06:40:00.000Z</published>
    <updated>2022-01-21T06:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>文件系统是操作系统中负责管理持久数据的子系统，即负责把用户的文件存到磁盘硬件中。</p><p>因为即使计算机断电了，磁盘里的数据并不会丢失，所以可以持久化的保存文件。</p><p>文件是对长期存储介质的抽象。</p><span id="more"></span><h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><p>文件是⼀种抽象机制，它提供了⼀种在磁上保存信息而且方便以后读取的方法。<br>这种方法可以使用户不必了解存储信息的方法、位置和实际磁盘⼯作方式等有关细节。</p><blockquote><p>win95、win98 用的都是 MS-DOS 的文件系统，即 FAT-16， win98 扩展了 FAT-16 成为 FAT-32。<br>较新版的操作系统 NTFS，win8 配备 ReFS。微软优化 FAT,叫作 exFAT。<br>prog.c，圆点后面的部分称为文件扩展名。</p></blockquote><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><ul><li>字节结构：把文件看成字节序列为操作系统提供了最大的灵活度</li><li>记录序列：文件结构上的第⼀步改进，这种模型中，文件是具有固定长度记录的序列</li><li>树：文件在这种结构中由⼀棵记录树构成，每个记录不必具有相同的长度，记录的固定位置上有⼀个键字段。这棵树按“键”字段进行排序，从而可以对特定“键”进行快速查找。</li></ul><h3 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h3><ol><li>普通文件</li><li>目录</li><li>字符特殊文件（UNIX）</li><li>块特殊文件（UNIX）</li></ol><h3 id="文件属性"><a href="#文件属性" class="headerlink" title="文件属性"></a>文件属性</h3><p>除了文件名和数据外，文件还具有<strong>属性</strong>来对文件本身做更具体的描述，这类信息也称为<strong>元数据</strong>。<br>这些属性会存于文件结构中的某些区域中，具体要视该文件的类型而定。</p><p><strong>举例</strong>：</p><ul><li>创建时间、修改时间、存取时间、文件大小、当前大小、所有者等</li><li>保护：对文件的访问限制，谁可以访问文件</li><li>口令：访问文件需要的密码</li><li>只读标志、隐藏标志、系统标志（普通文件或系统文件）、加锁标志、存档标志</li><li>最大长度：文件可能增长到的字节数</li></ul><h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p>使用文件的目的是<strong>存储信息并方便以后检索</strong>。对于存储和检索，不同系统提供了不同的操作。</p><p>文件系统大多都会提供如下的<strong>文件操作</strong>：</p><ul><li>create()：创建不包含任何数据的文件。</li><li>delte()：删除该文件以释放磁盘空间。</li><li>open()：在使用文件之前，先打开文件，目的是把文件属性和磁盘地址表装入内存，以便后续调用的快速访问。</li><li>close()：文件访问结束之后，关闭文件并释放内部空间表空间。</li><li>write()：向文件写数据，如果当前位置是文件尾，那么数据长度会增加；如果当前位置是其中某个位置，那么写入位置的数据将会被覆盖。</li><li>append()：相当于 write() 在尾部添加数据。</li><li>seek()：随机访问文件，需要指定相对于文件数据开始的位置。</li><li>getAttribute()：读取文件的属性。</li><li>setAttribute()：设置文件的属性。</li><li>rename()：重命名文件。</li></ul><p>一般来说，打开文件将会获得一个<strong>文件描述符</strong>(一个小整数)，通过文件描述符，就可以操作文件。</p><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>文件系统通常提供目录或文件夹用于记录文件的位置，在很多操作系统中目录本身也是文件</p><p>现在的文件目录结构，大多采用文件树结构。<br>这里的路径，用<strong>路径名</strong>表示，分为<strong>绝对路径名</strong>和<strong>相对路径名</strong>，路径每往下一层，使用分隔符进行分隔。</p><p>分隔符视系统而定，如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; Windows：\usr\ast\maibox</span><br><span class="line">&gt; Linux: /usr/ast/mailbox</span><br><span class="line">&gt; MULTICS: &gt;usr&gt;ast&gt;mailbox</span><br></pre></td></tr></table></figure><h3 id="目录操作"><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h3><p>对于目录，也提供了相应的操作：</p><ul><li>create(): 创建目录</li><li>delete(): 删除目录</li><li>opendir(): 打开目录</li><li>closedir(): 关闭目录，释放内部表空间</li><li>readdir(): 返回一个目录项，在内存中，以目录项来表达一个目录</li><li>rename(): 重命名</li><li>link(): 链接一个文件，之后能使同一个文件，能通过多个文件路径访问到 (后续会提到)</li><li>unlink(): 解除文件的链接</li></ul><h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>以上内容是以用户（即使用者）的角度看待文件。<br>那么，从文件系统实现者的角度来看，文件系统应该如何实现？</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202201232026680.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202201232026680.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><p>文件系统存放在磁盘上，磁盘被划分为一个或者多个分区，每个分区中有一个独立的文件系统。<br>磁盘的 0 号扇区称为<strong>主引导记录（Master Boot Record, MBR）</strong>，用来引导计算机。<br>紧接着，是分区表，用来标记每个分区的起始和结束位置，表中的一个分区被标记为活动分区。</p><img src="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202201232028987.png" class="lazyload" data-srcset="https://picgo-1303870432.cos.ap-shanghai.myqcloud.com/img/202201232028987.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:50%;" /><blockquote><p>当计算机被引导时，BIOS 读入并执行 MBR。<br>MBR 会确定活动分区，读入并执行它的<strong>引导块（boot block）</strong>。引导块中的程序将装载该分区中的系统。<br><strong>超级块</strong>（superblock）包含文件系统的所有关键参数，会被读入内存，其中的信用可用来确定文件系统的魔数、文件系统中的块的数量和其他重要的管理信息。</p><p>空闲块的信息可以用位图或者指针的形式指出，随后跟随的是一组 i 节点（一种数据结构，用来说明文件的方方面面）。最后，存放了所有其他的文件和目录。</p></blockquote><h3 id="文件的实现"><a href="#文件的实现" class="headerlink" title="文件的实现"></a>文件的实现</h3><h4 id="连续分配"><a href="#连续分配" class="headerlink" title="连续分配"></a>连续分配</h4><p>最简单的分配是把每个文件作为⼀连串连续数据块存储在磁盘</p><p><strong>优点：</strong></p><ul><li>实现简单，只需记住开始位置，文件的块数。</li><li>读操作性能好，单个操作就能从磁盘中读出整个文件。只需要一次寻找，之后不再有寻道和旋转延迟。</li></ul><p><strong>缺点：</strong></p><ul><li>尾部会浪费一些空间，以块为存储单位时，无论是否完全使用完块大小，都会占用整个块</li><li>需要知道文件的最终大小，然后，在维护的连续空闲表找到合适的位置存入文件，并且知道文件的最终大小这一问题不可回避。</li><li>随时间迁移，将会产生大量碎片块，使磁盘变得零碎，当一个较大的新文件要加入时，将找不到合适的连续位置，此时要压缩磁盘空间（把文件复制到新位置，以得到更多的连续空间），代价极高。</li></ul><blockquote><p>新建文件时要知道文件的最终大小，使得这一存储方式难以应用于实际场景，但是在一些情形下是可行的。</p><p>如在 CD-ROM、DVD、BD（蓝光光盘）上，在它们的场景里，所有的文件的大小是事先知道的，并且在后续的使用中，这些文件的大小也不会改变。</p></blockquote><h4 id="链表分配"><a href="#链表分配" class="headerlink" title="链表分配"></a>链表分配</h4><p>可以为每个文件构造磁盘块链表，每一块的第一个字指向下块，块的其他部分存放数据。</p><p><strong>优点：</strong></p><ul><li>不会因为磁盘碎片浪费存储空间，充分利用磁盘块。</li><li>只需要第一块的磁盘地址，就能找到其他的块。</li></ul><p><strong>缺点：</strong></p><ul><li>随机方法访问很慢，访问块 n 总是要先访问其面的 n-1 块。</li><li>指向下一块的指针占据了一些字节，每个磁盘块存储的字节数不再是 2 的整次幂，因大多数程序以长度为 2 的整次幂来读写磁盘块，降低了实际系统的运行效率。</li><li>要读出一个完成的文件块时，要从两个磁盘块中获得和拼接信息，带来额外的开销</li></ul><h4 id="内存中的表进行链表分配"><a href="#内存中的表进行链表分配" class="headerlink" title="内存中的表进行链表分配"></a>内存中的表进行链表分配</h4><p>弥补链表分配的不足，可以在内存中建立磁盘块的指针表。</p><p>表项中，使用一个特殊的标记（如 -1）表示结束。这样，沿着表就可以文件的所有块。</p><p>这样的表也称为 <strong>FAT（File Allocation Table）</strong> 。</p><p><strong>优点：</strong></p><ul><li>整个块都可以存放数据。</li><li>随机访问也简单得多，虽然仍要顺着链表寻找偏移量（但减少了可能的寻到和旋转延迟）</li><li>不需要磁盘引用</li></ul><p><strong>缺点：</strong></p><ul><li>必须把整个表都放在内存中。假设 1TB 的磁盘和 1KB 的块大小，则表需要 10 亿项，每一项至少要 3 个字节，则表大小要占用 2.4GB 内存。因此 FAT 的应用场景有限，不太实用。</li></ul><h4 id="I-节点"><a href="#I-节点" class="headerlink" title="I 节点"></a>I 节点</h4><p>最普遍的方式，是为每个文件创建一个中数据结构以表示此文件的关键描述，这种数据结构也称为<strong>i 节点（index-node）</strong>。</p><p>一个可能的 inode 结构，记录了文件属性，以及每个文件块对应的磁盘块地址，并能指向其他的 inode 来记录更多的存储数据。</p><p>这样的机制有很大的优势：</p><ul><li>给定 inode，就能找到所有的文件块。</li><li>只有在文件打开时，inode 才会存在于内存中，如果每个 i 节点有 n 字节，那么 k 个文件同时打开，inode 总共占据 kn 字节，只需提前保留这么多的空间即可。也就是说，内存中 inode 占据的大小和文件大小无关，只和同时使用的文件数有关。</li><li>如果一个 inode 不够存储一个文件占用的所有磁盘块，可以通过最后一个地址之前其他 inode 得以解决。甚至可以指向其他存放地址的磁盘的磁盘块。</li></ul><h3 id="目录的实现"><a href="#目录的实现" class="headerlink" title="目录的实现"></a>目录的实现</h3><p>在读文件之前，必须先打开文件。打开文件时，操作系统利用用户给出的路径名找到相应的目录项。</p><ul><li>简单目录：包含固定大⼩的目录，在目录项中有磁盘地址和属性</li><li>采用 i 节点的系统：把文件属性存放在 i 节点中而不是目录项中。这种情形下，目录项会更短。</li></ul><h3 id="共享文件"><a href="#共享文件" class="headerlink" title="共享文件"></a>共享文件</h3><p>共享文件与目录的联系称为⼀个链接（link）。<br>这样文件系统本身就是⼀个有向⽆环图（DAG），而不是⼀棵树。</p><ul><li>硬链接：指向目标数据对象的链接，<strong>可以看作是一个既有文件的别名</strong></li></ul><blockquote><p>当目标被删除时，硬链接继续存在，且可以正常打开、编辑。因为他具备一个完整的文件结构。</p><p>当硬链接被删除时，目标文件继续存在，不受影响。</p><p>只有当一个文件 ID 对应的所有硬链接被删除时，数据才真正被标记为删除。</p></blockquote><ul><li>符号链接：指向目标路径的链接，会跳转到符号链接所指向的目标中去，而不改变此时的文件路径</li></ul><blockquote><p>当目标被删除时，符号链接继续存在，但会成为死链，无法打开。</p><p>当符号链接被删除时，它指向的目标不受影响。</p></blockquote><h3 id="虚拟文件系统"><a href="#虚拟文件系统" class="headerlink" title="虚拟文件系统"></a>虚拟文件系统</h3><p>将多个文件系统整合到⼀个统⼀的结构中。</p><blockquote><p>⼀个 Linux 系统可以用 <code>ext2</code> 作为根文件系统，<code>ext3</code> 分区装载在 <code>/usr</code> 下，另⼀块采用 ReiserFS 文件系统的硬盘装载在 <code>/home</code> 下，以及⼀个 ISO 9660 的 CD-ROM 临时装载在 <code>/mnt</code> 下。</p></blockquote><p>从用户的观点来看，只有⼀个文件系统层级。但它们事实上是多种文件系统，对于用户和进程是不可见的。</p><p>绝大多数 Unix 操作系统都在使用虚拟文件系统（VirtualFile System, VFS）</p><h3 id="文件系统面对的问题"><a href="#文件系统面对的问题" class="headerlink" title="文件系统面对的问题"></a>文件系统面对的问题</h3><h4 id="磁盘空间管理"><a href="#磁盘空间管理" class="headerlink" title="磁盘空间管理"></a>磁盘空间管理</h4><p>几乎所有的文件系统将文件分割成固定大小的块来存储，各块之间不一定相邻。</p><h5 id="块大小"><a href="#块大小" class="headerlink" title="块大小"></a>块大小</h5><p>块大小将直接影响此消彼长的两个指标<strong>空间利用率</strong>和<strong>磁盘数据率</strong>。</p><blockquote><p>从历史的观点上来说，文件系统将大⼩设在 1~4KB 之间。</p><p>但现在随着磁盘超过了 1TB，还是将块的大⼩提升到 64KB 并且接受浪费的磁盘孔空间，这样也许更好。磁盘空间⼏乎不再会短缺。</p></blockquote><h5 id="空闲块记录"><a href="#空闲块记录" class="headerlink" title="空闲块记录"></a>空闲块记录</h5><p>确定了块大小，需要考虑空闲块如何记录。</p><ul><li>链表记录：链表的每个块中包含尽可能多的空闲磁盘块号。（通常情况下，采用空闲块存放空闲表，这样不会影响存储器）</li><li>位图记录：在位图中，空闲块用 1 表示，已分配块用 0 表示。</li></ul><h5 id="文件备份"><a href="#文件备份" class="headerlink" title="文件备份"></a>文件备份</h5><p>做磁盘备份主要是处理好两个潜在问题中的⼀个：</p><ol><li>从意外的灾难中恢复</li><li>从错误的操作中恢复</li></ol><p>将文件从磁盘转储到磁带，有两种方法，<strong>物理转储</strong>和<strong>逻辑转储</strong>。</p><h4 id="文件系统的一致性"><a href="#文件系统的一致性" class="headerlink" title="文件系统的一致性"></a>文件系统的一致性</h4><p>文件进行修改后，需将所有的修改都写回磁盘，如果在所有的磁盘块都写回磁盘前，系统崩溃，一些被修改的信息可能未被写回磁盘，那么文件系统将不一致。</p><p>因此，文件系统一般都有独立的程序可检查其一致性。</p><p>致性检查分为两种<strong>块的一致性检查</strong>和<strong>文件的一致性检查</strong></p><h4 id="文件系统的性能"><a href="#文件系统的性能" class="headerlink" title="文件系统的性能"></a>文件系统的性能</h4><p>磁盘访问的速度比内存访问的速度慢得多，如果每次读文件时，都从磁盘块中读取，那么 IO 时间将是大大拖累程序效率。</p><p>主要通过以下方法提高性能：</p><ul><li>高速缓存：减少磁盘访问次数技术是块高速缓存（block cache）或者缓冲区高速缓存（buffer cache）</li><li>块预读：在需要用到块之前，试图提前将其写入高速缓存，从而提高命中率。</li><li>减少磁盘臂运动：把可能顺序访问的块放⼀起，当然最好是同⼀柱面上，从而减少磁盘臂的移动次数。</li><li>磁盘碎片整理：移动文件使它们相邻，并把所有的空闲空间放在⼀个或多个大的连续区域内。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;文件系统是操作系统中负责管理持久数据的子系统，即负责把用户的文件存到磁盘硬件中。&lt;/p&gt;
&lt;p&gt;因为即使计算机断电了，磁盘里的数据并不会丢失，所以可以持久化的保存文件。&lt;/p&gt;
&lt;p&gt;文件是对长期存储介质的抽象。&lt;/p&gt;</summary>
    
    
    
    <category term="Computer Basics" scheme="http://blog.sukiu.top/categories/Computer-Basics/"/>
    
    <category term="Operating System" scheme="http://blog.sukiu.top/categories/Computer-Basics/Operating-System/"/>
    
    
    <category term="File" scheme="http://blog.sukiu.top/tags/File/"/>
    
  </entry>
  
</feed>
